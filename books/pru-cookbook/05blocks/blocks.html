
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Building Blocks - Applications &#8212; BeagleBoard Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css?v=5c84f910" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=99f84846" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script src="../../../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
    <script src="../../../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    <script src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js?v=ffc8af2d"></script>
    <script src="../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js?v=12818e64"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'books/pru-cookbook/05blocks/blocks';</script>
    <link rel="canonical" href="docs.beagleboard.io/books/pru-cookbook/05blocks/blocks.html" />
    <link rel="icon" href="../../../_static/boris.svg"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Accessing More I/O" href="../06io/io.html" />
    <link rel="prev" title="Debugging and Benchmarking" href="../04debug/debug.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
    <meta name="docbuild:last-update" content="Jun 29, 2025"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  

    <!-- Top version and announcement message -->
    <script>
        
    // Function to generate version and announcement banner HTML
    function getBannerHTML() {
        return `
            
            <aside id="bd-header-version-warning" class="d-print-none" aria-label="Version warning">
                <div class="bd-header-announcement__content ms-auto me-auto">
                    <div class="sidebar-message">
                        
                        
                        This is an <strong>unknown version</strong> of docs.
                        
                        <a class="btn text-wrap font-weight-bold ms-3 my-1 align-baseline pst-button-link-to-stable-version" href="https://docs.beagleboard.org">
                            Switch to released version
                        </a>
                    </div>
                </div>
            </aside>
            
            
        `;
    }
    
    // Get the target element where the banners will be added
    const bannerDiv = document.getElementsByClassName('pst-async-banner-revealer')[0];

    // Add version banner and announcement banner if bannerDiv is valid
    if (bannerDiv) {
        bannerDiv.innerHTML = getBannerHTML();
    }
    
    </script>

    
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/logo.svg" class="logo__image only-light" alt="BeagleBoard Documentation - Home"/>
    <img src="../../../_static/logo.svg" class="logo__image only-dark pst-js-only" alt="BeagleBoard Documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="ms-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../intro/index.html">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../boards/index.html">
    Boards
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../projects/index.html">
    Projects
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../index.html">
    Books
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../accessories/index.html">
    Accessories
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://www.beagleboard.org/about">
    About
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://www.beagleboard.org/donate">
    Donate
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://gsoc.beagleboard.org/">
    GSoC
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://forum.beagleboard.org/c/faq">
    FAQ
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://openbeagle.org/" title="OpenBeagle" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-gitlab fa-lg" aria-hidden="true"></i>
            <span class="sr-only">OpenBeagle</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://docs.beagleboard.org/" title="Docs" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-book fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Docs</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://bbb.io/discord" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://forum.beagleboard.org/" title="Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Forum</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://www.beagleboard.org" title="BeagleBoard.org" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../_static/images/boris.svg" class="icon-link-image" alt="BeagleBoard.org"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  



  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../intro/index.html">
    Introduction
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../boards/index.html">
    Boards
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../projects/index.html">
    Projects
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../index.html">
    Books
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../accessories/index.html">
    Accessories
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://www.beagleboard.org/about">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://www.beagleboard.org/donate">
    Donate
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://gsoc.beagleboard.org/">
    GSoC
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://forum.beagleboard.org/c/faq">
    FAQ
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://openbeagle.org/" title="OpenBeagle" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-gitlab fa-lg" aria-hidden="true"></i>
            <span class="sr-only">OpenBeagle</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://docs.beagleboard.org/" title="Docs" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-book fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Docs</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://bbb.io/discord" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://forum.beagleboard.org/" title="Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Forum</span></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://www.beagleboard.org" title="BeagleBoard.org" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../_static/images/boris.svg" class="icon-link-image" alt="BeagleBoard.org"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../beaglebone-cookbook/index.html">BeagleBone Cookbook</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/01basics/basics.html">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/02sensors/sensors.html">Sensors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/03displays/displays.html">Displays and Other Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/04motors/motors.html">Motors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/05tips/tips.html">Beyond the Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/06iot/iot.html">Internet of Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/07kernel/kernel.html">The Kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/08realtime/realtime.html">Real-Time I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/09capes/capes.html">Capes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/10parts/parts.html">Parts and Suppliers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../beaglebone-cookbook/11misc/misc.html">Misc</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../index.html">PRU Cookbook</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01case/case.html">Case Studies - Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02start/start.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03details/details.html">Running a Program; Configuring Pins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04debug/debug.html">Debugging and Benchmarking</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Building Blocks - Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06io/io.html">Accessing More I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07more/more.html">More Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08ai/ai.html">Moving to the BeagleBone AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../projects.html">PRU Projects</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item"><div class="card mb-3">
    <div class="card-header bg-primary text-light fw-bold">
        Why are we doing this?
    </div>
    <div class="card-body">
        <p class="card-text text-dark">
            We believe in making computers open again to democratize technology and empower individuals and organizations to explore, experiment, and create without the constraints of proprietary systems.
        </p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-warning text-dark fw-bold">
        What are we doing?
    </div>
    <div class="card-body">
        <p class="card-text text-dark">
            We design versatile and affordable single-board computers to provide developers, hobbyists, and educators with a platform for prototyping, experimentation, and production of embedded systems. Our comprehensive documentation, tutorials, and vibrant online community support users in their projects and foster knowledge sharing.
        </p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-success text-light fw-bold">
        How are we doing it?
    </div>
    <div class="card-body">
        <p class="card-text text-dark">
            Through open-source hardware designs, diverse software support, and active community engagement, we enable users to customize, innovate, and collaborate effortlessly in embedded computing.
        </p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-dark text-light fw-bold">
        Support us <i class="fa-solid fa-hand-holding-dollar"></i>
    </div>
    <div class="card-body">
        <p class="card-text text-dark">
            The BeagleBoard.org Foundation is a Michigan, USA-based 501(c)(3) non-profit corporation existing to provide education in and collaboration around the design and use of open-source software and hardware in embedded computing.
        </p>
    </div>
    <div class="card-footer d-grid gap-2">
        <a href="https://patreon.com/beagleboard" class="btn btn-danger text-light"><i class="fa-brands fa-patreon"></i> Become a Patreon</a>
        <a href="https://github.com/sponsors/beagleboard" class="btn btn-dark text-light"><i class="fa-brands fa-github"></i> Sponsor on GitHub</a>
    </div>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
<script>

document.addEventListener('DOMContentLoaded', () => {
    // Add primary sidebar toggle button
    const primarySidebar = document.getElementById('pst-primary-sidebar');
    if (primarySidebar) {
        addSidebarToggleButton(
            primarySidebar,
            'primary',
            'sidebar-toggle-btn',
            '<i class="fa-solid fa-caret-left"></i>',
            '<i class="fa-solid fa-caret-right"></i>',
            'after'
        );
    }

    // Add secondary sidebar toggle button
    const secondarySidebar = document.getElementById('pst-secondary-sidebar');
    if (secondarySidebar) {
        addSidebarToggleButton(
            secondarySidebar,
            'secondary',
            'sidebar-toggle-btn',
            '<i class="fa-solid fa-caret-right"></i>',
            '<i class="fa-solid fa-caret-left"></i>',
            'before'
        );
    }

    /**
     * Adds a toggle button for a sidebar with visibility and state management.
     * @param {HTMLElement} sidebar - The sidebar element to toggle.
     * @param {string} key - A unique key for localStorage and button id.
     * @param {string} buttonClass - CSS class for the toggle button.
     * @param {string} collapseHTML - HTML for the button when the sidebar is collapsed.
     * @param {string} expandHTML - HTML for the button when the sidebar is expanded.
     * @param {string} position - Position to insert the button ('before' or 'after').
     */
    function addSidebarToggleButton(sidebar, key, buttonClass, collapseHTML, expandHTML, position) {
        const toggleButton = document.createElement('button');
        toggleButton.id = `toggle-${key}-sidebar`;
        toggleButton.innerHTML = sidebar.classList.contains('collapsed') ? expandHTML : collapseHTML;
        toggleButton.className = buttonClass;

        // Insert the toggle button
        if (position === 'before') {
            sidebar.parentNode.insertBefore(toggleButton, sidebar);
        } else if (position === 'after') {
            sidebar.parentNode.insertBefore(toggleButton, sidebar.nextSibling);
        }

        // Restore collapsed state from localStorage
        const collapsedState = localStorage.getItem(`${key}SidebarCollapsed`) === 'true';
        if (collapsedState) {
            sidebar.classList.add('collapsed');
            toggleButton.innerHTML = expandHTML;
        }

        // Handle toggle button click
        toggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');

            // Update button content and save state
            if (sidebar.classList.contains('collapsed')) {
                toggleButton.innerHTML = expandHTML;
                localStorage.setItem(`${key}SidebarCollapsed`, 'true');
            } else {
                toggleButton.innerHTML = collapseHTML;
                localStorage.setItem(`${key}SidebarCollapsed`, 'false');
            }
        });

        // Check visibility of the toggle button
        function checkToggleVisibility() {
            const existingToggleButton = document.querySelector(
                `.pst-navbar-icon.sidebar-toggle.${key}-toggle`
            );
            if (existingToggleButton && existingToggleButton.offsetParent !== null) {
                toggleButton.style.display = 'none'; // Hide custom toggle button
            } else {
                toggleButton.style.display = 'block'; // Show custom toggle button
            }
        }

        // Update button visibility if the sidebar is removed
        function updateButtonVisibility() {
            if (window.getComputedStyle(sidebar).display === 'none') {
                toggleButton.remove(); // Remove button if sidebar is hidden
            } else if (!document.querySelector(`#toggle-${key}-sidebar`)) {
                // Re-add the button if missing
                if (position === 'before') {
                    sidebar.parentNode.insertBefore(toggleButton, sidebar);
                } else if (position === 'after') {
                    sidebar.parentNode.insertBefore(toggleButton, sidebar.nextSibling);
                }
            }
        }

        // Initial visibility check
        checkToggleVisibility();
        updateButtonVisibility();

        // Monitor window resize for dynamic button visibility updates
        window.addEventListener('resize', () => {
            checkToggleVisibility();
            updateButtonVisibility();
        });
    }
});

</script>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Books</a></li>
    
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">PRU Cookbook</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Building Blocks - Applications</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="building-blocks-applications">
<span id="pru-cookbook-blocks"></span><h1>Building Blocks - Applications<a class="headerlink" href="#building-blocks-applications" title="Link to this heading">#</a></h1>
<p>Here are some examples that use the basic PRU building blocks.</p>
<p>The following are resources used in this chapter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>Resources</em></p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User’s Guide</a></p></li>
<li><p><a class="reference external" href="http://www.ti.com/lit/pdf/spruhz6l">AM572x Technical Reference Manual</a> (AI)</p></li>
<li><p><a class="reference external" href="http://www.ti.com/lit/pdf/spruh73">AM335x Technical Reference Manual</a> (All others)</p></li>
<li><p><a class="reference external" href="http://exploringbeaglebone.com/">Exploring BeagleBone by Derek Molloy</a></p></li>
<li><p><a class="reference external" href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 Data Sheet</a></p></li>
</ul>
</div>
<section id="memory-allocation">
<span id="id1"></span><h2>Memory Allocation<a class="headerlink" href="#memory-allocation" title="Link to this heading">#</a></h2>
<section id="problem">
<h3>Problem<a class="headerlink" href="#problem" title="Link to this heading">#</a></h3>
<p>I want to control where my variables are stored in memory.</p>
<div class="admonition-todo admonition" id="id2">
<p class="admonition-title">Todo</p>
<p>Include a section on accessing DDR.</p>
</div>
</section>
<section id="solution">
<h3>Solution<a class="headerlink" href="#solution" title="Link to this heading">#</a></h3>
<p>Each PRU has is own 8KB of data memory (Data Mem0 and Mem1) and 12KB of
shared memory (Shared RAM) as shown in <a class="reference internal" href="#blocks-pru-block-diagram"><span class="std std-ref">PRU Block Diagram</span></a>.</p>
<figure class="align-center" id="id55">
<span id="blocks-pru-block-diagram"></span><img alt="PRU Block diagram" src="../../../_images/blockDiagram.png" />
<figcaption>
<p><span class="caption-number">Fig. 793 </span><span class="caption-text">PRU Block Diagram</span><a class="headerlink" href="#id55" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Each PRU accesses its own DRAM starting at location 0x0000_0000. Each PRU
can also access the other PRU’s DRAM starting at 0x0000_2000. Both PRUs
access the shared RAM at 0x0001_0000. The compiler can control where each
of these memories variables are stored.</p>
<p><a class="reference internal" href="#blocks-shared"><span class="std std-ref">shared.pro0.c - Examples of Using Different Memory Locations</span></a> shows how to allocate seven variable in six different locations.</p>
<div class="literal-block-wrapper docutils container" id="id56">
<span id="blocks-shared"></span><div class="code-block-caption"><span class="caption-number">Listing 103 </span><span class="caption-text">shared.pro0.c - Examples of Using Different Memory Locations</span><a class="headerlink" href="#id56" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// From: http://git.ti.com/pru-software-support-package/pru-software-support-package/blobs/master/examples/am335x/PRU_access_const_table/PRU_access_const_table.c</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_ctrl.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define PRU_SRAM  __far __attribute__((cregister(&quot;PRU_SHAREDMEM&quot;, near)))</span>
<span class="linenos"> 8</span><span class="cp">#define PRU_DMEM0 __far __attribute__((cregister(&quot;PRU_DMEM_0_1&quot;,  near)))</span>
<span class="linenos"> 9</span><span class="cp">#define PRU_DMEM1 __far __attribute__((cregister(&quot;PRU_DMEM_1_0&quot;,  near)))</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cm">/* NOTE:  Allocating shared_x to PRU Shared Memory means that other PRU cores on</span>
<span class="linenos">12</span><span class="cm"> *        the same subsystem must take care not to allocate data to that memory.</span>
<span class="linenos">13</span><span class="cm"> *		  Users also cannot rely on where in shared memory these variables are placed</span>
<span class="linenos">14</span><span class="cm"> *        so accessing them from another PRU core or from the ARM is an undefined behavior.</span>
<span class="linenos">15</span><span class="cm"> */</span>
<span class="linenos">16</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_0</span><span class="p">;</span>
<span class="linenos">17</span><span class="n">PRU_SRAM</span><span class="w">  </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_1</span><span class="p">;</span>
<span class="linenos">18</span><span class="n">PRU_DMEM0</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_2</span><span class="p">;</span>
<span class="linenos">19</span><span class="n">PRU_DMEM1</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_3</span><span class="p">;</span>
<span class="linenos">20</span><span class="cp">#pragma DATA_SECTION(shared_4, &quot;.bss&quot;)</span>
<span class="linenos">21</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_4</span><span class="p">;</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="cm">/* NOTE:  Here we pick where in memory to store shared_5.  The stack and</span>
<span class="linenos">24</span><span class="cm"> *		  heap take up the first 0x200 words, so we must start after that.</span>
<span class="linenos">25</span><span class="cm"> *		  Since we are hardcoding where things are stored we can share</span>
<span class="linenos">26</span><span class="cm"> *		  this between the PRUs and the ARM.</span>
<span class="linenos">27</span><span class="cm">*/</span>
<span class="linenos">28</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos">29</span><span class="c1">// Skip the first 0x200 bytes of DRAM since the Makefile allocates</span>
<span class="linenos">30</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">31</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">shared_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">32</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">35</span><span class="p">{</span>
<span class="linenos">36</span><span class="w">	</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_6</span><span class="p">;</span>
<span class="linenos">37</span><span class="w">	</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">shared_7</span><span class="p">;</span>
<span class="linenos">38</span><span class="w">	</span><span class="cm">/*****************************************************************/</span>
<span class="linenos">39</span><span class="w">	</span><span class="cm">/* Access PRU peripherals using Constant Table &amp; PRU header file */</span>
<span class="linenos">40</span><span class="w">	</span><span class="cm">/*****************************************************************/</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">43</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="w">	</span><span class="cm">/*****************************************************************/</span>
<span class="linenos">46</span><span class="w">	</span><span class="cm">/* Access PRU Shared RAM using Constant Table                    */</span>
<span class="linenos">47</span><span class="w">	</span><span class="cm">/*****************************************************************/</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="w">	</span><span class="cm">/* C28 defaults to 0x00000000, we need to set bits 23:8 to 0x0100 in order to have it point to 0x00010000	 */</span>
<span class="linenos">50</span><span class="w">	</span><span class="n">PRU0_CTRL</span><span class="p">.</span><span class="n">CTPPR0_bit</span><span class="p">.</span><span class="n">C28_BLK_POINTER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0100</span><span class="p">;</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="w">	</span><span class="n">shared_0</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mh">0xfeef</span><span class="p">;</span>
<span class="linenos">53</span><span class="w">	</span><span class="n">shared_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeadbeef</span><span class="p">;</span>
<span class="linenos">54</span><span class="w">	</span><span class="n">shared_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shared_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0xfeed</span><span class="p">;</span>
<span class="linenos">55</span><span class="w">	</span><span class="n">shared_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xdeed</span><span class="p">;</span>
<span class="linenos">56</span><span class="w">	</span><span class="n">shared_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xbeed</span><span class="p">;</span>
<span class="linenos">57</span><span class="w">	</span><span class="n">shared_5</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">;</span>
<span class="linenos">58</span><span class="w">	</span><span class="n">shared_6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4321</span><span class="p">;</span>
<span class="linenos">59</span><span class="w">	</span><span class="n">shared_7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x9876</span><span class="p">;</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="w">	</span><span class="cm">/* Halt PRU core */</span>
<span class="linenos">62</span><span class="w">	</span><span class="n">__halt</span><span class="p">();</span>
<span class="linenos">63</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/d7277d69e91ecc4f7c16a804a32cdddb/shared.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">shared.pru0.c</span></code></a></p>
</section>
<section id="discussion">
<h3>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">#</a></h3>
<p>Here’s the line-by-line</p>
<div class="pst-scrollable-table-container"><table class="table" id="id57">
<caption><span class="caption-number">Table 154 </span><span class="caption-text">Line-byline for shared.pru0.c</span><a class="headerlink" href="#id57" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>7</p></td>
<td><p><cite>PRU_SRAM</cite> is defined here.  It will be used later to declare variables
in the <cite>Shared RAM</cite> location of memory.  Section 5.5.2 on page 75 of the
<a class="reference external" href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User’s Guide</a>
gives details of the command.  The <cite>PRU_SHAREDMEM</cite>
refers to the memory section defined in <cite>am335x_pru.cmd</cite> on line 26.</p></td>
</tr>
<tr class="row-odd"><td><p>8, 9</p></td>
<td><p>These are like the previous line except for the DMEM sections.</p></td>
</tr>
<tr class="row-even"><td><p>16</p></td>
<td><p>Variables declared outside of <cite>main()</cite> are put on the heap.</p></td>
</tr>
<tr class="row-odd"><td><p>17</p></td>
<td><p>Adding <cite>PRU_SRAM</cite> has the variable stored in the shared memory.</p></td>
</tr>
<tr class="row-even"><td><p>18, 19</p></td>
<td><p>These are stored in the PRU’s local RAM.</p></td>
</tr>
<tr class="row-odd"><td><p>20, 21</p></td>
<td><p>These lines are for storing in the <cite>.bss</cite> section as declared on
line 74 of <cite>am335x_pru.cmd</cite>.</p></td>
</tr>
<tr class="row-even"><td><p>28-31</p></td>
<td><p>All the previous examples direct the compiler to an area in memory
and the compilers figures out what to put where.  With these lines we
specify the exact location.  Here are start with the PRU_DRAM starting
address and add 0x200 to it to avoid
the <strong>stack</strong> and the <strong>heap</strong>.  The advantage of this technique is you can
easily share these variables between the ARM and the two PRUs.</p></td>
</tr>
<tr class="row-odd"><td><p>36, 37</p></td>
<td><p>Variable declared inside <cite>main()</cite> go on the stack.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Using the technique of line 28-31 you can put variables anywhere, even where the
compiler has put them. Be careful, it’s easy to overwrite what the compiler has done</p>
</div>
<p>Compile and run the program.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*source<span class="w"> </span>shared_setup.sh*
<span class="nv">TARGET</span><span class="o">=</span>shared.pru0
Black<span class="w"> </span>Found
P9_31
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_31<span class="w"> </span>is:<span class="w">     </span>pruout
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_31<span class="w"> </span>is:<span class="w">     </span>pruout
P9_29
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_29<span class="w"> </span>is:<span class="w">     </span>pruout
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_29<span class="w"> </span>is:<span class="w">     </span>pruout
P9_30
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_30<span class="w"> </span>is:<span class="w">     </span>pruout
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_30<span class="w"> </span>is:<span class="w">     </span>pruout
P9_28
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_28<span class="w"> </span>is:<span class="w">     </span>pruout
Current<span class="w"> </span>mode<span class="w"> </span><span class="k">for</span><span class="w"> </span>P9_28<span class="w"> </span>is:<span class="w">     </span>pruout
bone$<span class="w"> </span>*make*
/opt/source/pru-cookbook-code/common/Makefile:29:<span class="w"> </span><span class="nv">MODEL</span><span class="o">=</span>TI_AM335x_BeagleBone_Black,TARGET<span class="o">=</span>shared.pru0
-<span class="w">    </span>Stopping<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
-<span class="w">     </span>copying<span class="w"> </span>firmware<span class="w"> </span>file<span class="w"> </span>/tmp/vsx-examples/shared.pru0.out<span class="w"> </span>to<span class="w"> </span>/lib/firmware/am335x-pru0-fw
write_init_pins.sh
-<span class="w">    </span>Starting<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
<span class="nv">MODEL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>TI_AM335x_BeagleBone_Black
<span class="nv">PROC</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>pru
<span class="nv">PRUN</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="nv">PRU_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/sys/class/remoteproc/remoteproc1
</pre></div>
</div>
<p>Now check the <strong>symbol table</strong> to see where things are allocated.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone<span class="w"> </span>$<span class="w"> </span>*grep<span class="w"> </span>shared<span class="w"> </span>/tmp/vsx-examples/shared.pru0.map*
....
<span class="m">1</span><span class="w">     </span>0000011c<span class="w">  </span>shared_0
<span class="m">2</span><span class="w">     </span><span class="m">00010000</span><span class="w">  </span>shared_1
<span class="m">1</span><span class="w">     </span><span class="m">00000000</span><span class="w">  </span>shared_2
<span class="m">1</span><span class="w">     </span><span class="m">00002000</span><span class="w">  </span>shared_3
<span class="m">1</span><span class="w">     </span><span class="m">00000118</span><span class="w">  </span>shared_4
<span class="m">1</span><span class="w">     </span><span class="m">00000120</span><span class="w">  </span>shared_5
</pre></div>
</div>
<p>We see, <code class="docutils literal notranslate"><span class="pre">shared_0</span></code> had no directives and was places in the heap that is 0x100
to 0x1ff.  <code class="docutils literal notranslate"><span class="pre">shared_1</span></code> was directed to go to the SHAREDMEM, <code class="docutils literal notranslate"><span class="pre">shared_2</span></code> to
the start of the local DRAM (which is also the top of the stack).  <code class="docutils literal notranslate"><span class="pre">shared_3</span></code>
was placed in the DRAM of PRU 1, <code class="docutils literal notranslate"><span class="pre">shared_4</span></code> was placed in the <code class="docutils literal notranslate"><span class="pre">.bss</span></code> section,
which is in the <strong>heap</strong>.  Finally <code class="docutils literal notranslate"><span class="pre">shared_5</span></code> is a pointer to where the value
is stored.</p>
<p>Where are <code class="docutils literal notranslate"><span class="pre">shared_6</span></code> and <code class="docutils literal notranslate"><span class="pre">shared_7</span></code>?  They are declared inside <code class="docutils literal notranslate"><span class="pre">main()</span></code> and are
therefore placed on the stack at run time.  The <code class="docutils literal notranslate"><span class="pre">shared.map</span></code> file shows the
compile time allocations.  We have to look in the memory itself to see what
happen at run time.</p>
<p>Let’s fire up <code class="docutils literal notranslate"><span class="pre">prudebug</span></code> (<a class="reference internal" href="../04debug/debug.html#debug-prudebug"><span class="std std-ref">prudebug - A Simple Debugger for the PRU</span></a>) to see where things are.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*sudo<span class="w"> </span>./prudebug*
PRU<span class="w"> </span>Debugger<span class="w"> </span>v0.25
<span class="o">(</span>C<span class="o">)</span><span class="w"> </span>Copyright<span class="w"> </span><span class="m">2011</span>,<span class="w"> </span><span class="m">2013</span><span class="w"> </span>by<span class="w"> </span>Arctica<span class="w"> </span>Technologies.<span class="w">  </span>All<span class="w"> </span>rights<span class="w"> </span>reserved.
Written<span class="w"> </span>by<span class="w"> </span>Steven<span class="w"> </span>Anderson

Using<span class="w"> </span>/dev/mem<span class="w"> </span>device.
Processor<span class="w"> </span><span class="nb">type</span><span class="w">                </span>AM335x
PRUSS<span class="w"> </span>memory<span class="w"> </span>address<span class="w">  </span>0x4a300000
PRUSS<span class="w"> </span>memory<span class="w"> </span>length<span class="w">   </span>0x00080000

<span class="w">        </span>offsets<span class="w"> </span>below<span class="w"> </span>are<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">32</span>-bit<span class="w"> </span>byte<span class="w"> </span>addresses<span class="w"> </span><span class="o">(</span>not<span class="w"> </span>ARM<span class="w"> </span>byte<span class="w"> </span>addresses<span class="o">)</span>
<span class="w">        </span>PRU<span class="w">            </span>Instruction<span class="w">    </span>Data<span class="w">         </span>Ctrl
<span class="w">        </span><span class="m">0</span><span class="w">              </span>0x00034000<span class="w">     </span>0x00000000<span class="w">   </span>0x00022000
<span class="w">        </span><span class="m">1</span><span class="w">              </span>0x00038000<span class="w">     </span>0x00002000<span class="w">   </span>0x00024000

PRU0&gt;<span class="w"> </span>*d<span class="w"> </span><span class="m">0</span>*
Absolute<span class="w"> </span><span class="nv">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000,<span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000,<span class="w"> </span><span class="nv">Len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<span class="o">[</span>0x0000<span class="o">]</span><span class="w"> </span>0x0000feed<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x0010<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x0020<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x0030<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
</pre></div>
</div>
<p>The value of <code class="docutils literal notranslate"><span class="pre">shared_2</span></code> is in memory location 0.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>PRU0&gt;<span class="w"> </span>*dd<span class="w"> </span>0x100*
Absolute<span class="w"> </span><span class="nv">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0100,<span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000,<span class="w"> </span><span class="nv">Len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<span class="o">[</span>0x0100<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000001<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x0110<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x0000beed<span class="w"> </span>0x0000feef
<span class="o">[</span>0x0120<span class="o">]</span><span class="w"> </span>0x00000200<span class="w"> </span>0x3ec71de3<span class="w"> </span>0x1a013e1a<span class="w"> </span>0xbf2a01a0
<span class="o">[</span>0x0130<span class="o">]</span><span class="w"> </span>0x111110b0<span class="w"> </span>0x3f811111<span class="w"> </span>0x55555555<span class="w"> </span>0xbfc55555
</pre></div>
</div>
<p>There are <code class="docutils literal notranslate"><span class="pre">shared_0</span></code> and <code class="docutils literal notranslate"><span class="pre">shared_4</span></code> in the heap, but where is <code class="docutils literal notranslate"><span class="pre">shared_6</span></code> and
<code class="docutils literal notranslate"><span class="pre">shared_7</span></code>?  They are supposed to be on the <strong>stack</strong> that starts at 0.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>PRU0&gt;<span class="w"> </span>dd<span class="w"> </span>*0xc0*
Absolute<span class="w"> </span><span class="nv">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x00c0,<span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000,<span class="w"> </span><span class="nv">Len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<span class="o">[</span>0x00c0<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x00d0<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x00e0<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00000000
<span class="o">[</span>0x00f0<span class="o">]</span><span class="w"> </span>0x00000000<span class="w"> </span>0x00000000<span class="w"> </span>0x00004321<span class="w"> </span>0x00009876
</pre></div>
</div>
<p>There they are; the stack grows from the top. (The heap grows from the bottom.)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>PRU0&gt;<span class="w"> </span>dd<span class="w"> </span>*0x2000*
Absolute<span class="w"> </span><span class="nv">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x2000,<span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000,<span class="w"> </span><span class="nv">Len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<span class="o">[</span>0x2000<span class="o">]</span><span class="w"> </span>0x0000deed<span class="w"> </span>0x00000001<span class="w"> </span>0x00000000<span class="w"> </span>0x557fcfb5
<span class="o">[</span>0x2010<span class="o">]</span><span class="w"> </span>0xce97bd0f<span class="w"> </span>0x6afb2c8f<span class="w"> </span>0xc7f35df4<span class="w"> </span>0x5afb6dcb
<span class="o">[</span>0x2020<span class="o">]</span><span class="w"> </span>0x8dec3da3<span class="w"> </span>0xe39a6756<span class="w"> </span>0x642cb8b8<span class="w"> </span>0xcb6952c0
<span class="o">[</span>0x2030<span class="o">]</span><span class="w"> </span>0x2f22ebda<span class="w"> </span>0x548d97c5<span class="w"> </span>0x9241786f<span class="w"> </span>0x72dfeb86
</pre></div>
</div>
<p>And there is PRU 1’s memory with <code class="docutils literal notranslate"><span class="pre">shared_3</span></code>. And finally the shared memory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>PRU0&gt;<span class="w"> </span>*dd<span class="w"> </span>0x10000*
Absolute<span class="w"> </span><span class="nv">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x10000,<span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0000,<span class="w"> </span><span class="nv">Len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span>
<span class="o">[</span>0x10000<span class="o">]</span><span class="w"> </span>0xdeadbeef<span class="w"> </span>0x0000feed<span class="w"> </span>0x00000000<span class="w"> </span>0x68c44f8b
<span class="o">[</span>0x10010<span class="o">]</span><span class="w"> </span>0xc372ba7e<span class="w"> </span>0x2ffa993b<span class="w"> </span>0x11c66da5<span class="w"> </span>0xfbf6c5d7
<span class="o">[</span>0x10020<span class="o">]</span><span class="w"> </span>0x5ada3fcf<span class="w"> </span>0x4a5d0712<span class="w"> </span>0x48576fb7<span class="w"> </span>0x1004796b
<span class="o">[</span>0x10030<span class="o">]</span><span class="w"> </span>0x2267ebc6<span class="w"> </span>0xa2793aa1<span class="w"> </span>0x100d34dc<span class="w"> </span>0x9ca06d4a
</pre></div>
</div>
<p>The compiler offers great control over where variables are stored. Just
be sure if you are hand picking where things are put, not to put them in places
used by the compiler.</p>
</section>
</section>
<section id="auto-initialization-of-built-in-led-triggers">
<h2>Auto Initialization of built-in LED Triggers<a class="headerlink" href="#auto-initialization-of-built-in-led-triggers" title="Link to this heading">#</a></h2>
<section id="id4">
<h3>Problem<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>I see the built-in LEDs blink to their own patterns.
How do I turn this off? Can this be automated?</p>
</section>
<section id="id5">
<h3>Solution<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>Each built-in LED has a default action (trigger) when the Bone boots up.
This is controlled by <code class="docutils literal notranslate"><span class="pre">/sys/class/leds</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*cd<span class="w"> </span>/sys/class/leds*
bone$<span class="w"> </span>*ls*
beaglebone:green:usr0<span class="w">  </span>beaglebone:green:usr2
beaglebone:green:usr1<span class="w">  </span>beaglebone:green:usr3
</pre></div>
</div>
<p>Here you see a directory for each of the LEDs.  Let’s pick USR1.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*cd<span class="w"> </span>beaglebone<span class="se">\:</span>green<span class="se">\:</span>usr1*
bone$<span class="w"> </span>*ls*
brightness<span class="w">  </span>device<span class="w">  </span>max_brightness<span class="w">  </span>power<span class="w">  </span>subsystem<span class="w">  </span>trigger<span class="w">  </span>uevent
bone$<span class="w"> </span>*cat<span class="w"> </span>trigger*
none<span class="w"> </span>usb-gadget<span class="w"> </span>usb-host<span class="w"> </span>rfkill-any<span class="w"> </span>rfkill-none<span class="w"> </span>kbd-scrolllock<span class="w"> </span>kbd-numlock
kbd-capslock<span class="w"> </span>kbd-kanalock<span class="w"> </span>kbd-shiftlock<span class="w"> </span>kbd-altgrlock<span class="w"> </span>kbd-ctrllock<span class="w"> </span>kbd-altlock
kbd-shiftllock<span class="w"> </span>kbd-shiftrlock<span class="w"> </span>kbd-ctrlllock<span class="w"> </span>kbd-ctrlrlock<span class="w"> </span>*<span class="o">[</span>mmc0<span class="o">]</span>*<span class="w"> </span>timer
oneshot<span class="w"> </span>disk-activity<span class="w"> </span>disk-read<span class="w"> </span>disk-write<span class="w"> </span>ide-disk<span class="w"> </span>mtd<span class="w"> </span>nand-disk<span class="w"> </span>heartbeat
backlight<span class="w"> </span>gpio<span class="w"> </span>cpu<span class="w"> </span>cpu0<span class="w"> </span>activity<span class="w"> </span>default-on<span class="w"> </span>panic<span class="w"> </span>netdev<span class="w"> </span>phy0rx<span class="w"> </span>phy0tx
phy0assoc<span class="w"> </span>phy0radio<span class="w"> </span>rfkill0
</pre></div>
</div>
<p>Notice <code class="docutils literal notranslate"><span class="pre">[mmc0]</span></code> is in brackets.  This means it’s the current trigger; it flashes
when the built-in flash memory is in use.  You can turn this off using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*echo<span class="w"> </span>none<span class="w"> </span>&gt;<span class="w"> </span>trigger*
bone$<span class="w"> </span>*cat<span class="w"> </span>trigger*
*<span class="o">[</span>none<span class="o">]</span>*<span class="w"> </span>usb-gadget<span class="w"> </span>usb-host<span class="w"> </span>rfkill-any<span class="w"> </span>rfkill-none<span class="w"> </span>kbd-scrolllock<span class="w"> </span>kbd-numlock
kbd-capslock<span class="w"> </span>kbd-kanalock<span class="w"> </span>kbd-shiftlock<span class="w"> </span>kbd-altgrlock<span class="w"> </span>kbd-ctrllock<span class="w"> </span>kbd-altlock
kbd-shiftllock<span class="w"> </span>kbd-shiftrlock<span class="w"> </span>kbd-ctrlllock<span class="w"> </span>kbd-ctrlrlock<span class="w"> </span>mmc0<span class="w"> </span>timer
oneshot<span class="w"> </span>disk-activity<span class="w"> </span>disk-read<span class="w"> </span>disk-write<span class="w"> </span>ide-disk<span class="w"> </span>mtd<span class="w"> </span>nand-disk<span class="w"> </span>heartbeat
backlight<span class="w"> </span>gpio<span class="w"> </span>cpu<span class="w"> </span>cpu0<span class="w"> </span>activity<span class="w"> </span>default-on<span class="w"> </span>panic<span class="w"> </span>netdev<span class="w"> </span>phy0rx<span class="w"> </span>phy0tx
phy0assoc<span class="w"> </span>phy0radio<span class="w"> </span>rfkill0
</pre></div>
</div>
<p>Now it is no longer flashing.</p>
<p>How can this be automated so when code is run that needs the trigger off, it’s
turned off automatically?  Here’s a trick.  Include the following in your code.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1">#pragma DATA_SECTION(init_pins, &quot;.init_pins&quot;)</span>
<span class="linenos">2</span><span class="c1">#pragma RETAIN(init_pins)</span>
<span class="linenos">3</span>const<span class="w"> </span>char<span class="w"> </span>init_pins<span class="o">[]</span><span class="w"> </span><span class="o">=</span>
<span class="linenos">4</span><span class="w">        </span><span class="s2">&quot;/sys/class/leds/beaglebone:green:usr3/trigger\0none\0&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="linenos">5</span><span class="w">        </span><span class="s2">&quot;\0\0&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Lines 3 and 4 declare the array <code class="docutils literal notranslate"><span class="pre">init_pins</span></code> to have an entry which is the path
to <code class="docutils literal notranslate"><span class="pre">trigger</span></code> and the value that should be ‘echoed’ into it. Both are NULL
terminated.  Line 1 says to put this in a section called <code class="docutils literal notranslate"><span class="pre">.init_pins</span></code> and
line 2 says to <code class="docutils literal notranslate"><span class="pre">RETAIN</span></code> it.  That is don’t throw it away if it appears to be
unused.</p>
</section>
<section id="id6">
<h3>Discussion<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p>The above code stores this array in the <code class="docutils literal notranslate"><span class="pre">.out</span></code> file thats created, but that’s not
enough. You need to run <a class="reference internal" href="#blocks-write-init-pins"><span class="std std-ref">write_init_pins.sh</span></a> on the <code class="docutils literal notranslate"><span class="pre">.out</span></code> file to make
the code work.  Fortunately the Makefile always runs it.</p>
<div class="literal-block-wrapper docutils container" id="id58">
<span id="blocks-write-init-pins"></span><div class="code-block-caption"><span class="caption-number">Listing 104 </span><span class="caption-text">write_init_pins.sh</span><a class="headerlink" href="#id58" title="Link to this code">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="ch">#!/bin/bash</span>
<span class="linenos">2</span><span class="nv">init_pins</span><span class="o">=</span><span class="k">$(</span>readelf<span class="w"> </span>-x<span class="w"> </span>.init_pins<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>0x000<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="s1">&#39; &#39;</span><span class="w"> </span>-f4-7<span class="w"> </span><span class="p">|</span><span class="w"> </span>xxd<span class="w"> </span>-r<span class="w"> </span>-p<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span><span class="s1">&#39;\0&#39;</span><span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>paste<span class="w"> </span>-<span class="w"> </span>-<span class="k">)</span>
<span class="linenos">3</span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-a<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="linenos">4</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="si">${#</span><span class="nv">line</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">5</span><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>writing<span class="w"> </span><span class="se">\&quot;</span><span class="si">${</span><span class="nv">line</span><span class="p">[1]</span><span class="si">}</span><span class="se">\&quot;</span><span class="w"> </span>to<span class="w"> </span><span class="se">\&quot;</span><span class="si">${</span><span class="nv">line</span><span class="p">[0]</span><span class="si">}</span><span class="se">\&quot;</span>
<span class="linenos">6</span><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="nv">line</span><span class="p">[1]</span><span class="si">}</span><span class="w"> </span>&gt;<span class="w"> </span><span class="si">${</span><span class="nv">line</span><span class="p">[0]</span><span class="si">}</span>
<span class="linenos">7</span><span class="w">        </span>sleep<span class="w"> </span><span class="m">0</span>.1
<span class="linenos">8</span><span class="w">    </span><span class="k">fi</span>
<span class="linenos">9</span><span class="k">done</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$init_pins</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/b79efeeacef01df0fa7beb18372aa41f/write_init_pins.sh"><code class="xref download docutils literal notranslate"><span class="pre">write_init_pins.sh</span></code></a></p>
<p>The <code class="docutils literal notranslate"><span class="pre">readelf</span></code> command extracts the path and value from the <code class="docutils literal notranslate"><span class="pre">.out</span></code> file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*readelf<span class="w"> </span>-x<span class="w"> </span>.init_pins<span class="w"> </span>/tmp/pru0-gen/shared.out*

Hex<span class="w"> </span>dump<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span><span class="s1">&#39;.init_pins&#39;</span>:
<span class="w">  </span>0x000000c0<span class="w"> </span>2f737973<span class="w"> </span>2f636c61<span class="w"> </span>73732f6c<span class="w"> </span>6564732f<span class="w"> </span>/sys/class/leds/
<span class="w">  </span>0x000000d0<span class="w"> </span><span class="m">62656167</span><span class="w"> </span>6c65626f<span class="w"> </span>6e653a67<span class="w"> </span>7265656e<span class="w"> </span>beaglebone:green
<span class="w">  </span>0x000000e0<span class="w"> </span>3a757372<span class="w"> </span>332f7472<span class="w"> </span><span class="m">69676765</span><span class="w"> </span>72006e6f<span class="w"> </span>:usr3/trigger.no
<span class="w">  </span>0x000000f0<span class="w"> </span>6e650000<span class="w"> </span><span class="m">0000</span><span class="w">                       </span>ne....
</pre></div>
</div>
<p>The rest of the command formats it. Finally line 6 echos the <code class="docutils literal notranslate"><span class="pre">none</span></code> into the path.</p>
<p>This can be generalized to initialize other things.  The point is, the <code class="docutils literal notranslate"><span class="pre">.out</span></code>
file contains everything needed to run the executable.</p>
</section>
</section>
<section id="pwm-generator">
<span id="blocks-pwm"></span><h2>PWM Generator<a class="headerlink" href="#pwm-generator" title="Link to this heading">#</a></h2>
<p>One of the simplest things a PRU can to is generate a simple
signal starting with a single channel PWM that has a fixed frequency and
duty cycle and ending with a multi channel PWM that the ARM can change
the frequency and duty cycle on the fly.</p>
<section id="id7">
<h3>Problem<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>I want to generate a PWM signal that has a fixed frequency and duty cycle.</p>
</section>
<section id="id8">
<h3>Solution<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p>The solution is fairly easy, but be sure to check the <em>Discussion</em> section
for details on making it work.</p>
<p><a class="reference internal" href="#blocks-pwm1"><span class="std std-ref">pwm1.pru0.c</span></a> shows the code.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This code is for the BeagleBone Black.
See <code class="docutils literal notranslate"><span class="pre">pwm1.pru1_1.c</span></code> for an example
that works on the AI.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id59">
<span id="blocks-pwm1"></span><div class="code-block-caption"><span class="caption-number">Listing 105 </span><span class="caption-text">pwm1.pru0.c</span><a class="headerlink" href="#id59" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">10</span><span class="p">{</span>
<span class="linenos">11</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P9_31</span><span class="p">;</span><span class="w">	</span><span class="c1">// Select which pin to toggle.;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">14</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">	</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">17</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">18</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">100000000</span><span class="p">);</span>
<span class="linenos">19</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">20</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">100000000</span><span class="p">);</span>
<span class="linenos">21</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">22</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/31bee7a1591fa93dbfaf037319f0bdb3/pwm1.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm1.pru0.c</span></code></a></p>
<p>To run this code you need to configure the pin muxes to output the PRU.  If you are on the Black run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>config-pin<span class="w"> </span>P9_31<span class="w"> </span>pruout
</pre></div>
</div>
<p>On the Pocket run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>config-pin<span class="w"> </span>P1_36<span class="w"> </span>pruout
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference internal" href="../08ai/ai.html#ai-device-tree"><span class="std std-ref">Configuring pins on the AI via device trees</span></a>
for configuring pins on the AI.</p>
</div>
<p>Then, tell <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> which PRU you are compiling for and what your target file is</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>pwm1.pru0
</pre></div>
</div>
<p>Now you are ready to compile</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>make
/opt/source/pru-cookbook-code/common/Makefile:29:<span class="w"> </span><span class="nv">MODEL</span><span class="o">=</span>TI_AM335x_BeagleBone_Black,TARGET<span class="o">=</span>pwm1.pru0
-<span class="w">    </span>Stopping<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
-<span class="w">     </span>copying<span class="w"> </span>firmware<span class="w"> </span>file<span class="w"> </span>/tmp/vsx-examples/pwm1.pru0.out<span class="w"> </span>to<span class="w"> </span>/lib/firmware/am335x-pru0-fw
write_init_pins.sh
-<span class="w">    </span>Starting<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
<span class="nv">MODEL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>TI_AM335x_BeagleBone_Black
<span class="nv">PROC</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>pru
<span class="nv">PRUN</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="nv">PRU_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/sys/class/remoteproc/remoteproc1
</pre></div>
</div>
<p>Now attach an LED (or oscilloscope) to <code class="docutils literal notranslate"><span class="pre">P9_31</span></code> on the Black
or <code class="docutils literal notranslate"><span class="pre">P1.36</span></code> on the Pocket.  You should see a squarewave.</p>
</section>
<section id="id9">
<h3>Discussion<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>Since this is our first example we’ll discuss the many parts in detail.</p>
<div class="literal-block-wrapper docutils container" id="id60">
<div class="code-block-caption"><span class="caption-number">Listing 106 </span><span class="caption-text">pwm1.pru0.c</span><a class="headerlink" href="#id60" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">10</span><span class="p">{</span>
<span class="linenos">11</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P9_31</span><span class="p">;</span><span class="w">	</span><span class="c1">// Select which pin to toggle.;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">14</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">	</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">17</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">18</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">100000000</span><span class="p">);</span>
<span class="linenos">19</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">20</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">100000000</span><span class="p">);</span>
<span class="linenos">21</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">22</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/31bee7a1591fa93dbfaf037319f0bdb3/pwm1.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm1.pru0.c</span></code></a></p>
<p><a class="reference internal" href="#blocks-pwm1-line-by-line"><span class="std std-ref">Line-by-line of pwm1.pru0.c</span></a> is a line-by-line expanation of the c code.</p>
<div class="pst-scrollable-table-container"><span id="blocks-pwm1-line-by-line"></span><table class="table" id="id61">
<caption><span class="caption-number">Table 155 </span><span class="caption-text">Line-by-line of pwm1.pru0.c</span><a class="headerlink" href="#id61" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Standard c-header include</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Include for the PRU.  The compiler knows where to find this since the
<cite>Makefile</cite> says to look for includes in <cite>/usr/lib/ti/pru-software-support-package</cite></p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>The file <cite>resource_table_empty.h</cite> is used by the PRU loader.  Generally we’ll
use the same file, and don’t need to modify it.</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>This include has addresses for the GPIO ports and some bit positions for
some of the headers.</p></td>
</tr>
</tbody>
</table>
</div>
<p>Here’s what’s in <code class="docutils literal notranslate"><span class="pre">resource_table_empty.h</span></code></p>
<div class="literal-block-wrapper docutils container" id="id62">
<div class="code-block-caption"><span class="caption-number">Listing 107 </span><span class="caption-text">resource_table_empty.c</span><a class="headerlink" href="#id62" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> *  ======== resource_table_empty.h ========</span>
<span class="linenos"> 3</span><span class="cm"> *</span>
<span class="linenos"> 4</span><span class="cm"> *  Define the resource table entries for all PRU cores. This will be</span>
<span class="linenos"> 5</span><span class="cm"> *  incorporated into corresponding base images, and used by the remoteproc</span>
<span class="linenos"> 6</span><span class="cm"> *  on the host-side to allocated/reserve resources.  Note the remoteproc</span>
<span class="linenos"> 7</span><span class="cm"> *  driver requires that all PRU firmware be built with a resource table.</span>
<span class="linenos"> 8</span><span class="cm"> *</span>
<span class="linenos"> 9</span><span class="cm"> *  This file contains an empty resource table.  It can be used either as:</span>
<span class="linenos">10</span><span class="cm"> *</span>
<span class="linenos">11</span><span class="cm"> *        1) A template, or</span>
<span class="linenos">12</span><span class="cm"> *        2) As-is if a PRU application does not need to configure PRU_INTC</span>
<span class="linenos">13</span><span class="cm"> *                  or interact with the rpmsg driver</span>
<span class="linenos">14</span><span class="cm"> *</span>
<span class="linenos">15</span><span class="cm"> */</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cp">#ifndef _RSC_TABLE_PRU_H_</span>
<span class="linenos">18</span><span class="cp">#define _RSC_TABLE_PRU_H_</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stddef.h&gt;</span>
<span class="linenos">21</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rsc_types.h&gt;</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_resource_table</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">24</span><span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">resource_table</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="cm">/* Should match &#39;num&#39; in actual definition */</span>
<span class="linenos">27</span><span class="p">};</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="cp">#pragma DATA_SECTION(pru_remoteproc_ResourceTable, &quot;.resource_table&quot;)</span>
<span class="linenos">30</span><span class="cp">#pragma RETAIN(pru_remoteproc_ResourceTable)</span>
<span class="linenos">31</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_resource_table</span><span class="w"> </span><span class="n">pru_remoteproc_ResourceTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">32</span><span class="w">	</span><span class="mi">1</span><span class="p">,</span><span class="w">	</span><span class="cm">/* we&#39;re the first version that implements this */</span>
<span class="linenos">33</span><span class="w">	</span><span class="mi">0</span><span class="p">,</span><span class="w">	</span><span class="cm">/* number of entries in the table */</span>
<span class="linenos">34</span><span class="w">	</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">	</span><span class="cm">/* reserved, must be zero */</span>
<span class="linenos">35</span><span class="w">	</span><span class="mi">0</span><span class="p">,</span><span class="w">	</span><span class="cm">/* offset[0] */</span>
<span class="linenos">36</span><span class="p">};</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="cp">#endif </span><span class="cm">/* _RSC_TABLE_PRU_H_ */</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/aeff0902f5e5f95212e8860ec098053f/resource_table_empty.h"><code class="xref download docutils literal notranslate"><span class="pre">resource_table_empty.c</span></code></a></p>
<div class="pst-scrollable-table-container"><table class="table" id="id63">
<caption><span class="caption-number">Table 156 </span><span class="caption-text">Line-by-line (continuted)</span><a class="headerlink" href="#id63" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>6-7</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">__R30</span></code> and <code class="docutils literal notranslate"><span class="pre">__R31</span></code> are two variables that refer to the
PRU output (<code class="docutils literal notranslate"><span class="pre">__R30</span></code>) and input (<code class="docutils literal notranslate"><span class="pre">__R31</span></code>) registers.
When you write something to <code class="docutils literal notranslate"><span class="pre">__R30</span></code> it will show up on the
corresponding output pins. When you read from <code class="docutils literal notranslate"><span class="pre">__R31</span></code>
you read the data on the input pins.
NOTE: Both names begin with two underscore’s. Section 5.7.2 of the
<a class="reference external" href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User’s Guide</a>
gives more details.</p></td>
</tr>
<tr class="row-odd"><td><p>11</p></td>
<td><p>This line selects which GPIO pin to toggle.  The table below shows which bits in <code class="docutils literal notranslate"><span class="pre">__R30</span></code>
map to which pins</p></td>
</tr>
<tr class="row-even"><td><p>14</p></td>
<td><p><cite>CT_CFG.SYSCFG_bit.STANDBY_INIT</cite> is set to <cite>0</cite> to enable the OCP master port. More details on this
and thousands of other regesters see the
<a class="reference external" href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">TI AM335x TRM</a>. Section 4 is on the PRU
and section 4.5 gives details for all the registers.</p></td>
</tr>
</tbody>
</table>
</div>
<p>Bit 0 is the LSB.</p>
<div class="admonition-todo admonition" id="id11">
<p class="admonition-title">Todo</p>
<p>fill in Blue</p>
</div>
<div class="pst-scrollable-table-container"><span id="blocks-mapping-bits"></span><table class="table" id="id64">
<caption><span class="caption-number">Table 157 </span><span class="caption-text">Mapping bit positions to pin names</span><a class="headerlink" href="#id64" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>PRU</p></th>
<th class="head"><p>Bit</p></th>
<th class="head"><p>Black pin</p></th>
<th class="head"><p>Pocket pin</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0</p></td>
<td><p>P9_31</p></td>
<td><p>P1.36</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>P9_29</p></td>
<td><p>P1.33</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>2</p></td>
<td><p>P9_30</p></td>
<td><p>P2.32</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>3</p></td>
<td><p>P9_28</p></td>
<td><p>P2.30</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>4</p></td>
<td><p>P9_42b</p></td>
<td><p>P1.31</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>5</p></td>
<td><p>P9_27</p></td>
<td><p>P2.34</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>6</p></td>
<td><p>P9_41b</p></td>
<td><p>P2.28</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>7</p></td>
<td><p>P9_25</p></td>
<td><p>P1.29</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>14</p></td>
<td><p>P8_12(out) P8_16(in)</p></td>
<td><p>P2.24</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>15</p></td>
<td><p>P8_11(out) P8_15(in)</p></td>
<td><p>P2.33</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>P8_45</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>1</p></td>
<td><p>P8_46</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>2</p></td>
<td><p>P8_43</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>3</p></td>
<td><p>P8_44</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>4</p></td>
<td><p>P8_41</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>5</p></td>
<td><p>P8_42</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>6</p></td>
<td><p>P8_39</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>7</p></td>
<td><p>P8_40</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>8</p></td>
<td><p>P8_27</p></td>
<td><p>P2.35</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>9</p></td>
<td><p>P8_29</p></td>
<td><p>P2.01</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>10</p></td>
<td><p>P8_28</p></td>
<td><p>P1.35</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>11</p></td>
<td><p>P8_30</p></td>
<td><p>P1.04</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>12</p></td>
<td><p>P8_21</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>13</p></td>
<td><p>P8_20</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>14</p></td>
<td></td>
<td><p>P1.32</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>15</p></td>
<td></td>
<td><p>P1.30</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>16</p></td>
<td><p>P9_26(in)|</p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a class="reference internal" href="../08ai/ai.html#ai-device-tree"><span class="std std-ref">Configuring pins on the AI via device trees</span></a>
for all the PRU pins on the AI.</p>
</div>
<p>Since we are running on PRU 0, and we’re using <code class="docutils literal notranslate"><span class="pre">0x0001</span></code>,
that is bit 0, we’ll be toggling <code class="docutils literal notranslate"><span class="pre">P9_31</span></code>.</p>
<div class="pst-scrollable-table-container"><table class="table" id="id65">
<caption><span class="caption-number">Table 158 </span><span class="caption-text">Line-by-line (continued again)</span><a class="headerlink" href="#id65" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>17</p></td>
<td><p>Here is where the action is.  This line reads <code class="docutils literal notranslate"><span class="pre">__R30</span></code> and
then ORs it with <code class="docutils literal notranslate"><span class="pre">gpio</span></code>, setting the bits where there is
a 1 in <code class="docutils literal notranslate"><span class="pre">gpio</span></code> and leaving the bits where there is a 0.
Thus we are setting the bit we selected. Finally the new
value is written back to <code class="docutils literal notranslate"><span class="pre">__R30</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">__delay_cycles</span></code> is an ((intrinsic function)) that delays
with number of cycles passed to it. Each cycle is 5ns,
and we are delaying 100,000,000 cycles which is
500,000,000ns, or 0.5 seconds.</p></td>
</tr>
<tr class="row-even"><td><p>19</p></td>
<td><p>This is like line 17, but <code class="docutils literal notranslate"><span class="pre">~gpio</span></code> inverts all the bits in <code class="docutils literal notranslate"><span class="pre">gpio</span></code>
so that where we had a 1, there is now a 0.  This 0
is then ANDed with <code class="docutils literal notranslate"><span class="pre">__R30</span></code> setting the corresponding
bit to 0.  Thus we are clearing the bit we selected.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can read more about intrinsics in section 5.11 of the
(<a class="reference external" href="http://www.ti.com/lit/ug/spruhv7b/spruhv7b.pdf">PRU Optimizing C/C++ Compiler, v2.2, User’s Guide</a>.)</p>
</div>
<p>When you run this code and look at the output you will see something like the following figure.</p>
<figure class="align-center" id="id66">
<img alt="pwm1.pru0.c output" src="../../../_images/pwm1.png" />
<figcaption>
<p><span class="caption-number">Fig. 794 </span><span class="caption-text">Output of pwm1.pru0.c with 100,000,000 delays cycles giving a 1s period</span><a class="headerlink" href="#id66" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Notice the on time (<code class="docutils literal notranslate"><span class="pre">+Width(1)</span></code>) is 500ms, just as we predicted.
The off time is 498ms, which is only 2ms off from our prediction.
The standard deviation is 0, or only 380as, which is 380 * 10^-18^!.</p>
<p>You can see how fast the PRU can run by setting both of the
<code class="docutils literal notranslate"><span class="pre">__delay_cycles</span></code> to 0. This results in the next figure.</p>
<figure class="align-center" id="id67">
<img alt="pwm1.pru0.c output with 0 delay" src="../../../_images/pwm2.png" />
<figcaption>
<p><span class="caption-number">Fig. 795 </span><span class="caption-text">Output of pwm1.pru0c with 0 delay cycles</span><a class="headerlink" href="#id67" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Notice the period is 15ns which gives us a frequency of about 67MHz. At this high
frequency the breadboard that I’m using distorts the waveform so it’s no longer a squarewave.
The <strong>on</strong> time is 5.3ns and the <strong>off</strong> time is 9.8ns.  That means <strong>__R30 |= gpio</strong>
took only one 5ns cycle and <code class="docutils literal notranslate"><span class="pre">__R30</span> <span class="pre">&amp;=</span> <span class="pre">~gpio</span></code> also only took one cycle, but there
is also an extra cycle needed for the loop.  This means the compiler was able to implement
the <code class="docutils literal notranslate"><span class="pre">while</span></code> loop in just three 5ns instructions!  Not bad.</p>
<p>We want a square wave, so we need to add a delay to correct for the delay of looping back.</p>
<p>Here’s the code that does just that.</p>
<div class="literal-block-wrapper docutils container" id="id68">
<div class="code-block-caption"><span class="caption-number">Listing 108 </span><span class="caption-text">pwm2.pru0.c</span><a class="headerlink" href="#id68" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">10</span><span class="p">{</span>
<span class="linenos">11</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P9_31</span><span class="p">;</span><span class="w">	</span><span class="c1">// Select which pin to toggle.;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">14</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">17</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">18</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">	</span><span class="c1">// Delay one cycle to correct for loop time</span>
<span class="linenos">19</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">20</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">21</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">22</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/bc99170263746c36cb3678a78b2d33f7/pwm2.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm2.pru0.c</span></code></a></p>
<p>The output now looks like:</p>
<figure class="align-center" id="id69">
<img alt="pwm2.c corrected delay" src="../../../_images/pwm3.png" />
<figcaption>
<p><span class="caption-number">Fig. 796 </span><span class="caption-text">Output of pwm2.pru0.c corrected delay</span><a class="headerlink" href="#id69" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>It’s not hard to adjust the two <code class="docutils literal notranslate"><span class="pre">__delay_cycles</span></code>
to get the desired frequency and duty cycle.</p>
</section>
</section>
<section id="controlling-the-pwm-frequency">
<h2>Controlling the PWM Frequency<a class="headerlink" href="#controlling-the-pwm-frequency" title="Link to this heading">#</a></h2>
<section id="id13">
<h3>Problem<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>You would like to control the frequency and
duty cycle of the PWM without recompiling.</p>
</section>
<section id="id14">
<h3>Solution<a class="headerlink" href="#id14" title="Link to this heading">#</a></h3>
<p>Have the PRU read the <strong>on</strong> and <strong>off</strong> times from a shared memory location.
Each PRU has is own 8KB of data memory (DRAM) and 12KB of shared memory
(SHAREDMEM) that the ARM processor can also access.  See <a class="reference internal" href="#blocks-pru-block-diagram"><span class="std std-ref">PRU Block Diagram</span></a>.</p>
<p>The DRAM 0 address is 0x0000 for PRU 0.  The same DRAM appears at address
0x4A300000 as seen from the ARM processor.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>See page 184 of the <a class="reference external" href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x TRM (184)</a>.</p>
</div>
<p>We take the previous PRU code and add the lines</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PRU0_DRAM             0x00000                 </span><span class="c1">// Offset to DRAM</span>
<span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRU0_DRAM</span><span class="p">;</span>
</pre></div>
</div>
<p>to define a pointer to the DRAM.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <cite>volatile</cite> keyword is used here to tell the compiler the value this
points to may change, so don’t make any assumptions while optimizing.</p>
</div>
<p>Later in the code we use</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">pru0_dram</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">             </span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="n">pru0_dram</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">MAXCH</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">  </span><span class="c1">// Copy after the on array</span>
</pre></div>
</div>
<p>to write the <cite>on</cite> and <cite>off</cite> times to the DRAM.  Then inside the <cite>while</cite> loop we use</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="p">];</span><span class="w">          </span><span class="c1">// Read from DRAM0</span>
<span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</pre></div>
</div>
<p>to read from the DRAM when resetting the counters.  Now, while the PRU is running,
the ARM can write values into the DRAM and change the PWM on and off times.
<a class="reference internal" href="#blocks-pwm4"><span class="std std-ref">pwm4.pru0.c</span></a> is the whole code.</p>
<div class="literal-block-wrapper docutils container" id="id70">
<span id="blocks-pwm4"></span><div class="code-block-caption"><span class="caption-number">Listing 109 </span><span class="caption-text">pwm4.pru0.c</span><a class="headerlink" href="#id70" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code does MAXCH parallel PWM channels.</span>
<span class="linenos"> 2</span><span class="c1">// It&#39;s period is 3 us</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos"> 8</span><span class="c1">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="linenos"> 9</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#define MAXCH	4	</span><span class="c1">// Maximum number of channels per PRU</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">15</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">18</span><span class="p">{</span>
<span class="linenos">19</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="linenos">20</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">on</span><span class="p">[]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span><span class="w">	</span><span class="c1">// Number of cycles to stay on</span>
<span class="linenos">21</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span><span class="w">	</span><span class="c1">// Number to stay off</span>
<span class="linenos">22</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">		</span><span class="c1">// Current count</span>
<span class="linenos">23</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">offCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">26</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="w">	</span><span class="c1">// Initialize the channel counters.</span>
<span class="linenos">29</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">		</span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="linenos">31</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">	</span><span class="c1">// Interleave the on and off values</span>
<span class="linenos">32</span><span class="w">		</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
<span class="linenos">33</span><span class="w">		</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
<span class="linenos">34</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">37</span><span class="w">		</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">38</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">39</span><span class="w">				</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">40</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="n">ch</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">41</span><span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">42</span><span class="w">				</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">43</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="n">ch</span><span class="p">);</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">44</span><span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">45</span><span class="w">				</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="p">];</span><span class="w">		</span><span class="c1">// Read from DRAM0</span>
<span class="linenos">46</span><span class="w">				</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">47</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">48</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">49</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">50</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/e0020e7b230afa1181a9ffa148d25b87/pwm4.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm4.pru0.c</span></code></a></p>
<p>Here is code that runs on the ARM side to set the on and off time values.</p>
<div class="literal-block-wrapper docutils container" id="id71">
<div class="code-block-caption"><span class="caption-number">Listing 110 </span><span class="caption-text">pwm-test.c</span><a class="headerlink" href="#id71" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/* </span>
<span class="linenos"> 2</span><span class="cm"> *</span>
<span class="linenos"> 3</span><span class="cm"> *  pwm tester</span>
<span class="linenos"> 4</span><span class="cm"> *	The on cycle and off cycles are stored in each PRU&#39;s Data memory</span>
<span class="linenos"> 5</span><span class="cm"> *</span>
<span class="linenos"> 6</span><span class="cm"> */</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="linenos">10</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/mman.h&gt;</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#define MAXCH 4</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="cp">#define PRU_ADDR		0x4A300000		</span><span class="c1">// Start of PRU memory Page 184 am335x TRM</span>
<span class="linenos">15</span><span class="cp">#define PRU_LEN			0x80000			</span><span class="c1">// Length of PRU memory</span>
<span class="linenos">16</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos">17</span><span class="cp">#define PRU1_DRAM		0x02000</span>
<span class="linenos">18</span><span class="cp">#define PRU_SHAREDMEM	0x10000			</span><span class="c1">// Offset to shared memory</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">	</span><span class="o">*</span><span class="n">pru0DRAM_32int_ptr</span><span class="p">;</span><span class="w">		</span><span class="c1">// Points to the start of local DRAM</span>
<span class="linenos">21</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">	</span><span class="o">*</span><span class="n">pru1DRAM_32int_ptr</span><span class="p">;</span><span class="w">		</span><span class="c1">// Points to the start of local DRAM</span>
<span class="linenos">22</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">	</span><span class="o">*</span><span class="n">prusharedMem_32int_ptr</span><span class="p">;</span><span class="w">	</span><span class="c1">// Points to the start of the shared memory</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="cm">/*******************************************************************************</span>
<span class="linenos">25</span><span class="cm">* int start_pwm_count(int ch, int countOn, int countOff)</span>
<span class="linenos">26</span><span class="cm">* </span>
<span class="linenos">27</span><span class="cm">* Starts a pwm pulse on for countOn and off for countOff to a single channel (ch)</span>
<span class="linenos">28</span><span class="cm">*******************************************************************************/</span>
<span class="linenos">29</span><span class="kt">int</span><span class="w"> </span><span class="nf">start_pwm_count</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">countOn</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">countOff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">30</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pruDRAM_32int_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pru0DRAM_32int_ptr</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">	</span>
<span class="linenos">32</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;countOn: %d, countOff: %d, count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">33</span><span class="w">		</span><span class="n">countOn</span><span class="p">,</span><span class="w"> </span><span class="n">countOff</span><span class="p">,</span><span class="w"> </span><span class="n">countOn</span><span class="o">+</span><span class="n">countOff</span><span class="p">);</span>
<span class="linenos">34</span><span class="w">	</span><span class="c1">// write to PRU shared memory</span>
<span class="linenos">35</span><span class="w">	</span><span class="n">pruDRAM_32int_ptr</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countOn</span><span class="p">;</span><span class="w">	</span><span class="c1">// On time</span>
<span class="linenos">36</span><span class="w">	</span><span class="n">pruDRAM_32int_ptr</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countOff</span><span class="p">;</span><span class="w">	</span><span class="c1">// Off time</span>
<span class="linenos">37</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">38</span><span class="p">}</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="linenos">41</span><span class="p">{</span>
<span class="linenos">42</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">	</span><span class="o">*</span><span class="n">pru</span><span class="p">;</span><span class="w">		</span><span class="c1">// Points to start of PRU memory.</span>
<span class="linenos">43</span><span class="w">	</span><span class="kt">int</span><span class="w">	</span><span class="n">fd</span><span class="p">;</span>
<span class="linenos">44</span><span class="w">	</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Servo tester</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">45</span><span class="w">	</span>
<span class="linenos">46</span><span class="w">	</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;/dev/mem&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDWR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_SYNC</span><span class="p">);</span>
<span class="linenos">47</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">48</span><span class="w">		</span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ERROR: could not open /dev/mem.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">50</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">51</span><span class="w">	</span><span class="n">pru</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PRU_LEN</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">PRU_ADDR</span><span class="p">);</span>
<span class="linenos">52</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pru</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">53</span><span class="w">		</span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ERROR: could not map memory.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">54</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">55</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">56</span><span class="w">	</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="linenos">57</span><span class="w">	</span><span class="n">printf</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Using /dev/mem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">58</span><span class="w">	</span>
<span class="linenos">59</span><span class="w">	</span><span class="n">pru0DRAM_32int_ptr</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="n">pru</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PRU0_DRAM</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="w">	</span><span class="c1">// Points to 0x200 of PRU0 memory</span>
<span class="linenos">60</span><span class="w">	</span><span class="n">pru1DRAM_32int_ptr</span><span class="w"> </span><span class="o">=</span><span class="w">     </span><span class="n">pru</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PRU1_DRAM</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="w">	</span><span class="c1">// Points to 0x200 of PRU1 memory</span>
<span class="linenos">61</span><span class="w">	</span><span class="n">prusharedMem_32int_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pru</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PRU_SHAREDMEM</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span><span class="w">	</span><span class="c1">// Points to start of shared memory</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">64</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">65</span><span class="w">		</span><span class="n">start_pwm_count</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
<span class="linenos">66</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">67</span><span class="w">	</span>
<span class="linenos">68</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">munmap</span><span class="p">(</span><span class="n">pru</span><span class="p">,</span><span class="w"> </span><span class="n">PRU_LEN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">69</span><span class="w">		</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;munmap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">70</span><span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">71</span><span class="w">		</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;munmap succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">72</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">73</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/639f86eb146d6f52af870b45fb05a272/pwm-test.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm-test.c</span></code></a></p>
<p>A quick check on the ‘scope shows <a class="reference internal" href="#blocks-pwm-arm-control"><span class="std std-ref">Four Channel PWM with ARM control</span></a>.</p>
<figure class="align-center" id="id72">
<span id="blocks-pwm-arm-control"></span><img alt="pwm4.png" src="../../../_images/pwm4.png" />
<figcaption>
<p><span class="caption-number">Fig. 797 </span><span class="caption-text">Four Channel PWM with ARM control</span><a class="headerlink" href="#id72" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>From the ‘scope you see a 1 cycle <strong>on</strong> time results in a 450ns wide pulse and a
3.06us period is 326KHz, much slower than the 10ns pulse we saw before.  But it
may be more than fast enough for many applications.  For example, most servos run at 50Hz.</p>
<p>But we can do better.</p>
</section>
</section>
<section id="loop-unrolling-for-better-performance">
<h2>Loop Unrolling for Better Performance<a class="headerlink" href="#loop-unrolling-for-better-performance" title="Link to this heading">#</a></h2>
<section id="id15">
<h3>Problem<a class="headerlink" href="#id15" title="Link to this heading">#</a></h3>
<p>The ARM controlled PRU code runs too slowly.</p>
</section>
<section id="id16">
<h3>Solution<a class="headerlink" href="#id16" title="Link to this heading">#</a></h3>
<p>Simple loop unrolling can greatly improve the speed.  <code class="docutils literal notranslate"><span class="pre">pwm5.pru0.c</span></code> is our unrolled version.</p>
<div class="literal-block-wrapper docutils container" id="id73">
<div class="code-block-caption"><span class="caption-number">Listing 111 </span><span class="caption-text">pwm5.pru0.c Unrolled</span><a class="headerlink" href="#id73" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code does MAXCH parallel PWM channels.</span>
<span class="linenos"> 2</span><span class="c1">// It&#39;s period is 510ns.</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos"> 8</span><span class="c1">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="linenos"> 9</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#define MAXCH	4	</span><span class="c1">// Maximum number of channels per PRU</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="cp">#define update(ch) \</span>
<span class="linenos">15</span><span class="cp">			if(onCount[ch]) {			\</span>
<span class="linenos">16</span><span class="cp">				onCount[ch]--;			\</span>
<span class="linenos">17</span><span class="cp">				__R30 |= 0x1&lt;&lt;ch;		\</span>
<span class="linenos">18</span><span class="cp">			} else if(offCount[ch]) {	\</span>
<span class="linenos">19</span><span class="cp">				offCount[ch]--;			\</span>
<span class="linenos">20</span><span class="cp">				__R30 &amp;= ~(0x1&lt;&lt;ch);	\</span>
<span class="linenos">21</span><span class="cp">			} else {					\</span>
<span class="linenos">22</span><span class="cp">				onCount[ch] = pru0_dram[2*ch];	\</span>
<span class="linenos">23</span><span class="cp">				offCount[ch]= pru0_dram[2*ch+1];	\</span>
<span class="linenos">24</span><span class="cp">			}</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">27</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">30</span><span class="p">{</span>
<span class="linenos">31</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">on</span><span class="p">[]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span>
<span class="linenos">33</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="linenos">34</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">],</span><span class="w"> </span><span class="n">offCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">37</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="cp">#pragma UNROLL(MAXCH)</span>
<span class="linenos">40</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">41</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">		</span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="linenos">42</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">	</span><span class="c1">// Interleave the on and off values</span>
<span class="linenos">43</span><span class="w">		</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
<span class="linenos">44</span><span class="w">		</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
<span class="linenos">45</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">48</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">49</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">50</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">51</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">52</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">53</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/090259de6f28bcb19b5ff92e8c85d7be/pwm5.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm5.pru0.c</span></code></a></p>
<p>The output of <code class="docutils literal notranslate"><span class="pre">pwm5.pru0.c</span></code> is in the figure below.</p>
<figure class="align-center" id="id74">
<img alt="pwm5.pru0.c Unrolled version of pwm4.pru0.c" src="../../../_images/pwm5_no_loop.png" />
<figcaption>
<p><span class="caption-number">Fig. 798 </span><span class="caption-text">pwm5.pru0.c Unrolled version of pwm4.pru0.c</span><a class="headerlink" href="#id74" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>It’s running about 6 times faster than <code class="docutils literal notranslate"><span class="pre">pwm4.pru0.c</span></code>.</p>
<div class="pst-scrollable-table-container"><table class="table" id="id75">
<caption><span class="caption-number">Table 159 </span><span class="caption-text">pwm4.pru0.c vs. pwm5.pru0.c</span><a class="headerlink" href="#id75" title="Link to this table">#</a></caption>
<tbody>
<tr class="row-odd"><td><p>Measure</p></td>
<td><p>pwm4.pru0.c time</p></td>
<td><p>pwm5.pru0.c time</p></td>
<td><p>Speedup</p></td>
<td><p>pwm5.pru0.c w/o UNROLL</p></td>
<td><p>Speedup</p></td>
</tr>
<tr class="row-even"><td><p>Period</p></td>
<td><p>3.06&amp;mu;s</p></td>
<td><p>510ns</p></td>
<td><p>6x</p></td>
<td><p>1.81&amp;mu;s</p></td>
<td><p>~1.7x</p></td>
</tr>
<tr class="row-odd"><td><p>Width+</p></td>
<td><p>450ns</p></td>
<td><p>70ns</p></td>
<td><p>~6x</p></td>
<td><p>1.56&amp;mu;s</p></td>
<td><p>~.3x</p></td>
</tr>
</tbody>
</table>
</div>
<p>Not a bad speed up for just a couple of simple changes.</p>
</section>
<section id="id17">
<h3>Discussion<a class="headerlink" href="#id17" title="Link to this heading">#</a></h3>
<p>Here’s how it works.
First look at line 39.  You see <code class="docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">UNROLL(MAXCH)</span></code> which is a <code class="docutils literal notranslate"><span class="pre">pragma</span></code>
that tells the compiler to unroll the loop that follows.  We are unrolling it
<code class="docutils literal notranslate"><span class="pre">MAXCH</span></code> times (four times in this example). Just removing the <code class="docutils literal notranslate"><span class="pre">pragma</span></code> causes
the speedup compared to the <code class="docutils literal notranslate"><span class="pre">pwm4.pru0.c</span></code> case to drop from 6x to only 1.7x.</p>
<p>We also have our <code class="docutils literal notranslate"><span class="pre">for</span></code> loop inside the <code class="docutils literal notranslate"><span class="pre">while</span></code> loop that can be unrolled.
Unfortunately <code class="docutils literal notranslate"><span class="pre">UNROLL()</span></code> doesn’t work on it, therefore we have to do it by
hand. We could take the loop and just copy it three times, but that would
make it harder to maintain the code.  Instead I converted the loop into a
<code class="docutils literal notranslate"><span class="pre">#define</span></code> (lines 14-24) and invoked <code class="docutils literal notranslate"><span class="pre">update()</span></code> as needed (lines 48-51).
This is not a function call. Whenever the preprocessor sees the <code class="docutils literal notranslate"><span class="pre">update()</span></code>
it copies the code an then it’s compiled.</p>
<p>This unrolling gets us an impressive 6x speedup.</p>
</section>
</section>
<section id="making-all-the-pulses-start-at-the-same-time">
<h2>Making All the Pulses Start at the Same Time<a class="headerlink" href="#making-all-the-pulses-start-at-the-same-time" title="Link to this heading">#</a></h2>
<section id="id18">
<h3>Problem<a class="headerlink" href="#id18" title="Link to this heading">#</a></h3>
<p>I have a mutlichannel PWM working, but the pulses aren’t synchronized, that is
they don’t all start at the same time.</p>
</section>
<section id="id19">
<h3>Solution<a class="headerlink" href="#id19" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="#blocks-zoomed"><span class="std std-ref">pwm5.pru0 Zoomed In</span></a> is a zoomed in version of the previous figure. Notice the pulse
in each channel starts about 15ns later than the channel above it.</p>
<figure class="align-center" id="id76">
<span id="blocks-zoomed"></span><img alt="pwm5.pru0 zoomed.png" src="../../../_images/pwm5_zoomed.png" />
<figcaption>
<p><span class="caption-number">Fig. 799 </span><span class="caption-text">pwm5.pru0 Zoomed In</span><a class="headerlink" href="#id76" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The solution is to declare <code class="docutils literal notranslate"><span class="pre">Rtmp</span></code> (line 35) which holds the value for <code class="docutils literal notranslate"><span class="pre">__R30</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id77">
<div class="code-block-caption"><span class="caption-number">Listing 112 </span><span class="caption-text">pwm6.pru0.c Sync’ed Version of pwm5.pru0.c</span><a class="headerlink" href="#id77" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code does MAXCH parallel PWM channels.</span>
<span class="linenos"> 2</span><span class="c1">// All channels start at the same time. It&#39;s period is 510ns</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos"> 8</span><span class="c1">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="linenos"> 9</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#define MAXCH	4	</span><span class="c1">// Maximum number of channels per PRU</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="cp">#define update(ch) \</span>
<span class="linenos">15</span><span class="cp">			if(onCount[ch]) {			\</span>
<span class="linenos">16</span><span class="cp">				onCount[ch]--;			\</span>
<span class="linenos">17</span><span class="cp">				Rtmp |= 0x1&lt;&lt;ch;		\</span>
<span class="linenos">18</span><span class="cp">			} else if(offCount[ch]) {	\</span>
<span class="linenos">19</span><span class="cp">				offCount[ch]--;			\</span>
<span class="linenos">20</span><span class="cp">				Rtmp &amp;= ~(0x1&lt;&lt;ch);	\</span>
<span class="linenos">21</span><span class="cp">			} else {					\</span>
<span class="linenos">22</span><span class="cp">				onCount[ch] = pru0_dram[2*ch];	\</span>
<span class="linenos">23</span><span class="cp">				offCount[ch]= pru0_dram[2*ch+1];	\</span>
<span class="linenos">24</span><span class="cp">			}</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">27</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">30</span><span class="p">{</span>
<span class="linenos">31</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">on</span><span class="p">[]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span>
<span class="linenos">33</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="linenos">34</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">],</span><span class="w"> </span><span class="n">offCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">35</span><span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">38</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#pragma UNROLL(MAXCH)</span>
<span class="linenos">41</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">42</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">		</span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="linenos">43</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span><span class="w">	</span><span class="c1">// Interleave the on and off values</span>
<span class="linenos">44</span><span class="w">		</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
<span class="linenos">45</span><span class="w">		</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
<span class="linenos">46</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">47</span><span class="w">	</span><span class="n">Rtmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">50</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">51</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">52</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="linenos">53</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos">54</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">55</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">56</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/23cc20f14adb7ab8328f4caa1788bf8a/pwm6.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm6.pru0.c</span> <span class="pre">Sync'ed</span> <span class="pre">Version</span> <span class="pre">of</span> <span class="pre">pwm5.pru0.c</span></code></a></p>
<p>Each channel writes it’s value to <code class="docutils literal notranslate"><span class="pre">Rtmp</span></code> (lines 17 and 20) and then after
each channel has updated, <code class="docutils literal notranslate"><span class="pre">Rtmp</span></code> is copied to <code class="docutils literal notranslate"><span class="pre">__R30</span></code> (line 54).</p>
</section>
<section id="id20">
<h3>Discussion<a class="headerlink" href="#id20" title="Link to this heading">#</a></h3>
<p>The following figure shows the channel are sync’ed. Though the period is slightly
longer than before.</p>
<figure class="align-center" id="id78">
<img alt="pwm6.pru0 Synchronized Channels" src="../../../_images/pwm6_synced.png" />
<figcaption>
<p><span class="caption-number">Fig. 800 </span><span class="caption-text">pwm6.pru0 Synchronized Channels</span><a class="headerlink" href="#id78" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="adding-more-channels-via-pru-1">
<h2>Adding More Channels via PRU 1<a class="headerlink" href="#adding-more-channels-via-pru-1" title="Link to this heading">#</a></h2>
<section id="id21">
<h3>Problem<a class="headerlink" href="#id21" title="Link to this heading">#</a></h3>
<p>You need more output channels, or you need to shorten the period.</p>
</section>
<section id="id22">
<h3>Solution<a class="headerlink" href="#id22" title="Link to this heading">#</a></h3>
<p>PRU 0 can output up to eight output pins (see
<a class="reference internal" href="#blocks-mapping-bits"><span class="std std-ref">Mapping bit positions to pin names</span></a>). The code presented so far
can be easily extended to use the eight output pins.</p>
<p>But what if you need more channels?
You can always use PRU1, it has 14 output pins.</p>
<p>Or, what if four channels is enough, but you need a shorter period. Everytime
you add a channel, the overall period gets longer.  Twice as many channels
means twice as long a period.  If you move half the channels to PRU 1, you
will make the period half as long.</p>
<p>Here’s the code (<code class="docutils literal notranslate"><span class="pre">pwm7.pru0.c</span></code>)</p>
<div class="literal-block-wrapper docutils container" id="id79">
<div class="code-block-caption"><span class="caption-number">Listing 113 </span><span class="caption-text">pwm7.pru0.c Using Both PRUs</span><a class="headerlink" href="#id79" title="Link to this code">#</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1</span>
<span class="linenos"> 2</span><span class="c1">// All channels start at the same time. But the PRU 1 ch have a difference period</span>
<span class="linenos"> 3</span><span class="c1">// It&#39;s period is 370ns</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cp">#define PRUNUM 0</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos">11</span><span class="c1">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="linenos">12</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">13</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="cp">#define MAXCH	2	</span><span class="c1">// Maximum number of channels per PRU</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cp">#define update(ch) \</span>
<span class="linenos">18</span><span class="cp">			if(onCount[ch]) {			\</span>
<span class="linenos">19</span><span class="cp">				onCount[ch]--;			\</span>
<span class="linenos">20</span><span class="cp">				Rtmp |= 0x1&lt;&lt;ch;		\</span>
<span class="linenos">21</span><span class="cp">			} else if(offCount[ch]) {	\</span>
<span class="linenos">22</span><span class="cp">				offCount[ch]--;			\</span>
<span class="linenos">23</span><span class="cp">				Rtmp &amp;= ~(0x1&lt;&lt;ch);	\</span>
<span class="linenos">24</span><span class="cp">			} else {					\</span>
<span class="linenos">25</span><span class="cp">				onCount[ch] = pru0_dram[2*ch];	\</span>
<span class="linenos">26</span><span class="cp">				offCount[ch]= pru0_dram[2*ch+1];	\</span>
<span class="linenos">27</span><span class="cp">			}</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">30</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">33</span><span class="p">{</span>
<span class="linenos">34</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="linenos">35</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">on</span><span class="p">[]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span>
<span class="linenos">36</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="linenos">37</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">],</span><span class="w"> </span><span class="n">offCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">38</span><span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">41</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#pragma UNROLL(MAXCH)</span>
<span class="linenos">44</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">45</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">	</span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="linenos">46</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">	</span><span class="c1">// Interleave the on and off values</span>
<span class="linenos">47</span><span class="w">		</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">48</span><span class="w">		</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">49</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">50</span><span class="w">	</span><span class="n">Rtmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">53</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">54</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">55</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">56</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">57</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/c09b5f881f903d414c2206a140208ed9/pwm7.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm7.pru0.c</span> <span class="pre">Using</span> <span class="pre">Both</span> <span class="pre">PRUs</span></code></a></p>
<p>Be sure to run <code class="docutils literal notranslate"><span class="pre">pwm7_setup.sh</span></code> to get the correct pins configured.</p>
<div class="literal-block-wrapper docutils container" id="id80">
<div class="code-block-caption"><span class="caption-number">Listing 114 </span><span class="caption-text">pwm7_setup.sh</span><a class="headerlink" href="#id80" title="Link to this code">#</a></div>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/bin/bash</span>
<span class="linenos"> 2</span><span class="c1">#</span>
<span class="linenos"> 3</span><span class="nb">export</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>pwm7.pru0
<span class="linenos"> 4</span><span class="nb">echo</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span><span class="nv">$TARGET</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c1"># Configure the PRU pins based on which Beagle is running</span>
<span class="linenos"> 7</span><span class="nv">machine</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span>/proc/device-tree/model<span class="k">)</span>
<span class="linenos"> 8</span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">$machine</span>
<span class="linenos"> 9</span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Black&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">10</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">11</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;P9_31 P9_29 P8_45 P8_46&quot;</span>
<span class="linenos">12</span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Blue&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">13</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">14</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">15</span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PocketBeagle&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">16</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">17</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;P1_36 P1_33&quot;</span>
<span class="linenos">18</span><span class="k">else</span>
<span class="linenos">19</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Not Found&quot;</span>
<span class="linenos">20</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">21</span><span class="k">fi</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="k">for</span><span class="w"> </span>pin<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$pins</span>
<span class="linenos">24</span><span class="k">do</span>
<span class="linenos">25</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$pin</span>
<span class="linenos">26</span><span class="w">    </span>config-pin<span class="w"> </span><span class="nv">$pin</span><span class="w"> </span>pruout
<span class="linenos">27</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span><span class="nv">$pin</span>
<span class="linenos">28</span><span class="k">done</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/1d1592a0f79aacfdc2200d59c8205f9c/pwm7_setup.sh"><code class="xref download docutils literal notranslate"><span class="pre">pw7_setup.sh</span></code></a></p>
<p>This makes sure the PRU 1 pins are properly configured.</p>
<p>Here we have a second <code class="docutils literal notranslate"><span class="pre">pwm7</span></code> file. <code class="docutils literal notranslate"><span class="pre">pwm7.pru1.c</span></code> is identical to <code class="docutils literal notranslate"><span class="pre">pwm7.pru0.c</span></code>
except <code class="docutils literal notranslate"><span class="pre">PRUNUM</span></code> is set to 1, instead of 0.</p>
<p>Compile and run the two files with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*make<span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>pwm7.pru0<span class="p">;</span><span class="w"> </span>make<span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>pwm7.pru1*
/opt/source/pru-cookbook-code/common/Makefile:29:<span class="w"> </span><span class="nv">MODEL</span><span class="o">=</span>TI_AM335x_BeagleBone_Black,TARGET<span class="o">=</span>pwm7.pru0
-<span class="w">    </span>Stopping<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
-<span class="w">     </span>copying<span class="w"> </span>firmware<span class="w"> </span>file<span class="w"> </span>/tmp/vsx-examples/pwm7.pru0.out<span class="w"> </span>to<span class="w"> </span>/lib/firmware/am335x-pru0-fw
write_init_pins.sh
-<span class="w">    </span>Starting<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
<span class="nv">MODEL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>TI_AM335x_BeagleBone_Black
<span class="nv">PROC</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>pru
<span class="nv">PRUN</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="nv">PRU_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/sys/class/remoteproc/remoteproc1
/opt/source/pru-cookbook-code/common/Makefile:29:<span class="w"> </span><span class="nv">MODEL</span><span class="o">=</span>TI_AM335x_BeagleBone_Black,TARGET<span class="o">=</span>pwm7.pru1
-<span class="w">    </span>Stopping<span class="w"> </span>PRU<span class="w"> </span><span class="m">1</span>
-<span class="w">     </span>copying<span class="w"> </span>firmware<span class="w"> </span>file<span class="w"> </span>/tmp/vsx-examples/pwm7.pru1.out<span class="w"> </span>to<span class="w"> </span>/lib/firmware/am335x-pru1-fw
write_init_pins.sh
-<span class="w">    </span>Starting<span class="w"> </span>PRU<span class="w"> </span><span class="m">1</span>
<span class="nv">MODEL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>TI_AM335x_BeagleBone_Black
<span class="nv">PROC</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>pru
<span class="nv">PRUN</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="nv">PRU_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/sys/class/remoteproc/remoteproc2
</pre></div>
</div>
<p>This will first stop, compile and start PRU 0, then do the same for PRU 1.</p>
<p>Moving half of the channels to PRU1 dropped the period from 510ns to 370ns, so
we gained a bit.</p>
</section>
<section id="id23">
<h3>Discussion<a class="headerlink" href="#id23" title="Link to this heading">#</a></h3>
<p>There weren’t many changes to be made.  Line 15 we set MAXCH to 2. Lines 44-48
is where the big change is.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUN</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">       </span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUN</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">       </span><span class="c1">// Interleave the on and off values</span>
<span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUN</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUN</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
</pre></div>
</div>
<p>If we are compiling for PRU 0, <code class="docutils literal notranslate"><span class="pre">on[ch+PRUNUN*MAXCH]</span></code> becomes <code class="docutils literal notranslate"><span class="pre">on[ch+0*2]</span></code> which is
<code class="docutils literal notranslate"><span class="pre">on[ch]</span></code> which is what we had before.  But now if we are on PRU 1 it becomes
<code class="docutils literal notranslate"><span class="pre">on[ch+1*2]</span></code> which is <code class="docutils literal notranslate"><span class="pre">on[ch+2]</span></code>.  That means we are picking up the second
half of the <code class="docutils literal notranslate"><span class="pre">on</span></code> and <code class="docutils literal notranslate"><span class="pre">off</span></code> arrays.  The first half goes to PRU 0, the second to
PRU 1.  So the same code can be used for both PRUs, but we get slightly different
behavior.</p>
<p>Running the code you will see the next figure.</p>
<figure class="align-center" id="id81">
<img alt="pwm7.pru0 Two PRUs running" src="../../../_images/pwm7_two_prus_running.png" />
<figcaption>
<p><span class="caption-number">Fig. 801 </span><span class="caption-text">pwm7.pru0 Two PRUs running</span><a class="headerlink" href="#id81" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>What’s going on there, the first channels look fine, but the PRU 1 channels
are blurred.  To see what’s happening, let’s stop the oscilloscope.</p>
<figure class="align-center" id="id82">
<img alt="pwm7 Two PRUs stopped" src="../../../_images/pwm7_two_prus_stopped.png" />
<figcaption>
<p><span class="caption-number">Fig. 802 </span><span class="caption-text">pwm7.pru0 Two PRUs stopped</span><a class="headerlink" href="#id82" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The stopped display shows that the four channels are doing what we wanted, except
The PRU 0 channels have a period of 370ns while the PRU 1 channels at 330ns.
It appears the compiler has optimied the two PRUs slightly differently.</p>
</section>
</section>
<section id="synchronizing-two-prus">
<h2>Synchronizing Two PRUs<a class="headerlink" href="#synchronizing-two-prus" title="Link to this heading">#</a></h2>
<section id="id24">
<h3>Problem<a class="headerlink" href="#id24" title="Link to this heading">#</a></h3>
<p>I need to synchronize the two PRUs so they run together.</p>
</section>
<section id="id25">
<h3>Solution<a class="headerlink" href="#id25" title="Link to this heading">#</a></h3>
<p>Use the Interrupt Controller (INTC).  It allows one PRU to signal the other.
Page 225 of the <a class="reference external" href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x TRM 225</a>
has details of how it works.  Here’s the code for PRU 0, which at the end of the
<code class="docutils literal notranslate"><span class="pre">while</span></code> loop signals PRU 1 to start(<code class="docutils literal notranslate"><span class="pre">pwm8.pru0.c</span></code>).</p>
<div class="literal-block-wrapper docutils container" id="id83">
<div class="code-block-caption"><span class="caption-number">Listing 115 </span><span class="caption-text">pwm8.pru0.c PRU 0 using INTC to send a signal to PRU 1</span><a class="headerlink" href="#id83" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1</span>
<span class="linenos"> 2</span><span class="c1">// All channels start at the same time. </span>
<span class="linenos"> 3</span><span class="c1">// It&#39;s period is 430ns</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_intc.h&gt;</span>
<span class="linenos"> 7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_ctrl.h&gt;</span>
<span class="linenos"> 8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="cp">#define PRUNUM 0</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos">13</span><span class="c1">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="linenos">14</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">15</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cp">#define MAXCH	2	</span><span class="c1">// Maximum number of channels per PRU</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="cp">#define update(ch) \</span>
<span class="linenos">20</span><span class="cp">			if(onCount[ch]) {			\</span>
<span class="linenos">21</span><span class="cp">				onCount[ch]--;			\</span>
<span class="linenos">22</span><span class="cp">				Rtmp |= 0x1&lt;&lt;ch;		\</span>
<span class="linenos">23</span><span class="cp">			} else if(offCount[ch]) {	\</span>
<span class="linenos">24</span><span class="cp">				offCount[ch]--;			\</span>
<span class="linenos">25</span><span class="cp">				Rtmp &amp;= ~(0x1&lt;&lt;ch);	\</span>
<span class="linenos">26</span><span class="cp">			} else {					\</span>
<span class="linenos">27</span><span class="cp">				onCount[ch] = pru0_dram[2*ch];	\</span>
<span class="linenos">28</span><span class="cp">				offCount[ch]= pru0_dram[2*ch+1];	\</span>
<span class="linenos">29</span><span class="cp">			}</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">32</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="c1">// Initialize interrupts so the PRUs can be syncronized.</span>
<span class="linenos">35</span><span class="c1">// PRU1 is started first and then waits for PRU0</span>
<span class="linenos">36</span><span class="c1">// PRU0 is then started and tells PRU1 when to start going</span>
<span class="linenos">37</span><span class="kt">void</span><span class="w"> </span><span class="nf">configIntc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">	</span>
<span class="linenos">38</span><span class="w">	</span><span class="n">__R31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000</span><span class="p">;</span><span class="w">					</span><span class="c1">// Clear any pending PRU-generated events</span>
<span class="linenos">39</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">CMR4_bit</span><span class="p">.</span><span class="n">CH_MAP_16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">		</span><span class="c1">// Map event 16 to channel 1</span>
<span class="linenos">40</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">HMR0_bit</span><span class="p">.</span><span class="n">HINT_MAP_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">	</span><span class="c1">// Map channel 1 to host 1</span>
<span class="linenos">41</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">SICR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w">					</span><span class="c1">// Ensure event 16 is cleared</span>
<span class="linenos">42</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">EISR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w">					</span><span class="c1">// Enable event 16</span>
<span class="linenos">43</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">HIEISR</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">			</span><span class="c1">// Enable Host interrupt 1</span>
<span class="linenos">44</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">GER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> 					</span><span class="c1">// Globally enable host interrupts</span>
<span class="linenos">45</span><span class="p">}</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">48</span><span class="p">{</span>
<span class="linenos">49</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="linenos">50</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">on</span><span class="p">[]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span>
<span class="linenos">51</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="linenos">52</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">],</span><span class="w"> </span><span class="n">offCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">53</span><span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">GPCFG0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">;</span><span class="w">				</span><span class="c1">// Configure GPI and GPO as Mode 0 (Direct Connect)</span>
<span class="linenos">56</span><span class="w">	</span><span class="n">configIntc</span><span class="p">();</span><span class="w">						</span><span class="c1">// Configure INTC</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">59</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="cp">#pragma UNROLL(MAXCH)</span>
<span class="linenos">62</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">63</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">	</span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="linenos">64</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">	</span><span class="c1">// Interleave the on and off values</span>
<span class="linenos">65</span><span class="w">		</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">66</span><span class="w">		</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">67</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">68</span><span class="w">	</span><span class="n">Rtmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">71</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">72</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">73</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">74</span><span class="cp">#define PRU0_PRU1_EVT 16</span>
<span class="linenos">75</span><span class="w">		</span><span class="n">__R31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_PRU1_EVT</span><span class="mi">-16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span><span class="w">	</span><span class="c1">//Tell PRU 1 to start</span>
<span class="linenos">76</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">77</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">78</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/8ab58dd0826ef67a2b839b58874945aa/pwm8.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm8.pru0.c</span>&#160; <span class="pre">PRU</span> <span class="pre">0</span> <span class="pre">using</span> <span class="pre">INTC</span> <span class="pre">to</span> <span class="pre">send</span> <span class="pre">a</span> <span class="pre">signal</span> <span class="pre">to</span> <span class="pre">PRU</span> <span class="pre">1</span></code></a></p>
<p>PRU 2’s code waits for PRU 0 before going.</p>
<div class="literal-block-wrapper docutils container" id="id84">
<div class="code-block-caption"><span class="caption-number">Listing 116 </span><span class="caption-text">pwm8.pru1.c PRU 1 waiting for INTC from PRU 0</span><a class="headerlink" href="#id84" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code does MAXCH parallel PWM channels on both PRU 0 and PRU 1</span>
<span class="linenos"> 2</span><span class="c1">// All channels start at the same time. </span>
<span class="linenos"> 3</span><span class="c1">// It&#39;s period is 430ns</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_intc.h&gt;</span>
<span class="linenos"> 7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_ctrl.h&gt;</span>
<span class="linenos"> 8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="cp">#define PRUNUM 1</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="cp">#define PRU0_DRAM		0x00000			</span><span class="c1">// Offset to DRAM</span>
<span class="linenos">13</span><span class="c1">// Skip the first 0x200 byte of DRAM since the Makefile allocates</span>
<span class="linenos">14</span><span class="c1">// 0x100 for the STACK and 0x100 for the HEAP.</span>
<span class="linenos">15</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">pru0_dram</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">PRU0_DRAM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x200</span><span class="p">);</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="cp">#define MAXCH	2	</span><span class="c1">// Maximum number of channels per PRU</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="cp">#define update(ch) \</span>
<span class="linenos">20</span><span class="cp">			if(onCount[ch]) {			\</span>
<span class="linenos">21</span><span class="cp">				onCount[ch]--;			\</span>
<span class="linenos">22</span><span class="cp">				Rtmp |= 0x1&lt;&lt;ch;		\</span>
<span class="linenos">23</span><span class="cp">			} else if(offCount[ch]) {	\</span>
<span class="linenos">24</span><span class="cp">				offCount[ch]--;			\</span>
<span class="linenos">25</span><span class="cp">				Rtmp &amp;= ~(0x1&lt;&lt;ch);	\</span>
<span class="linenos">26</span><span class="cp">			} else {					\</span>
<span class="linenos">27</span><span class="cp">				onCount[ch] = pru0_dram[2*ch];	\</span>
<span class="linenos">28</span><span class="cp">				offCount[ch]= pru0_dram[2*ch+1];	\</span>
<span class="linenos">29</span><span class="cp">			}</span>
<span class="linenos">30</span>
<span class="linenos">31</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">32</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="c1">// Initialize interrupts so the PRUs can be syncronized.</span>
<span class="linenos">35</span><span class="c1">// PRU1 is started first and then waits for PRU0</span>
<span class="linenos">36</span><span class="c1">// PRU0 is then started and tells PRU1 when to start going</span>
<span class="linenos">37</span>
<span class="linenos">38</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">39</span><span class="p">{</span>
<span class="linenos">40</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="linenos">41</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">on</span><span class="p">[]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span>
<span class="linenos">42</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="linenos">43</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">],</span><span class="w"> </span><span class="n">offCount</span><span class="p">[</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">44</span><span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">47</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="cp">#pragma UNROLL(MAXCH)</span>
<span class="linenos">50</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">ch</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">&lt;</span><span class="n">MAXCH</span><span class="p">;</span><span class="w"> </span><span class="n">ch</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">51</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="w">  </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">	</span><span class="c1">// Copy to DRAM0 so the ARM can change it</span>
<span class="linenos">52</span><span class="w">		</span><span class="n">pru0_dram</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ch</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span><span class="w">	</span><span class="c1">// Interleave the on and off values</span>
<span class="linenos">53</span><span class="w">		</span><span class="n">onCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">54</span><span class="w">		</span><span class="n">offCount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="n">off</span><span class="p">[</span><span class="n">ch</span><span class="o">+</span><span class="n">PRUNUM</span><span class="o">*</span><span class="n">MAXCH</span><span class="p">];</span>
<span class="linenos">55</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">56</span><span class="w">	</span><span class="n">Rtmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">57</span>
<span class="linenos">58</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">59</span><span class="w">		</span><span class="k">while</span><span class="p">((</span><span class="n">__R31</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">		</span><span class="c1">// Wait for PRU 0</span>
<span class="linenos">60</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">61</span><span class="w">		</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">SICR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w">					</span><span class="c1">// Clear event 16</span>
<span class="linenos">62</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rtmp</span><span class="p">;</span>
<span class="linenos">63</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">64</span><span class="w">		</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">65</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">66</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/10308d768bdfb338505b4395ac1b88ab/pwm8.pru1.c"><code class="xref download docutils literal notranslate"><span class="pre">pwm8.pru1.c</span> <span class="pre">PRU</span> <span class="pre">1</span> <span class="pre">waiting</span> <span class="pre">for</span> <span class="pre">INTC</span> <span class="pre">from</span> <span class="pre">PRU</span> <span class="pre">0</span></code></a></p>
<p>In <code class="docutils literal notranslate"><span class="pre">pwm8.pru0.c</span></code> PRU 1 waits for a signal from PRU 0, so be sure to start PRU 1 first.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*make<span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>pwm8.pru0<span class="p">;</span><span class="w"> </span>make<span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>pwm8.pru1*
</pre></div>
</div>
</section>
<section id="id26">
<h3>Discussion<a class="headerlink" href="#id26" title="Link to this heading">#</a></h3>
<p>The figure below shows the two PRUs are synchronized, though there is some extra
overhead in the process so the period is longer.</p>
<figure class="align-center" id="id85">
<img alt="pwm8.pru0 PRUs synced" src="../../../_images/pwm8_prus_sycned.png" />
<figcaption>
<p><span class="caption-number">Fig. 803 </span><span class="caption-text">pwm8.pru0 PRUs synced</span><a class="headerlink" href="#id85" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>This isn’t much different from the previous examples.</p>
<div class="pst-scrollable-table-container"><table class="table" id="id86">
<caption><span class="caption-number">Table 160 </span><span class="caption-text">pwm8.pru0.c changes from pwm7.pru0.c</span><a class="headerlink" href="#id86" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>PRU</p></th>
<th class="head"><p>Line</p></th>
<th class="head"><p>Change</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>37-45</p></td>
<td><p>For PRU 0 these define <code class="docutils literal notranslate"><span class="pre">configInitc()</span></code> which initializes the interrupts.
See page 226 of the
<a class="reference external" href="https://www.ti.com/lit/ug/spruh73p/spruh73p.pdf">AM335x TRM</a>
for a diagram explaining events, channels, hosts, etc.</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>55-56</p></td>
<td><p>Set a configuration register and call <cite>configInitc</cite>.</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>59-61</p></td>
<td><p>PRU 1 then waits for PRU 0 to signal it.  Bit 31 of <code class="docutils literal notranslate"><span class="pre">__R31</span></code> corresponds
to the Host-1 channel which <code class="docutils literal notranslate"><span class="pre">configInitc()</span></code> set up. We also clear event 16 so
PRU 0 can set it again.</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>74-75</p></td>
<td><p>On PRU 0 this generates the interrupt to send to PRU 1.  I found PRU 1 was
slow to respond to the interrupt, so I put this code at the end of the loop to
give time for the signal to get to PRU 1.</p></td>
</tr>
</tbody>
</table>
</div>
<p>This ends the multipart pwm example.</p>
</section>
</section>
<section id="reading-an-input-at-regular-intervals">
<h2>Reading an Input at Regular Intervals<a class="headerlink" href="#reading-an-input-at-regular-intervals" title="Link to this heading">#</a></h2>
<section id="id27">
<h3>Problem<a class="headerlink" href="#id27" title="Link to this heading">#</a></h3>
<p>You have an input pin that needs to be read at regular intervals.</p>
</section>
<section id="id28">
<h3>Solution<a class="headerlink" href="#id28" title="Link to this heading">#</a></h3>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">__R31</span></code> register to read an input pin. Let’s use the following pins.</p>
<div class="pst-scrollable-table-container"><span id="blocks-io-pins"></span><table class="table" id="id87">
<caption><span class="caption-number">Table 161 </span><span class="caption-text">Input/Output pins</span><a class="headerlink" href="#id87" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Direction</p></th>
<th class="head"><p>Bit number</p></th>
<th class="head"><p>Black</p></th>
<th class="head"><p>AI (ICSS2)</p></th>
<th class="head"><p>Pocket</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>out</p></td>
<td><p>0</p></td>
<td><p>P9_31</p></td>
<td><p>P8_44</p></td>
<td><p>P1.36</p></td>
</tr>
<tr class="row-odd"><td><p>in</p></td>
<td><p>7</p></td>
<td><p>P9_25</p></td>
<td><p>P8_36</p></td>
<td><p>P1.29</p></td>
</tr>
</tbody>
</table>
</div>
<p>These values came from <a class="reference internal" href="#blocks-mapping-bits"><span class="std std-ref">Mapping bit positions to pin names</span></a>.</p>
<p>Configure the pins with <code class="docutils literal notranslate"><span class="pre">input_setup.sh</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id88">
<div class="code-block-caption"><span class="caption-number">Listing 117 </span><span class="caption-text">input_setup.sh</span><a class="headerlink" href="#id88" title="Link to this code">#</a></div>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/bin/bash</span>
<span class="linenos"> 2</span><span class="c1">#</span>
<span class="linenos"> 3</span><span class="nb">export</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>input.pru0
<span class="linenos"> 4</span><span class="nb">echo</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span><span class="nv">$TARGET</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c1"># Configure the PRU pins based on which Beagle is running</span>
<span class="linenos"> 7</span><span class="nv">machine</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span>/proc/device-tree/model<span class="k">)</span>
<span class="linenos"> 8</span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">$machine</span>
<span class="linenos"> 9</span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Black&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">10</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">11</span><span class="w">    </span>config-pin<span class="w"> </span>P9_31<span class="w"> </span>pruout
<span class="linenos">12</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span>P9_31
<span class="linenos">13</span><span class="w">    </span>config-pin<span class="w"> </span>P9_25<span class="w"> </span>pruin
<span class="linenos">14</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span>P9_25
<span class="linenos">15</span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Blue&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">16</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">17</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">18</span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PocketBeagle&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">19</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">20</span><span class="w">    </span>config-pin<span class="w"> </span>P1_36<span class="w"> </span>pruout
<span class="linenos">21</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span>P1_36
<span class="linenos">22</span><span class="w">    </span>config-pin<span class="w"> </span>P1_29<span class="w"> </span>pruin
<span class="linenos">23</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span>P1_29
<span class="linenos">24</span><span class="k">else</span>
<span class="linenos">25</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Not Found&quot;</span>
<span class="linenos">26</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">27</span><span class="k">fi</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/3bb9305b318e31c99225b052a586e62b/input_setup.sh"><code class="xref download docutils literal notranslate"><span class="pre">input_setup.sh</span></code></a></p>
<p>The following code reads the input pin and writes its value to the output pin.</p>
<div class="literal-block-wrapper docutils container" id="id89">
<div class="code-block-caption"><span class="caption-number">Listing 118 </span><span class="caption-text">input.pru0.c</span><a class="headerlink" href="#id89" title="Link to this code">#</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos"> 6</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">led</span><span class="p">;</span>
<span class="linenos">11</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">sw</span><span class="p">;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">14</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">	</span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">;</span><span class="w">	</span><span class="c1">// P9_31 or P1_36</span>
<span class="linenos">17</span><span class="w">	</span><span class="n">sw</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">;</span><span class="w">	</span><span class="c1">// P9_25 or P1_29</span>
<span class="linenos">18</span><span class="w">		</span>
<span class="linenos">19</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">20</span><span class="w">		</span><span class="k">if</span><span class="p">((</span><span class="n">__R31</span><span class="o">&amp;</span><span class="n">sw</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">21</span><span class="w">			</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">led</span><span class="p">;</span><span class="w">		</span><span class="c1">// Turn on LED</span>
<span class="linenos">22</span><span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="linenos">23</span><span class="w">			</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">led</span><span class="p">;</span><span class="w">		</span><span class="c1">// Turn off LED</span>
<span class="linenos">24</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">25</span><span class="p">}</span>
<span class="linenos">26</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/72a329e4e4c10669766a0808e28a3823/input.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">input.pru0.c</span></code></a></p>
</section>
<section id="id29">
<h3>Discussion<a class="headerlink" href="#id29" title="Link to this heading">#</a></h3>
<p>Just remember that <code class="docutils literal notranslate"><span class="pre">__R30</span></code> is for outputs and <code class="docutils literal notranslate"><span class="pre">__R31</span></code> is for inputs.</p>
</section>
</section>
<section id="analog-wave-generator">
<h2>Analog Wave Generator<a class="headerlink" href="#analog-wave-generator" title="Link to this heading">#</a></h2>
<section id="id30">
<h3>Problem<a class="headerlink" href="#id30" title="Link to this heading">#</a></h3>
<p>I want to generate an analog output, but only have GPIO pins.</p>
</section>
<section id="id31">
<h3>Solution<a class="headerlink" href="#id31" title="Link to this heading">#</a></h3>
<p>The Beagle doesn’t have a built-in  analog to digital converter. You could get a
<a class="reference external" href="https://www.amazon.com/external-Adapter-Windows-Microphone-SD-CM-UAUD/dp/B001MSS6CS/0&amp;keywords=audio+dongle">USB Audio Dongle</a>
which are under $10. But here we’ll take another approach.</p>
<p>Earlier we generated a PWM signal.  Here we’ll generate a PWM whose duty cycle
changes with time. A small duty cycle for when the output signal is small and
a large duty cycle for when it is large.</p>
<p>This example was inspired by
<a class="reference external" href="https://github.com/derekmolloy/exploringBB/tree/master/chp13/sineWave">A PRU Sin Wave Generator</a>
in chapter 13 of <a class="reference external" href="http://exploringbeaglebone.com/">Exploring BeagleBone by Derek Molloy</a>.</p>
<p>Here’s the code.</p>
<div class="literal-block-wrapper docutils container" id="id90">
<div class="code-block-caption"><span class="caption-number">Listing 119 </span><span class="caption-text">sine.pru0.c</span><a class="headerlink" href="#id90" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Generate an analog waveform and use a filter to reconstruct it.</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define MAXT	100	</span><span class="c1">// Maximum number of time samples</span>
<span class="linenos"> 8</span><span class="cp">#define SAWTOOTH	</span><span class="c1">// Pick which waveform</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">11</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">14</span><span class="p">{</span>
<span class="linenos">15</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">onCount</span><span class="p">;</span><span class="w">		</span><span class="c1">// Current count for 1 out</span>
<span class="linenos">16</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">offCount</span><span class="p">;</span><span class="w">		</span><span class="c1">// count for 0 out</span>
<span class="linenos">17</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">18</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">waveform</span><span class="p">[</span><span class="n">MAXT</span><span class="p">];</span><span class="w"> </span><span class="c1">// Waveform to be produced</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="w">	</span><span class="c1">// Generate a periodic wave in an array of MAXT values</span>
<span class="linenos">21</span><span class="cp">#ifdef SAWTOOTH</span>
<span class="linenos">22</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAXT</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">23</span><span class="w">		</span><span class="n">waveform</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">MAXT</span><span class="p">;</span>
<span class="linenos">24</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">25</span><span class="cp">#endif</span>
<span class="linenos">26</span><span class="cp">#ifdef TRIANGLE</span>
<span class="linenos">27</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAXT</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">28</span><span class="w">		</span><span class="n">waveform</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">MAXT</span><span class="p">;</span>
<span class="linenos">29</span><span class="w">		</span><span class="n">waveform</span><span class="p">[</span><span class="n">MAXT</span><span class="o">-</span><span class="n">i</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">MAXT</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">31</span><span class="cp">#endif</span>
<span class="linenos">32</span><span class="cp">#ifdef SINE</span>
<span class="linenos">33</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">gain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50.0f</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">bias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50.0f</span><span class="p">;</span>
<span class="linenos">35</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">3.14159f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">MAXT</span><span class="p">;</span>
<span class="linenos">36</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAXT</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="linenos">37</span><span class="w">		</span><span class="n">waveform</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">bias</span><span class="o">+</span><span class="n">gain</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">freq</span><span class="p">));</span>
<span class="linenos">38</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">39</span><span class="cp">#endif</span>
<span class="linenos">40</span>
<span class="linenos">41</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">42</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">43</span>
<span class="linenos">44</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">45</span><span class="w">		</span><span class="c1">// Generate a PWM signal whose duty cycle matches</span>
<span class="linenos">46</span><span class="w">		</span><span class="c1">// the amplitude of the signal.</span>
<span class="linenos">47</span><span class="w">		</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAXT</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">48</span><span class="w">			</span><span class="n">onCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waveform</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">49</span><span class="w">			</span><span class="n">offCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">onCount</span><span class="p">;</span>
<span class="linenos">50</span><span class="w">			</span><span class="k">while</span><span class="p">(</span><span class="n">onCount</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">51</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">52</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">53</span><span class="w">			</span><span class="k">while</span><span class="p">(</span><span class="n">offCount</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">54</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mh">0x1</span><span class="p">);</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">55</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">56</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">57</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">58</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/527387aa4ce0e527fae9836ecf10193e/sine.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">sine.pru0.c</span></code></a></p>
<p>Set the <code class="docutils literal notranslate"><span class="pre">#define</span></code> at line 7 to the number of samples in one cycle of the waveform
and set the <code class="docutils literal notranslate"><span class="pre">#define</span></code> at line 8 to which waveform and then run <code class="docutils literal notranslate"><span class="pre">make</span></code>.</p>
</section>
<section id="id33">
<h3>Discussion<a class="headerlink" href="#id33" title="Link to this heading">#</a></h3>
<p>The code has two parts.  The first part (lines 21 to 39) generate the waveform
to be output. The <code class="docutils literal notranslate"><span class="pre">#define``s</span> <span class="pre">let</span> <span class="pre">you</span> <span class="pre">select</span> <span class="pre">which</span> <span class="pre">waveform</span> <span class="pre">you</span> <span class="pre">want</span> <span class="pre">to</span>
<span class="pre">generate.</span>&#160; <span class="pre">Since</span> <span class="pre">the</span> <span class="pre">output</span> <span class="pre">is</span> <span class="pre">a</span> <span class="pre">percent</span> <span class="pre">duty</span> <span class="pre">cycle,</span> <span class="pre">the</span> <span class="pre">values</span> <span class="pre">in</span> <span class="pre">``waveform[]</span></code>
must be between 0 and 100 inclusive. The waveform is only generated once, so
this part of the code isn’t time critical.</p>
<p>The second part (lines 44 to 54) uses the generated data to set the
duty cycle of the PWM on a cycle-by-cycle basis. This part is time critical;
the faster we can output the values, the higher the frequency of the output
signal.</p>
<p>Suppose you want to generate a sawtooth waveform like the one shown in <a class="reference internal" href="#blocks-sawtooth"><span class="std std-ref">Continuous Sawtooth Waveform</span></a>.</p>
<figure class="align-center" id="id91">
<span id="blocks-sawtooth"></span><img alt="Continuous Sawtooth Waveform" src="../../../_images/sawtoothsmooth.png" />
<figcaption>
<p><span class="caption-number">Fig. 804 </span><span class="caption-text">Continuous Sawtooth Waveform</span><a class="headerlink" href="#id91" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>You need to sample the waveform and store one cycle. <a class="reference internal" href="#blocks-sawtoothsampled"><span class="std std-ref">Sampled Sawtooth Waveform</span></a>
shows a sampled version of the sawtooth. You need to generate <code class="docutils literal notranslate"><span class="pre">MAXT</span></code> samples;
here we show 20 samples, which may be enough. In the code <code class="docutils literal notranslate"><span class="pre">MAXT</span></code> is set to 100.</p>
<figure class="align-center" id="id92">
<span id="blocks-sawtoothsampled"></span><img alt="Sampled Sawtooth Waveform" src="../../../_images/sawtoothsampled.png" />
<figcaption>
<p><span class="caption-number">Fig. 805 </span><span class="caption-text">Sampled Sawtooth Waveform</span><a class="headerlink" href="#id92" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>There’s a lot going on here; let’s take it line by line.</p>
<div class="pst-scrollable-table-container"><table class="table" id="id93">
<caption><span class="caption-number">Table 162 </span><span class="caption-text">Line-by-line of sine.pru0.c</span><a class="headerlink" href="#id93" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>2-5</p></td>
<td><p>Standard c-header includes</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>Number for samples in one cycle of the analog waveform</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>Which waveform to use.  We’ve defined SAWTOOTH, TRIANGLE and SINE, but
you can define your own too.</p></td>
</tr>
<tr class="row-odd"><td><p>10-11</p></td>
<td><p>Declaring registers <code class="docutils literal notranslate"><span class="pre">pass:[__R30]</span></code> and <code class="docutils literal notranslate"><span class="pre">pass:[__R31]</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p>15-16</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">onCount</span></code> counts how many cycles the PWM should be 1 and <code class="docutils literal notranslate"><span class="pre">offCount</span></code> counts
how many it should be off.</p></td>
</tr>
<tr class="row-odd"><td><p>18</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">waveform[]</span></code> stores the analog waveform being output.</p></td>
</tr>
<tr class="row-even"><td><p>21-24</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">SAWTOOTH</span></code> is the simplest of the waveforms. Each sample is the duty cycle
at that time and must therefore be between 0 and 100.</p></td>
</tr>
<tr class="row-odd"><td><p>26-31</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">TRIANGLE</span></code> is also a simple waveform.</p></td>
</tr>
<tr class="row-even"><td><p>32-39</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">SINE</span></code> generates a sine wave and also introduces floating point.  Yes,
you can use floating point, but the PRUs don’t have floating point hardware,
rather, it’s all done in software.  This mean using floating point will make
your code much bigger and slower.  Slower doesn’t matter in this part, and
bigger isn’t bigger than our instruction memory, so we’re OK.</p></td>
</tr>
<tr class="row-odd"><td><p>47</p></td>
<td><p>Here the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop looks up each value of the generated waveform.</p></td>
</tr>
<tr class="row-even"><td><p>48,49</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">onCount</span></code> is the number of cycles to be at 1 and <code class="docutils literal notranslate"><span class="pre">offCount</span></code> is the number
of cycles to be 0. The two add to 100, one full cycle.</p></td>
</tr>
<tr class="row-odd"><td><p>50-52</p></td>
<td><p>Stay on for <code class="docutils literal notranslate"><span class="pre">onCount</span></code> cycles.</p></td>
</tr>
<tr class="row-even"><td><p>53-55</p></td>
<td><p>Now turn off for <code class="docutils literal notranslate"><span class="pre">offCount</span></code> cycles, then loop back and look up the next
cycle count.</p></td>
</tr>
</tbody>
</table>
</div>
<p><a class="reference internal" href="#blocks-sawunfiltered"><span class="std std-ref">Unfiltered Sawtooth Waveform</span></a> shows the output of the code.</p>
<figure class="align-center" id="id94">
<span id="blocks-sawunfiltered"></span><img alt="Unfiltered Sawtooth Waveform" src="../../../_images/sawunfiltered.png" />
<figcaption>
<p><span class="caption-number">Fig. 806 </span><span class="caption-text">Unfiltered Sawtooth Waveform</span><a class="headerlink" href="#id94" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>It doesn’t look like a sawtooth; but if you look at the left side you will
see each cycle has a longer and longer on time.  The duty cycle is increasing.
Once it’s almost 100% duty cycle, it switches to a very small duty cycle.
Therefore it’s output what we programmed, but what we want is the average of
the signal.  The left hand side has a large (and increasing) average which
would be for top of the sawtooth.  The right hand side has a small average,
which is what you want for the start of the sawtooth.</p>
<p>A simple low-pass filter, built with one resistor and one capacitor will do it.
<a class="reference internal" href="#blocks-filterwiring"><span class="std std-ref">Low-Pass Filter Wiring Diagram</span></a> shows how to wire it up.</p>
<figure class="align-center" id="id95">
<span id="blocks-filterwiring"></span><img alt="Low-Pass Filter Wiring Diagram" src="../../../_images/filter_bb.png" />
<figcaption>
<p><span class="caption-number">Fig. 807 </span><span class="caption-text">Low-Pass Filter Wiring Diagram</span><a class="headerlink" href="#id95" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I used a 10K variable resistor and a 0.022uF capacitor.
Probe the circuit between the resistor and the capacitor
and adjust the resistor until you get a good looking waveform.</p>
</div>
<p><a class="reference internal" href="#blocks-sawscope"><span class="std std-ref">Reconstructed Sawtooth Waveform</span></a> shows the results for filtered the SAWTOOTH.</p>
<figure class="align-center" id="id96">
<span id="blocks-sawscope"></span><img alt="Reconstructed Sawtooth Waveform" src="../../../_images/sawscope.png" />
<figcaption>
<p><span class="caption-number">Fig. 808 </span><span class="caption-text">Reconstructed Sawtooth Waveform</span><a class="headerlink" href="#id96" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Now that looks more like a sawtooth wave.  The top plot is the time-domain
plot of the output of the low-pass filter. The bottom plot is the FFT of the top
plot, therefore it’s the frequency domain. We are getting a sawtooth with a
frequency of about 6.1KHz. You can see the fundamental frequency on the
bottom plot along with several harmonics.</p>
<p>The top looks like a sawtooth wave,
but there is a high freqnecy superimposed on it.  We are only using a simple
first-order filter.  You could lower the cutoff freqnecy by adjusting the
resistor.  You’ll see something like <a class="reference internal" href="#blocks-lowercutoff"><span class="std std-ref">Reconstructed Sawtooth Waveform with Lower Cutoff Frequency</span></a>.</p>
<figure class="align-center" id="id97">
<span id="blocks-lowercutoff"></span><img alt="Reconstructed Sawtooth Waveform with Lower Cutoff Frequency" src="../../../_images/sawlowercutoff.png" />
<figcaption>
<p><span class="caption-number">Fig. 809 </span><span class="caption-text">Reconstructed Sawtooth Waveform with Lower Cutoff Frequency</span><a class="headerlink" href="#id97" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The high frequencies have been reduced, but the corner of the waveform has
been rounded.  You can also adjust the cutoff to a higher frequency and you’ll
get a sharper corner, but you’ll also get more high frequencies. See
<a class="reference internal" href="#blocks-highercutoff"><span class="std std-ref">Reconstructed Sawtooth Waveform with Higher Cutoff Frequency</span></a></p>
<figure class="align-center" id="id98">
<span id="blocks-highercutoff"></span><img alt="Reconstructed Sawtooth Waveform with Higher Cutoff Frequency" src="../../../_images/sawhighercutoff.png" />
<figcaption>
<p><span class="caption-number">Fig. 810 </span><span class="caption-text">Reconstructed Sawtooth Waveform with Higher Cutoff Frequency</span><a class="headerlink" href="#id98" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Adjust to taste, though the real solution is to build a higher order filter.
Search for _second order <strong>filter</strong> and you’ll find some nice circuits.</p>
<p>You can adjust the frequency of the signal by adjusting <code class="docutils literal notranslate"><span class="pre">MAXT</span></code>.  A smaller
<code class="docutils literal notranslate"><span class="pre">MAXT</span></code> will give a higher frequency.  I’ve gotten good results with <code class="docutils literal notranslate"><span class="pre">MAXT</span></code>
as small as 20.</p>
<p>You can also get a triangle waveform by setting the <code class="docutils literal notranslate"><span class="pre">#define</span></code>.
<a class="reference internal" href="#blocks-triangle"><span class="std std-ref">Reconstructed Triangle Waveform</span></a> shows the output signal.</p>
<figure class="align-center" id="id99">
<span id="blocks-triangle"></span><img alt="Reconstructed Triangle Waveform" src="../../../_images/triangle.png" />
<figcaption>
<p><span class="caption-number">Fig. 811 </span><span class="caption-text">Reconstructed Triangle Waveform</span><a class="headerlink" href="#id99" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>And also the sine wave as shown in <a class="reference internal" href="#blocks-sine"><span class="std std-ref">Reconstructed Sinusoid Waveform</span></a>.</p>
<figure class="align-center" id="id100">
<span id="blocks-sine"></span><img alt="Reconstructed Sinusoid Waveform" src="../../../_images/sine.png" />
<figcaption>
<p><span class="caption-number">Fig. 812 </span><span class="caption-text">Reconstructed Sinusoid Waveform</span><a class="headerlink" href="#id100" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Notice on the bottom plot the harmonics are much more suppressed.</p>
<p>Generating the sine waveform uses <strong>floats</strong>. This requires much more code.
You can look in <cite>/tmp/vsx-examples/sine.pru0.map</cite> to see how much memory is being used.
<a class="reference internal" href="#blocks-sine-map"><span class="std std-ref">/tmp/vsx-examples/sine.pru0.map for Sine Wave</span></a> shows the first few lines for the sine wave.</p>
<div class="literal-block-wrapper docutils container" id="id101">
<span id="blocks-sine-map"></span><div class="code-block-caption"><span class="caption-number">Listing 120 </span><span class="caption-text">/tmp/vsx-examples/sine.pru0.map for Sine Wave</span><a class="headerlink" href="#id101" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="o">******************************************************************************</span>
<span class="linenos">  2</span><span class="n">PRU</span><span class="w"> </span><span class="n">Linker</span><span class="w"> </span><span class="n">Unix</span><span class="w"> </span><span class="n">v2</span><span class="mf">.1.5</span><span class="w">                    </span>
<span class="linenos">  3</span><span class="o">******************************************************************************</span>
<span class="linenos">  4</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Linked</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Jun</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="mi">13</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">08</span><span class="w"> </span><span class="mi">2018</span>
<span class="linenos">  5</span>
<span class="linenos">  6</span><span class="n">OUTPUT</span><span class="w"> </span><span class="kt">FILE</span><span class="w"> </span><span class="n">NAME</span><span class="o">:</span><span class="w">   </span><span class="o">&lt;/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pru0</span><span class="o">-</span><span class="n">gen</span><span class="o">/</span><span class="n">sine1</span><span class="p">.</span><span class="n">out</span><span class="o">&gt;</span>
<span class="linenos">  7</span><span class="n">ENTRY</span><span class="w"> </span><span class="n">POINT</span><span class="w"> </span><span class="n">SYMBOL</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;_c_int00_noinit_noargs_noexit&quot;</span><span class="w">  </span><span class="n">address</span><span class="o">:</span><span class="w"> </span><span class="mo">00000000</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="n">MEMORY</span><span class="w"> </span><span class="n">CONFIGURATION</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="w">         </span><span class="n">name</span><span class="w">            </span><span class="n">origin</span><span class="w">    </span><span class="n">length</span><span class="w">      </span><span class="n">used</span><span class="w">     </span><span class="n">unused</span><span class="w">   </span><span class="n">attr</span><span class="w">    </span><span class="n">fill</span>
<span class="linenos"> 13</span><span class="o">----------------------</span><span class="w">  </span><span class="o">--------</span><span class="w">  </span><span class="o">---------</span><span class="w">  </span><span class="o">--------</span><span class="w">  </span><span class="o">--------</span><span class="w">  </span><span class="o">----</span><span class="w">  </span><span class="o">--------</span>
<span class="linenos"> 14</span><span class="n">PAGE</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span>
<span class="linenos"> 15</span><span class="w">  </span><span class="n">PRU_IMEM</span><span class="w">              </span><span class="mo">00000000</span><span class="w">   </span><span class="mo">00002000</span><span class="w">  </span><span class="mo">00001</span><span class="mi">8</span><span class="n">c0</span><span class="w">  </span><span class="mo">00000740</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="n">PAGE</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span>
<span class="linenos"> 18</span><span class="w">  </span><span class="n">PRU_DMEM_0_1</span><span class="w">          </span><span class="mo">00000000</span><span class="w">   </span><span class="mo">00002000</span><span class="w">  </span><span class="mo">00000154</span><span class="w">  </span><span class="mo">00001</span><span class="n">eac</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 19</span><span class="w">  </span><span class="n">PRU_DMEM_1_0</span><span class="w">          </span><span class="mo">00002000</span><span class="w">   </span><span class="mo">00002000</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00002000</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="n">PAGE</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span>
<span class="linenos"> 22</span><span class="w">  </span><span class="n">PRU_SHAREDMEM</span><span class="w">         </span><span class="mo">00010000</span><span class="w">   </span><span class="mo">00003000</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00003000</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 23</span><span class="w">  </span><span class="n">PRU_INTC</span><span class="w">              </span><span class="mo">00020000</span><span class="w">   </span><span class="mo">00001504</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00001504</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 24</span><span class="w">  </span><span class="n">PRU_CFG</span><span class="w">               </span><span class="mo">00026000</span><span class="w">   </span><span class="mo">00000044</span><span class="w">  </span><span class="mo">00000044</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 25</span><span class="w">  </span><span class="n">PRU_UART</span><span class="w">              </span><span class="mo">0002</span><span class="mi">8000</span><span class="w">   </span><span class="mo">0000003</span><span class="mi">8</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">0000003</span><span class="mi">8</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 26</span><span class="w">  </span><span class="n">PRU_IEP</span><span class="w">               </span><span class="mf">0002e000</span><span class="w">   </span><span class="mo">0000031</span><span class="n">c</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">0000031</span><span class="n">c</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 27</span><span class="w">  </span><span class="n">PRU_ECAP</span><span class="w">              </span><span class="mo">00030000</span><span class="w">   </span><span class="mo">00000060</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000060</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 28</span><span class="w">  </span><span class="n">RSVD27</span><span class="w">                </span><span class="mo">00032000</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000100</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 29</span><span class="w">  </span><span class="n">RSVD21</span><span class="w">                </span><span class="mo">00032400</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000100</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 30</span><span class="w">  </span><span class="n">L3OCMC</span><span class="w">                </span><span class="mi">40000000</span><span class="w">   </span><span class="mo">00010000</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00010000</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 31</span><span class="w">  </span><span class="n">MCASP0_DMA</span><span class="w">            </span><span class="mi">46000000</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000100</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 32</span><span class="w">  </span><span class="n">UART1</span><span class="w">                 </span><span class="mi">48022000</span><span class="w">   </span><span class="mo">000000</span><span class="mi">88</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000000</span><span class="mi">88</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 33</span><span class="w">  </span><span class="n">UART2</span><span class="w">                 </span><span class="mi">48024000</span><span class="w">   </span><span class="mo">000000</span><span class="mi">88</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000000</span><span class="mi">88</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 34</span><span class="w">  </span><span class="n">I2C1</span><span class="w">                  </span><span class="mi">4802</span><span class="n">a000</span><span class="w">   </span><span class="mo">000000</span><span class="n">d8</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000000</span><span class="n">d8</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 35</span><span class="w">  </span><span class="n">MCSPI0</span><span class="w">                </span><span class="mi">48030000</span><span class="w">   </span><span class="mo">000001</span><span class="n">a4</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000001</span><span class="n">a4</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 36</span><span class="w">  </span><span class="n">DMTIMER2</span><span class="w">              </span><span class="mi">48040000</span><span class="w">   </span><span class="mo">0000005</span><span class="n">c</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">0000005</span><span class="n">c</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 37</span><span class="w">  </span><span class="n">MMCHS0</span><span class="w">                </span><span class="mi">48060000</span><span class="w">   </span><span class="mo">00000300</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000300</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 38</span><span class="w">  </span><span class="n">MBX0</span><span class="w">                  </span><span class="mi">480</span><span class="n">c8000</span><span class="w">   </span><span class="mo">00000140</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000140</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 39</span><span class="w">  </span><span class="n">SPINLOCK</span><span class="w">              </span><span class="mi">480</span><span class="n">ca000</span><span class="w">   </span><span class="mo">00000</span><span class="mi">880</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000</span><span class="mi">880</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 40</span><span class="w">  </span><span class="n">I2C2</span><span class="w">                  </span><span class="mi">4819</span><span class="n">c000</span><span class="w">   </span><span class="mo">000000</span><span class="n">d8</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000000</span><span class="n">d8</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 41</span><span class="w">  </span><span class="n">MCSPI1</span><span class="w">                </span><span class="mi">481</span><span class="n">a0000</span><span class="w">   </span><span class="mo">000001</span><span class="n">a4</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000001</span><span class="n">a4</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 42</span><span class="w">  </span><span class="n">DCAN0</span><span class="w">                 </span><span class="mi">481</span><span class="n">cc000</span><span class="w">   </span><span class="mf">000001e8</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mf">000001e8</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 43</span><span class="w">  </span><span class="n">DCAN1</span><span class="w">                 </span><span class="mi">481</span><span class="n">d0000</span><span class="w">   </span><span class="mf">000001e8</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mf">000001e8</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 44</span><span class="w">  </span><span class="n">PWMSS0</span><span class="w">                </span><span class="mi">48300000</span><span class="w">   </span><span class="mo">000002</span><span class="n">c4</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000002</span><span class="n">c4</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 45</span><span class="w">  </span><span class="n">PWMSS1</span><span class="w">                </span><span class="mi">48302000</span><span class="w">   </span><span class="mo">000002</span><span class="n">c4</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000002</span><span class="n">c4</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 46</span><span class="w">  </span><span class="n">PWMSS2</span><span class="w">                </span><span class="mi">48304000</span><span class="w">   </span><span class="mo">000002</span><span class="n">c4</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000002</span><span class="n">c4</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 47</span><span class="w">  </span><span class="n">RSVD13</span><span class="w">                </span><span class="mi">48310000</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000100</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 48</span><span class="w">  </span><span class="n">RSVD10</span><span class="w">                </span><span class="mi">48318000</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000100</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 49</span><span class="w">  </span><span class="n">TPCC</span><span class="w">                  </span><span class="mi">49000000</span><span class="w">   </span><span class="mo">000010</span><span class="mi">98</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000010</span><span class="mi">98</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 50</span><span class="w">  </span><span class="n">GEMAC</span><span class="w">                 </span><span class="mi">4</span><span class="n">a100000</span><span class="w">   </span><span class="mo">000012</span><span class="mi">8</span><span class="n">c</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">000012</span><span class="mi">8</span><span class="n">c</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 51</span><span class="w">  </span><span class="n">DDR</span><span class="w">                   </span><span class="mi">80000000</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="mo">00000000</span><span class="w">  </span><span class="mo">00000100</span><span class="w">  </span><span class="n">RWIX</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="n">SECTION</span><span class="w"> </span><span class="n">ALLOCATION</span><span class="w"> </span><span class="n">MAP</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="w"> </span><span class="n">output</span><span class="w">                                  </span><span class="n">attributes</span><span class="o">/</span>
<span class="linenos"> 57</span><span class="n">section</span><span class="w">   </span><span class="n">page</span><span class="w">    </span><span class="n">origin</span><span class="w">      </span><span class="n">length</span><span class="w">       </span><span class="n">input</span><span class="w"> </span><span class="n">sections</span>
<span class="linenos"> 58</span><span class="o">--------</span><span class="w">  </span><span class="o">----</span><span class="w">  </span><span class="o">----------</span><span class="w">  </span><span class="o">----------</span><span class="w">   </span><span class="o">----------------</span>
<span class="linenos"> 59</span><span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="n">_c_int00</span><span class="o">*</span><span class="w"> </span>
<span class="linenos"> 60</span><span class="o">*</span><span class="w">          </span><span class="mi">0</span><span class="w">    </span><span class="mo">00000000</span><span class="w">    </span><span class="mo">00000014</span><span class="w">     </span>
<span class="linenos"> 61</span><span class="w">                  </span><span class="mo">00000000</span><span class="w">    </span><span class="mo">00000014</span><span class="w">     </span><span class="n">rtspruv3_le</span><span class="p">.</span><span class="n">lib</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">boot_special</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">_c_int00_noinit_noargs_noexit</span><span class="p">)</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="p">.</span><span class="n">text</span><span class="w">      </span><span class="mi">0</span><span class="w">    </span><span class="mo">00000014</span><span class="w">    </span><span class="mo">00001</span><span class="mi">8</span><span class="n">ac</span><span class="w">     </span>
<span class="linenos"> 64</span><span class="w">                  </span><span class="mo">00000014</span><span class="w">    </span><span class="mo">00000374</span><span class="w">     </span><span class="n">rtspruv3_le</span><span class="p">.</span><span class="n">lib</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sin</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">sin</span><span class="p">)</span>
<span class="linenos"> 65</span><span class="w">                  </span><span class="mo">000003</span><span class="mi">88</span><span class="w">    </span><span class="mo">00000314</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">frcmpyd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__TI_frcmpyd</span><span class="p">)</span>
<span class="linenos"> 66</span><span class="w">                  </span><span class="mo">000006</span><span class="mi">9</span><span class="n">c</span><span class="w">    </span><span class="mo">0000025</span><span class="mi">8</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">frcaddd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__TI_frcaddd</span><span class="p">)</span>
<span class="linenos"> 67</span><span class="w">                  </span><span class="mf">000008f</span><span class="mi">4</span><span class="w">    </span><span class="mo">00000254</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">mpyd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_mpyd</span><span class="p">)</span>
<span class="linenos"> 68</span><span class="w">                  </span><span class="mo">00000</span><span class="n">b48</span><span class="w">    </span><span class="mo">0000024</span><span class="mi">8</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">addd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_addd</span><span class="p">)</span>
<span class="linenos"> 69</span><span class="w">                  </span><span class="mo">00000</span><span class="n">d90</span><span class="w">    </span><span class="mo">000001</span><span class="n">c8</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">mpyf</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_mpyf</span><span class="p">)</span>
<span class="linenos"> 70</span><span class="w">                  </span><span class="mf">00000f</span><span class="mi">58</span><span class="w">    </span><span class="mo">00000100</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">modf</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">modf</span><span class="p">)</span>
<span class="linenos"> 71</span><span class="w">                  </span><span class="mo">0000105</span><span class="mi">8</span><span class="w">    </span><span class="mo">000000</span><span class="n">b4</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">gtd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_gtd</span><span class="p">)</span>
<span class="linenos"> 72</span><span class="w">                  </span><span class="mo">0000110</span><span class="n">c</span><span class="w">    </span><span class="mo">000000</span><span class="n">b0</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">ged</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_ged</span><span class="p">)</span>
<span class="linenos"> 73</span><span class="w">                  </span><span class="mo">000011</span><span class="n">bc</span><span class="w">    </span><span class="mo">000000</span><span class="n">b0</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">ltd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_ltd</span><span class="p">)</span>
<span class="linenos"> 74</span><span class="w">                  </span><span class="mo">0000126</span><span class="n">c</span><span class="w">    </span><span class="mo">000000</span><span class="n">b0</span><span class="w">     </span><span class="n">sine1</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">main</span><span class="p">)</span>
<span class="linenos"> 75</span><span class="w">                  </span><span class="mo">0000131</span><span class="n">c</span><span class="w">    </span><span class="mo">000000</span><span class="n">a8</span><span class="w">     </span><span class="n">rtspruv3_le</span><span class="p">.</span><span class="n">lib</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">frcmpyf</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__TI_frcmpyf</span><span class="p">)</span>
<span class="linenos"> 76</span><span class="w">                  </span><span class="mo">000013</span><span class="n">c4</span><span class="w">    </span><span class="mo">000000</span><span class="n">a0</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">fixdu</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_fixdu</span><span class="p">)</span>
<span class="linenos"> 77</span><span class="w">                  </span><span class="mo">00001464</span><span class="w">    </span><span class="mo">000000</span><span class="mi">9</span><span class="n">c</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">round</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_nround</span><span class="p">)</span>
<span class="linenos"> 78</span><span class="w">                  </span><span class="mo">00001500</span><span class="w">    </span><span class="mo">000000</span><span class="mi">90</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">eqld</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_eqd</span><span class="p">)</span>
<span class="linenos"> 79</span><span class="w">                  </span><span class="mo">000015</span><span class="mi">90</span><span class="w">    </span><span class="mo">000000</span><span class="mi">8</span><span class="n">c</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">renormd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__TI_renormd</span><span class="p">)</span>
<span class="linenos"> 80</span><span class="w">                  </span><span class="mo">0000161</span><span class="n">c</span><span class="w">    </span><span class="mo">000000</span><span class="mi">8</span><span class="n">c</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">fixdi</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_fixdi</span><span class="p">)</span>
<span class="linenos"> 81</span><span class="w">                  </span><span class="mo">000016</span><span class="n">a8</span><span class="w">    </span><span class="mo">000000</span><span class="mi">84</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">fltid</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_fltid</span><span class="p">)</span>
<span class="linenos"> 82</span><span class="w">                  </span><span class="mo">0000172</span><span class="n">c</span><span class="w">    </span><span class="mo">0000007</span><span class="mi">8</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">cvtfd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_cvtfd</span><span class="p">)</span>
<span class="linenos"> 83</span><span class="w">                  </span><span class="mo">000017</span><span class="n">a4</span><span class="w">    </span><span class="mo">00000050</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">fltuf</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_fltuf</span><span class="p">)</span>
<span class="linenos"> 84</span><span class="w">                  </span><span class="mf">000017f</span><span class="mi">4</span><span class="w">    </span><span class="mo">0000002</span><span class="n">c</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">asri</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_asri</span><span class="p">)</span>
<span class="linenos"> 85</span><span class="w">                  </span><span class="mo">00001</span><span class="mi">820</span><span class="w">    </span><span class="mo">0000002</span><span class="n">c</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">subd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_subd</span><span class="p">)</span>
<span class="linenos"> 86</span><span class="w">                  </span><span class="mo">00001</span><span class="mi">84</span><span class="n">c</span><span class="w">    </span><span class="mo">00000024</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">mpyi</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_mpyi</span><span class="p">)</span>
<span class="linenos"> 87</span><span class="w">                  </span><span class="mo">00001</span><span class="mi">870</span><span class="w">    </span><span class="mo">00000020</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">negd</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_negd</span><span class="p">)</span>
<span class="linenos"> 88</span><span class="w">                  </span><span class="mo">00001</span><span class="mi">890</span><span class="w">    </span><span class="mo">00000020</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">trunc</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">__pruabi_trunc</span><span class="p">)</span>
<span class="linenos"> 89</span><span class="w">                  </span><span class="mo">00001</span><span class="mi">8</span><span class="n">b0</span><span class="w">    </span><span class="mo">0000000</span><span class="mi">8</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">exit</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">abort</span><span class="p">)</span>
<span class="linenos"> 90</span><span class="w">                  </span><span class="mo">00001</span><span class="mi">8</span><span class="n">b8</span><span class="w">    </span><span class="mo">0000000</span><span class="mi">8</span><span class="w">                     </span><span class="o">:</span><span class="w"> </span><span class="n">exit</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">text</span><span class="o">:</span><span class="n">loader_exit</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="p">.</span><span class="n">stack</span><span class="w">     </span><span class="mi">1</span><span class="w">    </span><span class="mo">00000000</span><span class="w">    </span><span class="mo">00000100</span><span class="w">     </span><span class="n">UNINITIALIZED</span>
<span class="linenos"> 93</span><span class="w">                  </span><span class="mo">00000000</span><span class="w">    </span><span class="mo">00000004</span><span class="w">     </span><span class="n">rtspruv3_le</span><span class="p">.</span><span class="n">lib</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">boot</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">stack</span><span class="p">)</span>
<span class="linenos"> 94</span><span class="w">                  </span><span class="mo">00000004</span><span class="w">    </span><span class="mf">000000f</span><span class="n">c</span><span class="w">     </span><span class="o">--</span><span class="n">HOLE</span><span class="o">--</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="p">.</span><span class="n">cinit</span><span class="w">     </span><span class="mi">1</span><span class="w">    </span><span class="mo">00000000</span><span class="w">    </span><span class="mo">00000000</span><span class="w">     </span><span class="n">UNINITIALIZED</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="p">.</span><span class="n">fardata</span><span class="w">   </span><span class="mi">1</span><span class="w">    </span><span class="mo">00000100</span><span class="w">    </span><span class="mo">00000040</span><span class="w">     </span>
<span class="linenos"> 99</span><span class="w">                  </span><span class="mo">00000100</span><span class="w">    </span><span class="mo">00000040</span><span class="w">     </span><span class="n">rtspruv3_le</span><span class="p">.</span><span class="n">lib</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">sin</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">fardata</span><span class="o">:</span><span class="n">R$1</span><span class="p">)</span>
<span class="linenos">100</span>
<span class="linenos">101</span><span class="p">.</span><span class="n">resource_table</span><span class="w"> </span>
<span class="linenos">102</span><span class="o">*</span><span class="w">          </span><span class="mi">1</span><span class="w">    </span><span class="mo">00000140</span><span class="w">    </span><span class="mo">00000014</span><span class="w">     </span>
<span class="linenos">103</span><span class="w">                  </span><span class="mo">00000140</span><span class="w">    </span><span class="mo">00000014</span><span class="w">     </span><span class="n">sine1</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">resource_table</span><span class="o">:</span><span class="n">retain</span><span class="p">)</span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="p">.</span><span class="n">creg</span><span class="p">.</span><span class="n">PRU_CFG</span><span class="p">.</span><span class="n">noload</span><span class="p">.</span><span class="n">near</span><span class="w"> </span>
<span class="linenos">106</span><span class="o">*</span><span class="w">          </span><span class="mi">2</span><span class="w">    </span><span class="mo">00026000</span><span class="w">    </span><span class="mo">00000044</span><span class="w">     </span><span class="n">NOLOAD</span><span class="w"> </span><span class="n">SECTION</span>
<span class="linenos">107</span><span class="w">                  </span><span class="mo">00026000</span><span class="w">    </span><span class="mo">00000044</span><span class="w">     </span><span class="n">sine1</span><span class="p">.</span><span class="n">obj</span><span class="w"> </span><span class="p">(.</span><span class="n">creg</span><span class="p">.</span><span class="n">PRU_CFG</span><span class="p">.</span><span class="n">noload</span><span class="p">.</span><span class="n">near</span><span class="p">)</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="p">.</span><span class="n">creg</span><span class="p">.</span><span class="n">PRU_CFG</span><span class="p">.</span><span class="n">near</span><span class="w"> </span>
<span class="linenos">110</span><span class="o">*</span><span class="w">          </span><span class="mi">2</span><span class="w">    </span><span class="mo">00026044</span><span class="w">    </span><span class="mo">00000000</span><span class="w">     </span><span class="n">UNINITIALIZED</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="p">.</span><span class="n">creg</span><span class="p">.</span><span class="n">PRU_CFG</span><span class="p">.</span><span class="n">noload</span><span class="p">.</span><span class="n">far</span><span class="w"> </span>
<span class="linenos">113</span><span class="o">*</span><span class="w">          </span><span class="mi">2</span><span class="w">    </span><span class="mo">00026044</span><span class="w">    </span><span class="mo">00000000</span><span class="w">     </span><span class="n">NOLOAD</span><span class="w"> </span><span class="n">SECTION</span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="p">.</span><span class="n">creg</span><span class="p">.</span><span class="n">PRU_CFG</span><span class="p">.</span><span class="n">far</span><span class="w"> </span>
<span class="linenos">116</span><span class="o">*</span><span class="w">          </span><span class="mi">2</span><span class="w">    </span><span class="mo">00026044</span><span class="w">    </span><span class="mo">00000000</span><span class="w">     </span><span class="n">UNINITIALIZED</span>
<span class="linenos">117</span>
<span class="linenos">118</span>
<span class="linenos">119</span><span class="n">SEGMENT</span><span class="w"> </span><span class="n">ATTRIBUTES</span>
<span class="linenos">120</span>
<span class="linenos">121</span><span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">tag</span><span class="w">      </span><span class="n">seg</span><span class="w"> </span><span class="n">value</span>
<span class="linenos">122</span><span class="w">    </span><span class="o">--</span><span class="w"> </span><span class="o">---</span><span class="w">      </span><span class="o">---</span><span class="w"> </span><span class="o">-----</span>
<span class="linenos">123</span><span class="w">     </span><span class="mi">0</span><span class="w"> </span><span class="n">PHA_PAGE</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="mi">1</span><span class="w">    </span>
<span class="linenos">124</span><span class="w">     </span><span class="mi">1</span><span class="w"> </span><span class="n">PHA_PAGE</span><span class="w"> </span><span class="mi">2</span><span class="w">   </span><span class="mi">1</span><span class="w">    </span>
<span class="linenos">125</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">SYMBOLS</span><span class="o">:</span><span class="w"> </span><span class="n">SORTED</span><span class="w"> </span><span class="n">ALPHABETICALLY</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span>
<span class="linenos">128</span>
<span class="linenos">129</span><span class="n">page</span><span class="w">  </span><span class="n">address</span><span class="w">   </span><span class="n">name</span><span class="w">                         </span>
<span class="linenos">130</span><span class="o">----</span><span class="w">  </span><span class="o">-------</span><span class="w">   </span><span class="o">----</span><span class="w">                         </span>
<span class="linenos">131</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">8</span><span class="n">b8</span><span class="w">  </span><span class="n">C$$EXIT</span><span class="w">                      </span>
<span class="linenos">132</span><span class="mi">2</span><span class="w">     </span><span class="mo">00026000</span><span class="w">  </span><span class="n">CT_CFG</span><span class="w">                       </span>
<span class="linenos">133</span><span class="n">abs</span><span class="w">   </span><span class="mi">481</span><span class="n">cc000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DCAN0</span><span class="w">        </span>
<span class="linenos">134</span><span class="n">abs</span><span class="w">   </span><span class="mi">481</span><span class="n">d0000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DCAN1</span><span class="w">        </span>
<span class="linenos">135</span><span class="n">abs</span><span class="w">   </span><span class="mi">80000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DDR</span><span class="w">          </span>
<span class="linenos">136</span><span class="n">abs</span><span class="w">   </span><span class="mi">48040000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DMTIMER2</span><span class="w">     </span>
<span class="linenos">137</span><span class="n">abs</span><span class="w">   </span><span class="mi">4</span><span class="n">a100000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_GEMAC</span><span class="w">        </span>
<span class="linenos">138</span><span class="n">abs</span><span class="w">   </span><span class="mi">4802</span><span class="n">a000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_I2C1</span><span class="w">         </span>
<span class="linenos">139</span><span class="n">abs</span><span class="w">   </span><span class="mi">4819</span><span class="n">c000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_I2C2</span><span class="w">         </span>
<span class="linenos">140</span><span class="n">abs</span><span class="w">   </span><span class="mi">40000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_L3OCMC</span><span class="w">       </span>
<span class="linenos">141</span><span class="n">abs</span><span class="w">   </span><span class="mi">480</span><span class="n">c8000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MBX0</span><span class="w">         </span>
<span class="linenos">142</span><span class="n">abs</span><span class="w">   </span><span class="mi">46000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MCASP0_DMA</span><span class="w">   </span>
<span class="linenos">143</span><span class="n">abs</span><span class="w">   </span><span class="mi">48030000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MCSPI0</span><span class="w">       </span>
<span class="linenos">144</span><span class="n">abs</span><span class="w">   </span><span class="mi">481</span><span class="n">a0000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MCSPI1</span><span class="w">       </span>
<span class="linenos">145</span><span class="n">abs</span><span class="w">   </span><span class="mi">48060000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MMCHS0</span><span class="w">       </span>
<span class="linenos">146</span><span class="n">abs</span><span class="w">   </span><span class="mo">00026000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_CFG</span><span class="w">      </span>
<span class="linenos">147</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_DMEM_0_1</span><span class="w"> </span>
<span class="linenos">148</span><span class="n">abs</span><span class="w">   </span><span class="mo">00002000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_DMEM_1_0</span><span class="w"> </span>
<span class="linenos">149</span><span class="n">abs</span><span class="w">   </span><span class="mo">00030000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_ECAP</span><span class="w">     </span>
<span class="linenos">150</span><span class="n">abs</span><span class="w">   </span><span class="mf">0002e000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_IEP</span><span class="w">      </span>
<span class="linenos">151</span><span class="n">abs</span><span class="w">   </span><span class="mo">00020000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_INTC</span><span class="w">     </span>
<span class="linenos">152</span><span class="n">abs</span><span class="w">   </span><span class="mo">00010000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_SHAREDMEM</span>
<span class="linenos">153</span><span class="n">abs</span><span class="w">   </span><span class="mo">0002</span><span class="mi">8000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_UART</span><span class="w">     </span>
<span class="linenos">154</span><span class="n">abs</span><span class="w">   </span><span class="mi">48300000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PWMSS0</span><span class="w">       </span>
<span class="linenos">155</span><span class="n">abs</span><span class="w">   </span><span class="mi">48302000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PWMSS1</span><span class="w">       </span>
<span class="linenos">156</span><span class="n">abs</span><span class="w">   </span><span class="mi">48304000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PWMSS2</span><span class="w">       </span>
<span class="linenos">157</span><span class="n">abs</span><span class="w">   </span><span class="mi">48318000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD10</span><span class="w">       </span>
<span class="linenos">158</span><span class="n">abs</span><span class="w">   </span><span class="mi">48310000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD13</span><span class="w">       </span>
<span class="linenos">159</span><span class="n">abs</span><span class="w">   </span><span class="mo">00032400</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD21</span><span class="w">       </span>
<span class="linenos">160</span><span class="n">abs</span><span class="w">   </span><span class="mo">00032000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD27</span><span class="w">       </span>
<span class="linenos">161</span><span class="n">abs</span><span class="w">   </span><span class="mi">480</span><span class="n">ca000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_SPINLOCK</span><span class="w">     </span>
<span class="linenos">162</span><span class="n">abs</span><span class="w">   </span><span class="mi">49000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_TPCC</span><span class="w">         </span>
<span class="linenos">163</span><span class="n">abs</span><span class="w">   </span><span class="mi">48022000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_UART1</span><span class="w">        </span>
<span class="linenos">164</span><span class="n">abs</span><span class="w">   </span><span class="mi">48024000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_UART2</span><span class="w">        </span>
<span class="linenos">165</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">e</span><span class="w">  </span><span class="n">__PRU_CREG_DCAN0</span><span class="w">             </span>
<span class="linenos">166</span><span class="n">abs</span><span class="w">   </span><span class="mf">0000000f</span><span class="w">  </span><span class="n">__PRU_CREG_DCAN1</span><span class="w">             </span>
<span class="linenos">167</span><span class="n">abs</span><span class="w">   </span><span class="mf">0000001f</span><span class="w">  </span><span class="n">__PRU_CREG_DDR</span><span class="w">               </span>
<span class="linenos">168</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000001</span><span class="w">  </span><span class="n">__PRU_CREG_DMTIMER2</span><span class="w">          </span>
<span class="linenos">169</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="mi">9</span><span class="w">  </span><span class="n">__PRU_CREG_GEMAC</span><span class="w">             </span>
<span class="linenos">170</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000002</span><span class="w">  </span><span class="n">__PRU_CREG_I2C1</span><span class="w">              </span>
<span class="linenos">171</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000011</span><span class="w">  </span><span class="n">__PRU_CREG_I2C2</span><span class="w">              </span>
<span class="linenos">172</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">e</span><span class="w">  </span><span class="n">__PRU_CREG_L3OCMC</span><span class="w">            </span>
<span class="linenos">173</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000016</span><span class="w">  </span><span class="n">__PRU_CREG_MBX0</span><span class="w">              </span>
<span class="linenos">174</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="mi">8</span><span class="w">  </span><span class="n">__PRU_CREG_MCASP0_DMA</span><span class="w">        </span>
<span class="linenos">175</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000006</span><span class="w">  </span><span class="n">__PRU_CREG_MCSPI0</span><span class="w">            </span>
<span class="linenos">176</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000010</span><span class="w">  </span><span class="n">__PRU_CREG_MCSPI1</span><span class="w">            </span>
<span class="linenos">177</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000005</span><span class="w">  </span><span class="n">__PRU_CREG_MMCHS0</span><span class="w">            </span>
<span class="linenos">178</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000004</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_CFG</span><span class="w">           </span>
<span class="linenos">179</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="mi">8</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_DMEM_0_1</span><span class="w">      </span>
<span class="linenos">180</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="mi">9</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_DMEM_1_0</span><span class="w">      </span>
<span class="linenos">181</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000003</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_ECAP</span><span class="w">          </span>
<span class="linenos">182</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">a</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_IEP</span><span class="w">           </span>
<span class="linenos">183</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000000</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_INTC</span><span class="w">          </span>
<span class="linenos">184</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">c</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_SHAREDMEM</span><span class="w">     </span>
<span class="linenos">185</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000007</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_UART</span><span class="w">          </span>
<span class="linenos">186</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000012</span><span class="w">  </span><span class="n">__PRU_CREG_PWMSS0</span><span class="w">            </span>
<span class="linenos">187</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000013</span><span class="w">  </span><span class="n">__PRU_CREG_PWMSS1</span><span class="w">            </span>
<span class="linenos">188</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000014</span><span class="w">  </span><span class="n">__PRU_CREG_PWMSS2</span><span class="w">            </span>
<span class="linenos">189</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">a</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD10</span><span class="w">            </span>
<span class="linenos">190</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">d</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD13</span><span class="w">            </span>
<span class="linenos">191</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000015</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD21</span><span class="w">            </span>
<span class="linenos">192</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">b</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD27</span><span class="w">            </span>
<span class="linenos">193</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000017</span><span class="w">  </span><span class="n">__PRU_CREG_SPINLOCK</span><span class="w">          </span>
<span class="linenos">194</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">d</span><span class="w">  </span><span class="n">__PRU_CREG_TPCC</span><span class="w">              </span>
<span class="linenos">195</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">b</span><span class="w">  </span><span class="n">__PRU_CREG_UART1</span><span class="w">             </span>
<span class="linenos">196</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">c</span><span class="w">  </span><span class="n">__PRU_CREG_UART2</span><span class="w">             </span>
<span class="linenos">197</span><span class="mi">1</span><span class="w">     </span><span class="mo">00000100</span><span class="w">  </span><span class="n">__TI_STACK_END</span><span class="w">               </span>
<span class="linenos">198</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="n">__TI_STACK_SIZE</span><span class="w">              </span>
<span class="linenos">199</span><span class="mi">0</span><span class="w">     </span><span class="mo">000006</span><span class="mi">9</span><span class="n">c</span><span class="w">  </span><span class="n">__TI_frcaddd</span><span class="w">                 </span>
<span class="linenos">200</span><span class="mi">0</span><span class="w">     </span><span class="mo">000003</span><span class="mi">88</span><span class="w">  </span><span class="n">__TI_frcmpyd</span><span class="w">                 </span>
<span class="linenos">201</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000131</span><span class="n">c</span><span class="w">  </span><span class="n">__TI_frcmpyf</span><span class="w">                 </span>
<span class="linenos">202</span><span class="mi">0</span><span class="w">     </span><span class="mo">000015</span><span class="mi">90</span><span class="w">  </span><span class="n">__TI_renormd</span><span class="w">                 </span>
<span class="linenos">203</span><span class="n">abs</span><span class="w">   </span><span class="n">ffffffff</span><span class="w">  </span><span class="n">__binit__</span><span class="w">                    </span>
<span class="linenos">204</span><span class="n">abs</span><span class="w">   </span><span class="n">ffffffff</span><span class="w">  </span><span class="n">__c_args__</span><span class="w">                   </span>
<span class="linenos">205</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000</span><span class="n">b48</span><span class="w">  </span><span class="n">__pruabi_addd</span><span class="w">                </span>
<span class="linenos">206</span><span class="mi">0</span><span class="w">     </span><span class="mf">000017f</span><span class="mi">4</span><span class="w">  </span><span class="n">__pruabi_asri</span><span class="w">                </span>
<span class="linenos">207</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000172</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_cvtfd</span><span class="w">               </span>
<span class="linenos">208</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001500</span><span class="w">  </span><span class="n">__pruabi_eqd</span><span class="w">                 </span>
<span class="linenos">209</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000161</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_fixdi</span><span class="w">               </span>
<span class="linenos">210</span><span class="mi">0</span><span class="w">     </span><span class="mo">000013</span><span class="n">c4</span><span class="w">  </span><span class="n">__pruabi_fixdu</span><span class="w">               </span>
<span class="linenos">211</span><span class="mi">0</span><span class="w">     </span><span class="mo">000016</span><span class="n">a8</span><span class="w">  </span><span class="n">__pruabi_fltid</span><span class="w">               </span>
<span class="linenos">212</span><span class="mi">0</span><span class="w">     </span><span class="mo">000017</span><span class="n">a4</span><span class="w">  </span><span class="n">__pruabi_fltuf</span><span class="w">               </span>
<span class="linenos">213</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000110</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_ged</span><span class="w">                 </span>
<span class="linenos">214</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000105</span><span class="mi">8</span><span class="w">  </span><span class="n">__pruabi_gtd</span><span class="w">                 </span>
<span class="linenos">215</span><span class="mi">0</span><span class="w">     </span><span class="mo">000011</span><span class="n">bc</span><span class="w">  </span><span class="n">__pruabi_ltd</span><span class="w">                 </span>
<span class="linenos">216</span><span class="mi">0</span><span class="w">     </span><span class="mf">000008f</span><span class="mi">4</span><span class="w">  </span><span class="n">__pruabi_mpyd</span><span class="w">                </span>
<span class="linenos">217</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000</span><span class="n">d90</span><span class="w">  </span><span class="n">__pruabi_mpyf</span><span class="w">                </span>
<span class="linenos">218</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">84</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_mpyi</span><span class="w">                </span>
<span class="linenos">219</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">870</span><span class="w">  </span><span class="n">__pruabi_negd</span><span class="w">                </span>
<span class="linenos">220</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001464</span><span class="w">  </span><span class="n">__pruabi_nround</span><span class="w">              </span>
<span class="linenos">221</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">820</span><span class="w">  </span><span class="n">__pruabi_subd</span><span class="w">                </span>
<span class="linenos">222</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">890</span><span class="w">  </span><span class="n">__pruabi_trunc</span><span class="w">               </span>
<span class="linenos">223</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000000</span><span class="w">  </span><span class="n">_c_int00_noinit_noargs_noexit</span>
<span class="linenos">224</span><span class="mi">1</span><span class="w">     </span><span class="mo">00000000</span><span class="w">  </span><span class="n">_stack</span><span class="w">                       </span>
<span class="linenos">225</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">8</span><span class="n">b0</span><span class="w">  </span><span class="n">abort</span><span class="w">                        </span>
<span class="linenos">226</span><span class="n">abs</span><span class="w">   </span><span class="n">ffffffff</span><span class="w">  </span><span class="n">binit</span><span class="w">                        </span>
<span class="linenos">227</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000126</span><span class="n">c</span><span class="w">  </span><span class="n">main</span><span class="w">                         </span>
<span class="linenos">228</span><span class="mi">0</span><span class="w">     </span><span class="mf">00000f</span><span class="mi">58</span><span class="w">  </span><span class="n">modf</span><span class="w">                         </span>
<span class="linenos">229</span><span class="mi">1</span><span class="w">     </span><span class="mo">00000140</span><span class="w">  </span><span class="n">pru_remoteproc_ResourceTable</span><span class="w"> </span>
<span class="linenos">230</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000014</span><span class="w">  </span><span class="n">sin</span><span class="w">                          </span>
<span class="linenos">231</span>
<span class="linenos">232</span>
<span class="linenos">233</span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">SYMBOLS</span><span class="o">:</span><span class="w"> </span><span class="n">SORTED</span><span class="w"> </span><span class="n">BY</span><span class="w"> </span><span class="n">Symbol</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span>
<span class="linenos">234</span>
<span class="linenos">235</span><span class="n">page</span><span class="w">  </span><span class="n">address</span><span class="w">   </span><span class="n">name</span><span class="w">                         </span>
<span class="linenos">236</span><span class="o">----</span><span class="w">  </span><span class="o">-------</span><span class="w">   </span><span class="o">----</span><span class="w">                         </span>
<span class="linenos">237</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000000</span><span class="w">  </span><span class="n">_c_int00_noinit_noargs_noexit</span>
<span class="linenos">238</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000014</span><span class="w">  </span><span class="n">sin</span><span class="w">                          </span>
<span class="linenos">239</span><span class="mi">0</span><span class="w">     </span><span class="mo">000003</span><span class="mi">88</span><span class="w">  </span><span class="n">__TI_frcmpyd</span><span class="w">                 </span>
<span class="linenos">240</span><span class="mi">0</span><span class="w">     </span><span class="mo">000006</span><span class="mi">9</span><span class="n">c</span><span class="w">  </span><span class="n">__TI_frcaddd</span><span class="w">                 </span>
<span class="linenos">241</span><span class="mi">0</span><span class="w">     </span><span class="mf">000008f</span><span class="mi">4</span><span class="w">  </span><span class="n">__pruabi_mpyd</span><span class="w">                </span>
<span class="linenos">242</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000</span><span class="n">b48</span><span class="w">  </span><span class="n">__pruabi_addd</span><span class="w">                </span>
<span class="linenos">243</span><span class="mi">0</span><span class="w">     </span><span class="mo">00000</span><span class="n">d90</span><span class="w">  </span><span class="n">__pruabi_mpyf</span><span class="w">                </span>
<span class="linenos">244</span><span class="mi">0</span><span class="w">     </span><span class="mf">00000f</span><span class="mi">58</span><span class="w">  </span><span class="n">modf</span><span class="w">                         </span>
<span class="linenos">245</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000105</span><span class="mi">8</span><span class="w">  </span><span class="n">__pruabi_gtd</span><span class="w">                 </span>
<span class="linenos">246</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000110</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_ged</span><span class="w">                 </span>
<span class="linenos">247</span><span class="mi">0</span><span class="w">     </span><span class="mo">000011</span><span class="n">bc</span><span class="w">  </span><span class="n">__pruabi_ltd</span><span class="w">                 </span>
<span class="linenos">248</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000126</span><span class="n">c</span><span class="w">  </span><span class="n">main</span><span class="w">                         </span>
<span class="linenos">249</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000131</span><span class="n">c</span><span class="w">  </span><span class="n">__TI_frcmpyf</span><span class="w">                 </span>
<span class="linenos">250</span><span class="mi">0</span><span class="w">     </span><span class="mo">000013</span><span class="n">c4</span><span class="w">  </span><span class="n">__pruabi_fixdu</span><span class="w">               </span>
<span class="linenos">251</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001464</span><span class="w">  </span><span class="n">__pruabi_nround</span><span class="w">              </span>
<span class="linenos">252</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001500</span><span class="w">  </span><span class="n">__pruabi_eqd</span><span class="w">                 </span>
<span class="linenos">253</span><span class="mi">0</span><span class="w">     </span><span class="mo">000015</span><span class="mi">90</span><span class="w">  </span><span class="n">__TI_renormd</span><span class="w">                 </span>
<span class="linenos">254</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000161</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_fixdi</span><span class="w">               </span>
<span class="linenos">255</span><span class="mi">0</span><span class="w">     </span><span class="mo">000016</span><span class="n">a8</span><span class="w">  </span><span class="n">__pruabi_fltid</span><span class="w">               </span>
<span class="linenos">256</span><span class="mi">0</span><span class="w">     </span><span class="mo">0000172</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_cvtfd</span><span class="w">               </span>
<span class="linenos">257</span><span class="mi">0</span><span class="w">     </span><span class="mo">000017</span><span class="n">a4</span><span class="w">  </span><span class="n">__pruabi_fltuf</span><span class="w">               </span>
<span class="linenos">258</span><span class="mi">0</span><span class="w">     </span><span class="mf">000017f</span><span class="mi">4</span><span class="w">  </span><span class="n">__pruabi_asri</span><span class="w">                </span>
<span class="linenos">259</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">820</span><span class="w">  </span><span class="n">__pruabi_subd</span><span class="w">                </span>
<span class="linenos">260</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">84</span><span class="n">c</span><span class="w">  </span><span class="n">__pruabi_mpyi</span><span class="w">                </span>
<span class="linenos">261</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">870</span><span class="w">  </span><span class="n">__pruabi_negd</span><span class="w">                </span>
<span class="linenos">262</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">890</span><span class="w">  </span><span class="n">__pruabi_trunc</span><span class="w">               </span>
<span class="linenos">263</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">8</span><span class="n">b0</span><span class="w">  </span><span class="n">abort</span><span class="w">                        </span>
<span class="linenos">264</span><span class="mi">0</span><span class="w">     </span><span class="mo">00001</span><span class="mi">8</span><span class="n">b8</span><span class="w">  </span><span class="n">C$$EXIT</span><span class="w">                      </span>
<span class="linenos">265</span><span class="mi">1</span><span class="w">     </span><span class="mo">00000000</span><span class="w">  </span><span class="n">_stack</span><span class="w">                       </span>
<span class="linenos">266</span><span class="mi">1</span><span class="w">     </span><span class="mo">00000100</span><span class="w">  </span><span class="n">__TI_STACK_END</span><span class="w">               </span>
<span class="linenos">267</span><span class="mi">1</span><span class="w">     </span><span class="mo">00000140</span><span class="w">  </span><span class="n">pru_remoteproc_ResourceTable</span><span class="w"> </span>
<span class="linenos">268</span><span class="mi">2</span><span class="w">     </span><span class="mo">00026000</span><span class="w">  </span><span class="n">CT_CFG</span><span class="w">                       </span>
<span class="linenos">269</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_DMEM_0_1</span><span class="w"> </span>
<span class="linenos">270</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000000</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_INTC</span><span class="w">          </span>
<span class="linenos">271</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000001</span><span class="w">  </span><span class="n">__PRU_CREG_DMTIMER2</span><span class="w">          </span>
<span class="linenos">272</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000002</span><span class="w">  </span><span class="n">__PRU_CREG_I2C1</span><span class="w">              </span>
<span class="linenos">273</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000003</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_ECAP</span><span class="w">          </span>
<span class="linenos">274</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000004</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_CFG</span><span class="w">           </span>
<span class="linenos">275</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000005</span><span class="w">  </span><span class="n">__PRU_CREG_MMCHS0</span><span class="w">            </span>
<span class="linenos">276</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000006</span><span class="w">  </span><span class="n">__PRU_CREG_MCSPI0</span><span class="w">            </span>
<span class="linenos">277</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000007</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_UART</span><span class="w">          </span>
<span class="linenos">278</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="mi">8</span><span class="w">  </span><span class="n">__PRU_CREG_MCASP0_DMA</span><span class="w">        </span>
<span class="linenos">279</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="mi">9</span><span class="w">  </span><span class="n">__PRU_CREG_GEMAC</span><span class="w">             </span>
<span class="linenos">280</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">a</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD10</span><span class="w">            </span>
<span class="linenos">281</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">b</span><span class="w">  </span><span class="n">__PRU_CREG_UART1</span><span class="w">             </span>
<span class="linenos">282</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">c</span><span class="w">  </span><span class="n">__PRU_CREG_UART2</span><span class="w">             </span>
<span class="linenos">283</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">d</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD13</span><span class="w">            </span>
<span class="linenos">284</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000000</span><span class="n">e</span><span class="w">  </span><span class="n">__PRU_CREG_DCAN0</span><span class="w">             </span>
<span class="linenos">285</span><span class="n">abs</span><span class="w">   </span><span class="mf">0000000f</span><span class="w">  </span><span class="n">__PRU_CREG_DCAN1</span><span class="w">             </span>
<span class="linenos">286</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000010</span><span class="w">  </span><span class="n">__PRU_CREG_MCSPI1</span><span class="w">            </span>
<span class="linenos">287</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000011</span><span class="w">  </span><span class="n">__PRU_CREG_I2C2</span><span class="w">              </span>
<span class="linenos">288</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000012</span><span class="w">  </span><span class="n">__PRU_CREG_PWMSS0</span><span class="w">            </span>
<span class="linenos">289</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000013</span><span class="w">  </span><span class="n">__PRU_CREG_PWMSS1</span><span class="w">            </span>
<span class="linenos">290</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000014</span><span class="w">  </span><span class="n">__PRU_CREG_PWMSS2</span><span class="w">            </span>
<span class="linenos">291</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000015</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD21</span><span class="w">            </span>
<span class="linenos">292</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000016</span><span class="w">  </span><span class="n">__PRU_CREG_MBX0</span><span class="w">              </span>
<span class="linenos">293</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000017</span><span class="w">  </span><span class="n">__PRU_CREG_SPINLOCK</span><span class="w">          </span>
<span class="linenos">294</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="mi">8</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_DMEM_0_1</span><span class="w">      </span>
<span class="linenos">295</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="mi">9</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_DMEM_1_0</span><span class="w">      </span>
<span class="linenos">296</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">a</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_IEP</span><span class="w">           </span>
<span class="linenos">297</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">b</span><span class="w">  </span><span class="n">__PRU_CREG_RSVD27</span><span class="w">            </span>
<span class="linenos">298</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">c</span><span class="w">  </span><span class="n">__PRU_CREG_PRU_SHAREDMEM</span><span class="w">     </span>
<span class="linenos">299</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">d</span><span class="w">  </span><span class="n">__PRU_CREG_TPCC</span><span class="w">              </span>
<span class="linenos">300</span><span class="n">abs</span><span class="w">   </span><span class="mo">0000001</span><span class="n">e</span><span class="w">  </span><span class="n">__PRU_CREG_L3OCMC</span><span class="w">            </span>
<span class="linenos">301</span><span class="n">abs</span><span class="w">   </span><span class="mf">0000001f</span><span class="w">  </span><span class="n">__PRU_CREG_DDR</span><span class="w">               </span>
<span class="linenos">302</span><span class="n">abs</span><span class="w">   </span><span class="mo">00000100</span><span class="w">  </span><span class="n">__TI_STACK_SIZE</span><span class="w">              </span>
<span class="linenos">303</span><span class="n">abs</span><span class="w">   </span><span class="mo">00002000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_DMEM_1_0</span><span class="w"> </span>
<span class="linenos">304</span><span class="n">abs</span><span class="w">   </span><span class="mo">00010000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_SHAREDMEM</span>
<span class="linenos">305</span><span class="n">abs</span><span class="w">   </span><span class="mo">00020000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_INTC</span><span class="w">     </span>
<span class="linenos">306</span><span class="n">abs</span><span class="w">   </span><span class="mo">00026000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_CFG</span><span class="w">      </span>
<span class="linenos">307</span><span class="n">abs</span><span class="w">   </span><span class="mo">0002</span><span class="mi">8000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_UART</span><span class="w">     </span>
<span class="linenos">308</span><span class="n">abs</span><span class="w">   </span><span class="mf">0002e000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_IEP</span><span class="w">      </span>
<span class="linenos">309</span><span class="n">abs</span><span class="w">   </span><span class="mo">00030000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PRU_ECAP</span><span class="w">     </span>
<span class="linenos">310</span><span class="n">abs</span><span class="w">   </span><span class="mo">00032000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD27</span><span class="w">       </span>
<span class="linenos">311</span><span class="n">abs</span><span class="w">   </span><span class="mo">00032400</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD21</span><span class="w">       </span>
<span class="linenos">312</span><span class="n">abs</span><span class="w">   </span><span class="mi">40000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_L3OCMC</span><span class="w">       </span>
<span class="linenos">313</span><span class="n">abs</span><span class="w">   </span><span class="mi">46000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MCASP0_DMA</span><span class="w">   </span>
<span class="linenos">314</span><span class="n">abs</span><span class="w">   </span><span class="mi">48022000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_UART1</span><span class="w">        </span>
<span class="linenos">315</span><span class="n">abs</span><span class="w">   </span><span class="mi">48024000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_UART2</span><span class="w">        </span>
<span class="linenos">316</span><span class="n">abs</span><span class="w">   </span><span class="mi">4802</span><span class="n">a000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_I2C1</span><span class="w">         </span>
<span class="linenos">317</span><span class="n">abs</span><span class="w">   </span><span class="mi">48030000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MCSPI0</span><span class="w">       </span>
<span class="linenos">318</span><span class="n">abs</span><span class="w">   </span><span class="mi">48040000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DMTIMER2</span><span class="w">     </span>
<span class="linenos">319</span><span class="n">abs</span><span class="w">   </span><span class="mi">48060000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MMCHS0</span><span class="w">       </span>
<span class="linenos">320</span><span class="n">abs</span><span class="w">   </span><span class="mi">480</span><span class="n">c8000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MBX0</span><span class="w">         </span>
<span class="linenos">321</span><span class="n">abs</span><span class="w">   </span><span class="mi">480</span><span class="n">ca000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_SPINLOCK</span><span class="w">     </span>
<span class="linenos">322</span><span class="n">abs</span><span class="w">   </span><span class="mi">4819</span><span class="n">c000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_I2C2</span><span class="w">         </span>
<span class="linenos">323</span><span class="n">abs</span><span class="w">   </span><span class="mi">481</span><span class="n">a0000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_MCSPI1</span><span class="w">       </span>
<span class="linenos">324</span><span class="n">abs</span><span class="w">   </span><span class="mi">481</span><span class="n">cc000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DCAN0</span><span class="w">        </span>
<span class="linenos">325</span><span class="n">abs</span><span class="w">   </span><span class="mi">481</span><span class="n">d0000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DCAN1</span><span class="w">        </span>
<span class="linenos">326</span><span class="n">abs</span><span class="w">   </span><span class="mi">48300000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PWMSS0</span><span class="w">       </span>
<span class="linenos">327</span><span class="n">abs</span><span class="w">   </span><span class="mi">48302000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PWMSS1</span><span class="w">       </span>
<span class="linenos">328</span><span class="n">abs</span><span class="w">   </span><span class="mi">48304000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_PWMSS2</span><span class="w">       </span>
<span class="linenos">329</span><span class="n">abs</span><span class="w">   </span><span class="mi">48310000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD13</span><span class="w">       </span>
<span class="linenos">330</span><span class="n">abs</span><span class="w">   </span><span class="mi">48318000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_RSVD10</span><span class="w">       </span>
<span class="linenos">331</span><span class="n">abs</span><span class="w">   </span><span class="mi">49000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_TPCC</span><span class="w">         </span>
<span class="linenos">332</span><span class="n">abs</span><span class="w">   </span><span class="mi">4</span><span class="n">a100000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_GEMAC</span><span class="w">        </span>
<span class="linenos">333</span><span class="n">abs</span><span class="w">   </span><span class="mi">80000000</span><span class="w">  </span><span class="n">__PRU_CREG_BASE_DDR</span><span class="w">          </span>
<span class="linenos">334</span><span class="n">abs</span><span class="w">   </span><span class="n">ffffffff</span><span class="w">  </span><span class="n">__binit__</span><span class="w">                    </span>
<span class="linenos">335</span><span class="n">abs</span><span class="w">   </span><span class="n">ffffffff</span><span class="w">  </span><span class="n">__c_args__</span><span class="w">                   </span>
<span class="linenos">336</span><span class="n">abs</span><span class="w">   </span><span class="n">ffffffff</span><span class="w">  </span><span class="n">binit</span><span class="w">                        </span>
<span class="linenos">337</span>
<span class="linenos">338</span><span class="p">[</span><span class="mi">100</span><span class="w"> </span><span class="n">symbols</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/b11d678666e471acb6b06f6910edc7b4/sine.map"><code class="xref download docutils literal notranslate"><span class="pre">lines=1..22</span></code></a></p>
<p>Notice line 15 shows 0x18c0 bytes are being used for instructions.  That’s 6336
in decimal.</p>
<p>Now compile for the sawtooth and you see only 444 byes are used.  Floating-point
requires over 5K more bytes.  Use with care.  If you are short on instruction
space, you can move the table generation to the ARM and just copy the table
to the PRU.</p>
</section>
</section>
<section id="ws2812-neopixel-driver">
<span id="blocks-ws2812"></span><h2>WS2812 (NeoPixel) driver<a class="headerlink" href="#ws2812-neopixel-driver" title="Link to this heading">#</a></h2>
<section id="id34">
<h3>Problem<a class="headerlink" href="#id34" title="Link to this heading">#</a></h3>
<p>You have an <a class="reference external" href="http://www.adafruit.com/products/1138">Adafruit NeoPixel LED string</a>
or <a class="reference external" href="http://www.adafruit.com/products/1487">Adafruit NeoPixel LED matrix</a>
and want to light it up.</p>
</section>
<section id="id35">
<h3>Solution<a class="headerlink" href="#id35" title="Link to this heading">#</a></h3>
<p>NeoPixel is Adafruit’s name for the WS2812 Intelligent control LED.  Each
NeoPixel contains a Red, Green and Blue LED with a PWM controller that can
dim each one individually making a rainbow of colors possible.  The
NeoPixel is driven by a single serial line.  The timing on the line is very
sensesitive, which make the PRU a perfect candidate for driving it.</p>
<p>Wire the input to <code class="docutils literal notranslate"><span class="pre">P9_29</span></code> and power to 3.3V and ground to ground as shown in
<a class="reference internal" href="#blocks-neo-wiring"><span class="std std-ref">NeoPixel Wiring</span></a>.</p>
<figure class="align-center" id="id102">
<span id="blocks-neo-wiring"></span><img alt="NeoPixel Wiring" src="../../../_images/neo_bb1.png" />
<figcaption>
<p><span class="caption-number">Fig. 813 </span><span class="caption-text">NeoPixel Wiring</span><a class="headerlink" href="#id102" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Test your wiring with the simple code in <a class="reference internal" href="#blocks-neo1"><span class="std std-ref">neo1.pru0.c - Code to turn all NeoPixels’s white</span></a>
which to turns all pixels white.</p>
<div class="literal-block-wrapper docutils container" id="id103">
<span id="blocks-neo1"></span><div class="code-block-caption"><span class="caption-number">Listing 121 </span><span class="caption-text">neo1.pru0.c - Code to turn all NeoPixels’s white</span><a class="headerlink" href="#id103" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Control a ws2812 (NeoPixel) display, All on or all off</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define STR_LEN 24</span>
<span class="linenos"> 8</span><span class="cp">#define	oneCyclesOn		700/5	</span><span class="c1">// Stay on 700ns</span>
<span class="linenos"> 9</span><span class="cp">#define oneCyclesOff	800/5</span>
<span class="linenos">10</span><span class="cp">#define zeroCyclesOn	350/5</span>
<span class="linenos">11</span><span class="cp">#define zeroCyclesOff	600/5</span>
<span class="linenos">12</span><span class="cp">#define resetCycles		60000/5	</span><span class="c1">// Must be at least 50u, use 60u</span>
<span class="linenos">13</span><span class="cp">#define gpio P9_29				</span><span class="c1">// output pin</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="cp">#define ONE</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">18</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">21</span><span class="p">{</span>
<span class="linenos">22</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">23</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="linenos">26</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="cp">#ifdef ONE</span>
<span class="linenos">28</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">29</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">30</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">31</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOff</span><span class="mi">-2</span><span class="p">);</span>
<span class="linenos">32</span><span class="cp">#else</span>
<span class="linenos">33</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">34</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">35</span><span class="w">		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">36</span><span class="w">		</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOff</span><span class="mi">-2</span><span class="p">);</span>
<span class="linenos">37</span><span class="cp">#endif</span>
<span class="linenos">38</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">39</span><span class="w">	</span><span class="c1">// Send Reset</span>
<span class="linenos">40</span><span class="w">	</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">41</span><span class="w">	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">resetCycles</span><span class="p">);</span>
<span class="linenos">42</span><span class="w">	</span>
<span class="linenos">43</span><span class="w">	</span><span class="n">__halt</span><span class="p">();</span>
<span class="linenos">44</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/591c991e2f085282d6bae3b8832bd253/neo1.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">neo1.pru0.c</span></code></a></p>
</section>
<section id="id36">
<h3>Discussion<a class="headerlink" href="#id36" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="#blocks-sequence"><span class="std std-ref">NeoPixel bit sequence</span></a> (taken from  <a class="reference external" href="https://cdn-shop.adafruit.com/datasheets/WS2812.pdf">WS2812 Data Sheet</a>)
shows the following waveforms are used to send a bit of data.</p>
<figure class="align-center" id="id104">
<span id="blocks-sequence"></span><img alt="NeoPixel bit sequence" src="../../../_images/neo_sequence.png" />
<figcaption>
<p><span class="caption-number">Fig. 814 </span><span class="caption-text">NeoPixel bit sequence</span><a class="headerlink" href="#id104" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="pst-scrollable-table-container"><table class="table" id="id105">
<caption><span class="caption-number">Table 163 </span><span class="caption-text">Where the times are:</span><a class="headerlink" href="#id105" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Label</p></th>
<th class="head"><p>Time in ns</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>T0H</p></td>
<td><p>350</p></td>
</tr>
<tr class="row-odd"><td><p>T0L</p></td>
<td><p>800</p></td>
</tr>
<tr class="row-even"><td><p>T1H</p></td>
<td><p>700</p></td>
</tr>
<tr class="row-odd"><td><p>T1L</p></td>
<td><p>600</p></td>
</tr>
<tr class="row-even"><td><p>Treset</p></td>
<td><p>&gt;50,000</p></td>
</tr>
</tbody>
</table>
</div>
<p>The code in <a class="reference internal" href="#blocks-neo1"><span class="std std-ref">neo1.pru0.c - Code to turn all NeoPixels’s white</span></a> define these times in lines 7-10.
The <cite>/5</cite> is because
each instruction take 5ns.  Lines 27-30 then set the output to 1 for
the desired time and then to 0 and keeps repeating it for the entire
string length.  <a class="reference internal" href="#blocks-zero-scope"><span class="std std-ref">NeoPixel zero timing</span></a>
shows the waveform for sending a 0 value.  Note the times are spot on.</p>
<figure class="align-center" id="id106">
<span id="blocks-zero-scope"></span><img alt="NeoPixel zero timing" src="../../../_images/neo_scope.png" />
<figcaption>
<p><span class="caption-number">Fig. 815 </span><span class="caption-text">NeoPixel zero timing</span><a class="headerlink" href="#id106" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Each NeoPixel listens for a RGB value. Once a value has arrived all other values
that follow are passed on to the next NeoPixel which does the same thing.
That way you can individually control all of the NeoPixels.</p>
<p>Lines 38-40 send out a reset pulse.  If a NeoPixel sees a reset pulse it will
grab the next value for itself and start over again.</p>
</section>
</section>
<section id="setting-neopixels-to-different-colors">
<h2>Setting NeoPixels to Different Colors<a class="headerlink" href="#setting-neopixels-to-different-colors" title="Link to this heading">#</a></h2>
<section id="id38">
<h3>Problem<a class="headerlink" href="#id38" title="Link to this heading">#</a></h3>
<p>I want to set the LEDs to different colors.</p>
</section>
<section id="id39">
<h3>Solution<a class="headerlink" href="#id39" title="Link to this heading">#</a></h3>
<p>Wire your NeoPixels as shown in <a class="reference internal" href="#blocks-neo-wiring"><span class="std std-ref">NeoPixel Wiring</span></a>
then run the code in <a class="reference internal" href="#blocks-neo2"><span class="std std-ref">neo2.pru0.c - Code to turn on green, red, blue</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id107">
<span id="blocks-neo2"></span><div class="code-block-caption"><span class="caption-number">Listing 122 </span><span class="caption-text">neo2.pru0.c - Code to turn on green, red, blue</span><a class="headerlink" href="#id107" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Control a ws2812 (neo pixel) display, green, red, blue, green, ...</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define STR_LEN 3</span>
<span class="linenos"> 8</span><span class="cp">#define	oneCyclesOn		700/5	</span><span class="c1">// Stay on 700ns</span>
<span class="linenos"> 9</span><span class="cp">#define oneCyclesOff	800/5</span>
<span class="linenos">10</span><span class="cp">#define zeroCyclesOn	350/5</span>
<span class="linenos">11</span><span class="cp">#define zeroCyclesOff	600/5</span>
<span class="linenos">12</span><span class="cp">#define resetCycles		60000/5	</span><span class="c1">// Must be at least 50u, use 60u</span>
<span class="linenos">13</span><span class="cp">#define gpio P9_29				</span><span class="c1">// output pin</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">16</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">19</span><span class="p">{</span>
<span class="linenos">20</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">21</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">22</span><span class="w">	</span>
<span class="linenos">23</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">color</span><span class="p">[</span><span class="n">STR_LEN</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x0f0000</span><span class="p">,</span><span class="w"> </span><span class="mh">0x000f00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000f</span><span class="p">};</span><span class="w">	</span><span class="c1">// green, red, blue</span>
<span class="linenos">24</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">		</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">23</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">28</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">29</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">30</span><span class="w">				</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">31</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">32</span><span class="w">				</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOff</span><span class="mi">-2</span><span class="p">);</span>
<span class="linenos">33</span><span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">34</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">35</span><span class="w">				</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">36</span><span class="w">				</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">37</span><span class="w">				</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOff</span><span class="mi">-2</span><span class="p">);</span>
<span class="linenos">38</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">39</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">40</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">41</span><span class="w">	</span><span class="c1">// Send Reset</span>
<span class="linenos">42</span><span class="w">	</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">43</span><span class="w">	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">resetCycles</span><span class="p">);</span>
<span class="linenos">44</span><span class="w">	</span>
<span class="linenos">45</span><span class="w">	</span><span class="n">__halt</span><span class="p">();</span>
<span class="linenos">46</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/2cc132ba4376b4a3dae2162b37cb53ff/neo2.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">neo2.pru0.c</span></code></a></p>
<p>This will make the first LED green, the second red and the third blue.</p>
</section>
<section id="id40">
<h3>Discussion<a class="headerlink" href="#id40" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="#blocks-new-data-seq"><span class="std std-ref">NeoPixel data sequence</span></a> shows the sequence of bits
used to control the green, red and blue values.</p>
<figure class="align-center" id="id108">
<span id="blocks-new-data-seq"></span><img alt="NeoPixel data sequence" src="../../../_images/neo_data_seq.png" />
<figcaption>
<p><span class="caption-number">Fig. 816 </span><span class="caption-text">NeoPixel data sequence</span><a class="headerlink" href="#id108" title="Link to this image">#</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The usual order for colors is RGB (red, green, blue), but the NeoPixels use GRB (green, red, blue).</p>
</div>
<p><a class="reference internal" href="#blocks-neo2-line"><span class="std std-ref">Line-by-line for neo2.pru0.c</span></a> is the line-by-line for <code class="docutils literal notranslate"><span class="pre">neo2.pru0.c</span></code>.</p>
<div class="pst-scrollable-table-container"><span id="blocks-neo2-line"></span><table class="table" id="id109">
<caption><span class="caption-number">Table 164 </span><span class="caption-text">Line-by-line for neo2.pru0.c</span><a class="headerlink" href="#id109" title="Link to this table">#</a></caption>
<tbody>
<tr class="row-odd"><td><p>Line
23</p></td>
<td><p>Explanation
Define the string of colors to be output.  Here the ordering of the
bits is the same as <a class="reference internal" href="#blocks-new-data-seq"><span class="std std-ref">NeoPixel data sequence</span></a>, GRB.</p></td>
</tr>
<tr class="row-even"><td><p>26</p></td>
<td><p>Loop for each color to output.</p></td>
</tr>
<tr class="row-odd"><td><p>27</p></td>
<td><p>Loop for each bit in an GRB color.</p></td>
</tr>
<tr class="row-even"><td><p>28</p></td>
<td><p>Get the j^th^ color and mask off all but the i^th^ bit.  <cite>(0x1:ref:`i)</cite> takes
the value <cite>0x1</cite> and shifts it left <cite>i</cite> bits.  When anded (&amp;) with <cite>color[j]</cite>
it will zero out all but the i^th^ bit.  If the result of the operation is
1, the <cite>if</cite> is done, otherwise the <cite>else</cite> is done.</p></td>
</tr>
<tr class="row-odd"><td><p>29-32</p></td>
<td><p>Send a 1.</p></td>
</tr>
<tr class="row-even"><td><p>34-37</p></td>
<td><p>Send a 0.</p></td>
</tr>
<tr class="row-odd"><td><p>42-43</p></td>
<td><p>Send a reset pulse once all the colors have been sent.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This will only change the first <code class="docutils literal notranslate"><span class="pre">STR_LEN</span></code> LEDs.  The LEDs that follow will not be changed.</p>
</div>
</section>
</section>
<section id="controlling-arbitrary-leds">
<h2>Controlling Arbitrary LEDs<a class="headerlink" href="#controlling-arbitrary-leds" title="Link to this heading">#</a></h2>
<section id="id41">
<h3>Problem<a class="headerlink" href="#id41" title="Link to this heading">#</a></h3>
<p>I want to change the 10^th^ LED and not have to change the others.</p>
</section>
<section id="id42">
<h3>Solution<a class="headerlink" href="#id42" title="Link to this heading">#</a></h3>
<p>You need to keep an array of colors for the whole string in the PRU.  Change
the color of any pixels you want in the array and then send out the whole
string to the LEDs.  <a class="reference internal" href="#blocks-neo3"><span class="std std-ref">neo3.pru0.c - Code to animate a red pixel running around a ring of blue</span></a> shows an example animates a red pixel
running around a ring of blue background.  <a class="reference internal" href="#blocks-neo3-video"><span class="std std-ref">Neo3 Video</span></a> shows
the code in action.</p>
<div class="literal-block-wrapper docutils container" id="id110">
<span id="blocks-neo3"></span><div class="code-block-caption"><span class="caption-number">Listing 123 </span><span class="caption-text">neo3.pru0.c - Code to animate a red pixel running around a ring of blue</span><a class="headerlink" href="#id110" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// Control a ws2812 (neo pixel) display, green, red, blue, green, ...</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="cp">#define STR_LEN 24</span>
<span class="linenos"> 8</span><span class="cp">#define	oneCyclesOn		700/5	</span><span class="c1">// Stay on 700ns</span>
<span class="linenos"> 9</span><span class="cp">#define oneCyclesOff	800/5</span>
<span class="linenos">10</span><span class="cp">#define zeroCyclesOn	350/5</span>
<span class="linenos">11</span><span class="cp">#define zeroCyclesOff	600/5</span>
<span class="linenos">12</span><span class="cp">#define resetCycles		60000/5	</span><span class="c1">// Must be at least 50u, use 60u</span>
<span class="linenos">13</span><span class="cp">#define gpio P9_29				</span><span class="c1">// output pin</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="cp">#define SPEED 20000000/5		</span><span class="c1">// Time to wait between updates</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">18</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">19</span>
<span class="linenos">20</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">21</span><span class="p">{</span>
<span class="linenos">22</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000f</span><span class="p">;</span>
<span class="linenos">23</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">foreground</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x000f00</span><span class="p">;</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">	</span><span class="cm">/* Clear SYSCFG[STANDBY_INIT] to enable OCP master port */</span>
<span class="linenos">26</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">27</span><span class="w">	</span>
<span class="linenos">28</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">color</span><span class="p">[</span><span class="n">STR_LEN</span><span class="p">];</span><span class="w">	</span><span class="c1">// green, red, blue</span>
<span class="linenos">29</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="linenos">30</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">oldk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;;</span>
<span class="linenos">31</span><span class="w">	</span><span class="c1">// Set everything to background</span>
<span class="linenos">32</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">33</span><span class="w">		</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">background</span><span class="p">;</span>
<span class="linenos">34</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">35</span><span class="w">	</span>
<span class="linenos">36</span><span class="w">	</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">37</span><span class="w">		</span><span class="c1">// Move forward one position</span>
<span class="linenos">38</span><span class="w">		</span><span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">39</span><span class="w">			</span><span class="n">color</span><span class="p">[</span><span class="n">oldk</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">background</span><span class="p">;</span>
<span class="linenos">40</span><span class="w">			</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">foreground</span><span class="p">;</span>
<span class="linenos">41</span><span class="w">			</span><span class="n">oldk</span><span class="o">=</span><span class="n">k</span><span class="p">;</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="w">			</span><span class="c1">// Output the string</span>
<span class="linenos">44</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">45</span><span class="w">				</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">23</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">46</span><span class="w">					</span><span class="k">if</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">47</span><span class="w">						</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">48</span><span class="w">						</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">						</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">50</span><span class="w">						</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOff</span><span class="mi">-2</span><span class="p">);</span>
<span class="linenos">51</span><span class="w">					</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">52</span><span class="w">						</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">53</span><span class="w">						</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">54</span><span class="w">						</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">		</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">55</span><span class="w">						</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOff</span><span class="mi">-2</span><span class="p">);</span>
<span class="linenos">56</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">57</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">58</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">59</span><span class="w">			</span><span class="c1">// Send Reset</span>
<span class="linenos">60</span><span class="w">			</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">gpio</span><span class="p">;</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">61</span><span class="w">			</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">resetCycles</span><span class="p">);</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="w">			</span><span class="c1">// Wait</span>
<span class="linenos">64</span><span class="w">			</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">SPEED</span><span class="p">);</span>
<span class="linenos">65</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">66</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">67</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/62ae71b6cf9c9ffb134db2c718bb8568/neo3.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">neo3.pru0.c</span></code></a></p>
</section>
<section id="neo3-video">
<span id="blocks-neo3-video"></span><h3>Neo3 Video<a class="headerlink" href="#neo3-video" title="Link to this heading">#</a></h3>
<p><a class="reference download internal" download="" href="../../../_downloads/e91511d2a4ed51ac4885a8c4a440ab8c/ring_around.mp4"><code class="xref download docutils literal notranslate"><span class="pre">neo3.pru0.c</span> <span class="pre">-</span> <span class="pre">Simple</span> <span class="pre">animation</span></code></a></p>
</section>
<section id="id43">
<h3>Discussion<a class="headerlink" href="#id43" title="Link to this heading">#</a></h3>
<div class="pst-scrollable-table-container"><table class="table" id="id111">
<caption><span class="caption-number">Table 165 </span><span class="caption-text">Here’s the highlights.</span><a class="headerlink" href="#id111" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>32,33</p></td>
<td><p>Initiallize the array of colors.</p></td>
</tr>
<tr class="row-odd"><td><p>38-41</p></td>
<td><p>Update the array.</p></td>
</tr>
<tr class="row-even"><td><p>44-58</p></td>
<td><p>Send the array to the LEDs.</p></td>
</tr>
<tr class="row-odd"><td><p>60-61</p></td>
<td><p>Send a reset.</p></td>
</tr>
<tr class="row-even"><td><p>64</p></td>
<td><p>Wait a bit.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="controlling-neopixels-through-a-kernel-driver">
<h2>Controlling NeoPixels Through a Kernel Driver<a class="headerlink" href="#controlling-neopixels-through-a-kernel-driver" title="Link to this heading">#</a></h2>
<section id="id44">
<h3>Problem<a class="headerlink" href="#id44" title="Link to this heading">#</a></h3>
<p>You want to control your NeoPixels through a kernel driver so you can control it
through a <code class="docutils literal notranslate"><span class="pre">/dev</span></code> interface.</p>
</section>
<section id="id45">
<h3>Solution<a class="headerlink" href="#id45" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://github.com/beagleboard/linux/raw/4.9/drivers/rpmsg/rpmsg_pru.c">rpmsg_pru</a>
driver provides a way to pass data between the ARM processor and
the PRUs.  It’s already included on current images. <a class="reference internal" href="#blocks-neo4"><span class="std std-ref">neo4.pru0.c - Code to talk to the PRU via rpmsg_pru</span></a> shows
an example.</p>
<div class="literal-block-wrapper docutils container" id="id112">
<span id="blocks-neo4"></span><div class="code-block-caption"><span class="caption-number">Listing 124 </span><span class="caption-text">neo4.pru0.c - Code to talk to the PRU via rpmsg_pru</span><a class="headerlink" href="#id112" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="c1">// Use rpmsg to control the NeoPixels via /dev/rpmsg_pru30</span>
<span class="linenos">  2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos">  3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">  4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="c1">			// atoi</span>
<span class="linenos">  5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="linenos">  6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos">  7</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_intc.h&gt;</span>
<span class="linenos">  8</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rsc_types.h&gt;</span>
<span class="linenos">  9</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_rpmsg.h&gt;</span>
<span class="linenos"> 10</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_0.h&quot;</span>
<span class="linenos"> 11</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos"> 14</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="cm">/* Host-0 Interrupt sets bit 30 in register R31 */</span>
<span class="linenos"> 17</span><span class="cp">#define HOST_INT			((uint32_t) 1 &lt;&lt; 30)	</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span><span class="cm">/* The PRU-ICSS system events used for RPMsg are defined in the Linux device tree</span>
<span class="linenos"> 20</span><span class="cm"> * PRU0 uses system event 16 (To ARM) and 17 (From ARM)</span>
<span class="linenos"> 21</span><span class="cm"> * PRU1 uses system event 18 (To ARM) and 19 (From ARM)</span>
<span class="linenos"> 22</span><span class="cm"> */</span>
<span class="linenos"> 23</span><span class="cp">#define TO_ARM_HOST			16	</span>
<span class="linenos"> 24</span><span class="cp">#define FROM_ARM_HOST		17</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="cm">/*</span>
<span class="linenos"> 27</span><span class="cm">* Using the name &#39;rpmsg-pru&#39; will probe the rpmsg_pru driver found</span>
<span class="linenos"> 28</span><span class="cm">* at linux-x.y.z/drivers/rpmsg/rpmsg_pru.c</span>
<span class="linenos"> 29</span><span class="cm">*/</span>
<span class="linenos"> 30</span><span class="cp">#define CHAN_NAME			&quot;rpmsg-pru&quot;</span>
<span class="linenos"> 31</span><span class="cp">#define CHAN_DESC			&quot;Channel 30&quot;</span>
<span class="linenos"> 32</span><span class="cp">#define CHAN_PORT			30</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="cm">/*</span>
<span class="linenos"> 35</span><span class="cm"> * Used to make sure the Linux drivers are ready for RPMsg communication</span>
<span class="linenos"> 36</span><span class="cm"> * Found at linux-x.y.z/include/uapi/linux/virtio_config.h</span>
<span class="linenos"> 37</span><span class="cm"> */</span>
<span class="linenos"> 38</span><span class="cp">#define VIRTIO_CONFIG_S_DRIVER_OK	4</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[</span><span class="n">RPMSG_BUF_SIZE</span><span class="p">];</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span><span class="cp">#define STR_LEN 24</span>
<span class="linenos"> 43</span><span class="cp">#define	oneCyclesOn		700/5	</span><span class="c1">// Stay on for 700ns</span>
<span class="linenos"> 44</span><span class="cp">#define oneCyclesOff	600/5</span>
<span class="linenos"> 45</span><span class="cp">#define zeroCyclesOn	350/5</span>
<span class="linenos"> 46</span><span class="cp">#define zeroCyclesOff	800/5</span>
<span class="linenos"> 47</span><span class="cp">#define resetCycles		51000/5	</span><span class="c1">// Must be at least 50u, use 51u</span>
<span class="linenos"> 48</span><span class="cp">#define out P9_29				</span><span class="c1">// Bit number to output on</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="cp">#define SPEED 20000000/5		</span><span class="c1">// Time to wait between updates</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">color</span><span class="p">[</span><span class="n">STR_LEN</span><span class="p">];</span><span class="w">	</span><span class="c1">// green, red, blue</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="cm">/*</span>
<span class="linenos"> 55</span><span class="cm"> * main.c</span>
<span class="linenos"> 56</span><span class="cm"> */</span>
<span class="linenos"> 57</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos"> 58</span><span class="p">{</span>
<span class="linenos"> 59</span><span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">pru_rpmsg_transport</span><span class="w"> </span><span class="n">transport</span><span class="p">;</span>
<span class="linenos"> 60</span><span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="linenos"> 61</span><span class="w">	</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">status</span><span class="p">;</span>
<span class="linenos"> 62</span><span class="w">	</span>
<span class="linenos"> 63</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="linenos"> 64</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
<span class="linenos"> 65</span><span class="w">	</span><span class="c1">// Set everything to background</span>
<span class="linenos"> 66</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 67</span><span class="w">		</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x010000</span><span class="p">;</span>
<span class="linenos"> 68</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="w">	</span><span class="cm">/* Allow OCP master port access by the PRU so the PRU can read external memories */</span>
<span class="linenos"> 71</span><span class="w">	</span><span class="n">CT_CFG</span><span class="p">.</span><span class="n">SYSCFG_bit</span><span class="p">.</span><span class="n">STANDBY_INIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="w">	</span><span class="cm">/* Clear the status of the PRU-ICSS system event that the ARM will use to &#39;kick&#39; us */</span>
<span class="linenos"> 74</span><span class="cp">#ifdef CHIP_IS_am57xx</span>
<span class="linenos"> 75</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">SICR_bit</span><span class="p">.</span><span class="n">STATUS_CLR_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FROM_ARM_HOST</span><span class="p">;</span>
<span class="linenos"> 76</span><span class="cp">#else</span>
<span class="linenos"> 77</span><span class="w">	</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">SICR_bit</span><span class="p">.</span><span class="n">STS_CLR_IDX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FROM_ARM_HOST</span><span class="p">;</span>
<span class="linenos"> 78</span><span class="cp">#endif</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="w">	</span><span class="cm">/* Make sure the Linux drivers are ready for RPMsg communication */</span>
<span class="linenos"> 81</span><span class="w">	</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resourceTable</span><span class="p">.</span><span class="n">rpmsg_vdev</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="linenos"> 82</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VIRTIO_CONFIG_S_DRIVER_OK</span><span class="p">));</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="w">	</span><span class="cm">/* Initialize the RPMsg transport structure */</span>
<span class="linenos"> 85</span><span class="w">	</span><span class="n">pru_rpmsg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resourceTable</span><span class="p">.</span><span class="n">rpmsg_vring0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resourceTable</span><span class="p">.</span><span class="n">rpmsg_vring1</span><span class="p">,</span><span class="w"> </span><span class="n">TO_ARM_HOST</span><span class="p">,</span><span class="w"> </span><span class="n">FROM_ARM_HOST</span><span class="p">);</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="w">	</span><span class="cm">/* Create the RPMsg channel between the PRU and ARM user space using the transport structure. */</span>
<span class="linenos"> 88</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pru_rpmsg_channel</span><span class="p">(</span><span class="n">RPMSG_NS_CREATE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">CHAN_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">CHAN_DESC</span><span class="p">,</span><span class="w"> </span><span class="n">CHAN_PORT</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">PRU_RPMSG_SUCCESS</span><span class="p">);</span>
<span class="linenos"> 89</span><span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 90</span><span class="w">		</span><span class="cm">/* Check bit 30 of register R31 to see if the ARM has kicked us */</span>
<span class="linenos"> 91</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__R31</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HOST_INT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 92</span><span class="w">			</span><span class="cm">/* Clear the event status */</span>
<span class="linenos"> 93</span><span class="cp">#ifdef CHIP_IS_am57xx</span>
<span class="linenos"> 94</span><span class="w">			</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">SICR_bit</span><span class="p">.</span><span class="n">STATUS_CLR_INDEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FROM_ARM_HOST</span><span class="p">;</span>
<span class="linenos"> 95</span><span class="cp">#else</span>
<span class="linenos"> 96</span><span class="w">			</span><span class="n">CT_INTC</span><span class="p">.</span><span class="n">SICR_bit</span><span class="p">.</span><span class="n">STS_CLR_IDX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FROM_ARM_HOST</span><span class="p">;</span>
<span class="linenos"> 97</span><span class="cp">#endif</span>
<span class="linenos"> 98</span><span class="w">			</span><span class="cm">/* Receive all available messages, multiple messages can be sent per kick */</span>
<span class="linenos"> 99</span><span class="w">			</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">pru_rpmsg_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PRU_RPMSG_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">100</span><span class="w">			    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="p">;</span><span class="w">	</span><span class="c1">// rest of payload after front character is removed</span>
<span class="linenos">101</span><span class="w">			    </span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w">	</span><span class="c1">// index of LED to control</span>
<span class="linenos">102</span><span class="w">			    </span><span class="c1">// Input format is:  index red green blue</span>
<span class="linenos">103</span><span class="w">			    </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span><span class="w">	</span>
<span class="linenos">104</span><span class="w">			    </span><span class="c1">// Update the array, but don&#39;t write it out.</span>
<span class="linenos">105</span><span class="w">			    </span><span class="k">if</span><span class="p">((</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">STR_LEN</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">106</span><span class="w">			    	</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strchr</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span><span class="w">	</span><span class="c1">// Skip over index</span>
<span class="linenos">107</span><span class="w">				    </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">108</span><span class="w">				    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strchr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span><span class="w">	</span><span class="c1">// Skip over r, etc.</span>
<span class="linenos">109</span><span class="w">				    </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">110</span><span class="w">				    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strchr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="linenos">111</span><span class="w">				    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="w">				    </span><span class="n">color</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">g</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">b</span><span class="p">;</span><span class="w">	</span><span class="c1">// String wants GRB</span>
<span class="linenos">114</span><span class="w">			    </span><span class="p">}</span>
<span class="linenos">115</span><span class="w">			    </span><span class="c1">// When index is -1, send the array to the LED string</span>
<span class="linenos">116</span><span class="w">			    </span><span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">117</span><span class="w">				    </span><span class="c1">// Output the string</span>
<span class="linenos">118</span><span class="w">					</span><span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">STR_LEN</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">119</span><span class="w">						</span><span class="c1">// Cycle through each bit</span>
<span class="linenos">120</span><span class="w">						</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">23</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">121</span><span class="w">							</span><span class="k">if</span><span class="p">(</span><span class="n">color</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">122</span><span class="w">								</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">123</span><span class="w">								</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">124</span><span class="w">								</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">out</span><span class="p">;</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">125</span><span class="w">								</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">oneCyclesOff</span><span class="mi">-14</span><span class="p">);</span>
<span class="linenos">126</span><span class="w">							</span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">127</span><span class="w">								</span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w">		</span><span class="c1">// Set the GPIO pin to 1</span>
<span class="linenos">128</span><span class="w">								</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOn</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos">129</span><span class="w">								</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="n">out</span><span class="p">);</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">130</span><span class="w">								</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">zeroCyclesOff</span><span class="mi">-14</span><span class="p">);</span>
<span class="linenos">131</span><span class="w">							</span><span class="p">}</span>
<span class="linenos">132</span><span class="w">						</span><span class="p">}</span>
<span class="linenos">133</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">134</span><span class="w">					</span><span class="c1">// Send Reset</span>
<span class="linenos">135</span><span class="w">					</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">out</span><span class="p">;</span><span class="w">	</span><span class="c1">// Clear the GPIO pin</span>
<span class="linenos">136</span><span class="w">					</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">resetCycles</span><span class="p">);</span>
<span class="linenos">137</span><span class="w">		</span>
<span class="linenos">138</span><span class="w">					</span><span class="c1">// Wait</span>
<span class="linenos">139</span><span class="w">					</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">SPEED</span><span class="p">);</span>
<span class="linenos">140</span><span class="w">			    </span><span class="p">}</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">143</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">144</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">145</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/62e49322792936ebd760f39e7e0bbb67/neo4.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">neo4.pru0.c</span></code></a></p>
<p>Run the code as usual.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>make<span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>neo4.pru0
/opt/source/pru-cookbook-code/common/Makefile:29:<span class="w"> </span><span class="nv">MODEL</span><span class="o">=</span>TI_AM335x_BeagleBone_Black,TARGET<span class="o">=</span>neo4.pru0
-<span class="w">    </span>Stopping<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
-<span class="w">     </span>copying<span class="w"> </span>firmware<span class="w"> </span>file<span class="w"> </span>/tmp/vsx-examples/neo4.pru0.out<span class="w"> </span>to<span class="w"> </span>/lib/firmware/am335x-pru0-fw
write_init_pins.sh
-<span class="w">    </span>Starting<span class="w"> </span>PRU<span class="w"> </span><span class="m">0</span>
<span class="nv">MODEL</span><span class="w">   </span><span class="o">=</span><span class="w"> </span>TI_AM335x_BeagleBone_Black
<span class="nv">PROC</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>pru
<span class="nv">PRUN</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="nv">PRU_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/sys/class/remoteproc/remoteproc1

bone$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>0xff<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">127</span><span class="w"> </span>&gt;<span class="w"> </span>/dev/rpmsg_pru30
bone$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-1<span class="w"> </span>&gt;<span class="w"> </span>/dev/rpmsg_pru30
</pre></div>
</div>
<div class="admonition-todo admonition" id="id46">
<p class="admonition-title">Todo</p>
<p>get this working on the 5.10 kernel</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/dev/rpmsg_pru30</span></code> is a device driver that lets the ARM talk to the PRU.
The first <code class="docutils literal notranslate"><span class="pre">echo</span></code> says to set the 0^th^ LED to RGB value 0xff 0 127. (Note: you can
mix hex and decimal.) The second <code class="docutils literal notranslate"><span class="pre">echo</span></code> tells the driver to send the data to the
LEDs.  Your 0^th^ LED should now be lit.</p>
</section>
<section id="id47">
<h3>Discussion<a class="headerlink" href="#id47" title="Link to this heading">#</a></h3>
<p>There’s a lot here.  I’ll just hit some of the highlights in <a class="reference internal" href="#blocks-neo4-lines"><span class="std std-ref">Line-by-line for neo4.pru0.c</span></a>.</p>
<div class="pst-scrollable-table-container"><span id="blocks-neo4-lines"></span><table class="table" id="id113">
<caption><span class="caption-number">Table 166 </span><span class="caption-text">Line-by-line for neo4.pru0.c</span><a class="headerlink" href="#id113" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Line</p></th>
<th class="head"><p>Explanation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>30</p></td>
<td><p>The <cite>CHAN_NAME</cite> of <cite>rpmsg-pru</cite> matches that <cite>prmsg_pru</cite> driver that is
is already installed.  This connects this PRU to the driver.</p></td>
</tr>
<tr class="row-odd"><td><p>32</p></td>
<td><p>The <cite>CHAN_PORT</cite> tells it to use port 30.  That’s why we use
<cite>/dev/rpmsg_pru30</cite></p></td>
</tr>
<tr class="row-even"><td><p>40</p></td>
<td><p><cite>payload[]</cite> is the buffer that receives the data from the ARM.</p></td>
</tr>
<tr class="row-odd"><td><p>42-48</p></td>
<td><p>Same as the previous NeoPixel examples.</p></td>
</tr>
<tr class="row-even"><td><p>52</p></td>
<td><p><cite>color[]</cite> is the state to be sent to the LEDs.</p></td>
</tr>
<tr class="row-odd"><td><p>66-68</p></td>
<td><p><cite>color[]</cite> is initialized.</p></td>
</tr>
<tr class="row-even"><td><p>70-85</p></td>
<td><p>Here are a number of details needed to set up the channel between
the PRU and the ARM.</p></td>
</tr>
<tr class="row-odd"><td><p>88</p></td>
<td><p>Here we wait until the ARM sends us some numbers.</p></td>
</tr>
<tr class="row-even"><td><p>99</p></td>
<td><p>Receive all the data from the ARM, store it in <cite>payload[]</cite>.</p></td>
</tr>
<tr class="row-odd"><td><p>101-111</p></td>
<td><p>The data sent is:  index red green blue.  Pull off the index.  If it’s
in the right range, pull off the red, green and blue values.</p></td>
</tr>
<tr class="row-even"><td><p>113</p></td>
<td><p>The NeoPixels want the data in GRB order.  Shift and OR everything
together.</p></td>
</tr>
<tr class="row-odd"><td><p>116-133</p></td>
<td><p>If the <cite>index</cite> = -1, send the contents of <cite>color</cite> to the LEDs.  This
code is same as before.</p></td>
</tr>
</tbody>
</table>
</div>
<p>You can now use programs running on the ARM to send colors to the PRU.</p>
<p><a class="reference internal" href="#blocks-neo-rainbow"><span class="std std-ref">neo-rainbow.py - A python program using /dev/rpmsg_pru30</span></a> shows an example.</p>
<div class="literal-block-wrapper docutils container" id="id114">
<span id="blocks-neo-rainbow"></span><div class="code-block-caption"><span class="caption-number">Listing 125 </span><span class="caption-text">neo-rainbow.py - A python program using /dev/rpmsg_pru30</span><a class="headerlink" href="#id114" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#!/usr/bin/python3</span>
<span class="linenos"> 2</span><span class="n">from</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="n">sleep</span>
<span class="linenos"> 3</span><span class="k">import</span><span class="w"> </span><span class="n">math</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span>
<span class="linenos"> 6</span><span class="n">amp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span>
<span class="linenos"> 7</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span>
<span class="linenos"> 8</span><span class="n">shift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="linenos"> 9</span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cp"># Open a file</span>
<span class="linenos">12</span><span class="n">fo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/rpmsg_pru30&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wb&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="k">while</span><span class="w"> </span><span class="n">True</span><span class="o">:</span>
<span class="linenos">15</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="o">:</span>
<span class="linenos">16</span><span class="w">        </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">phase</span><span class="mi">-0</span><span class="o">*</span><span class="n">shift</span><span class="p">)</span><span class="o">/</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">17</span><span class="w">        </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">phase</span><span class="mi">-1</span><span class="o">*</span><span class="n">shift</span><span class="p">)</span><span class="o">/</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">18</span><span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">amp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">phase</span><span class="mi">-2</span><span class="o">*</span><span class="n">shift</span><span class="p">)</span><span class="o">/</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">19</span><span class="w">        </span><span class="n">fo</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;%d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">))</span>
<span class="linenos">20</span><span class="w">        </span><span class="cp"># print(&quot;0 0 127 %d&quot; % (i))</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="w">    </span><span class="n">fo</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;-1 0 0 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">23</span><span class="w">    </span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="linenos">24</span><span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="cp"># Close opened file</span>
<span class="linenos">27</span><span class="n">fo</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/638161b4887ddd61fcd828aabe49cb6f/neo-rainbow.py"><code class="xref download docutils literal notranslate"><span class="pre">neo-rainbow.py</span></code></a></p>
<p>Line 19 writes the data to the PRU.  Be sure to have a newline, or space after
the last number, or you numbers will get blurred together.</p>
<section id="switching-from-pru0-to-pru1-with-rpmsg-pru">
<h4>Switching from pru0 to pru1 with rpmsg_pru<a class="headerlink" href="#switching-from-pru0-to-pru1-with-rpmsg-pru" title="Link to this heading">#</a></h4>
<p>There are three things you need to change when switching from pru0 to pru1
when using rpmsg_pru.</p>
<ol class="arabic simple">
<li><p>The include on line 10 is switched to <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;resource_table_1.h&quot;</span></code> (0 is switched to a 1)</p></li>
<li><p>Line 17 is switched to <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">HOST_INT</span> <span class="pre">((uint32_t)</span> <span class="pre">1</span> <span class="pre">&lt;&lt;</span> <span class="pre">31)</span></code> (30 is switched to 31.)</p></li>
<li><p>Lines 23 and 24 are switched to:</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define TO_ARM_HOST                   18</span>
<span class="cp">#define FROM_ARM_HOST         19</span>
</pre></div>
</div>
<p>These changes switch to the proper channel numbers to use pru1 instead of pru0.</p>
</section>
</section>
</section>
<section id="rgb-led-matrix-no-integrated-drivers">
<h2>RGB LED Matrix - No Integrated Drivers<a class="headerlink" href="#rgb-led-matrix-no-integrated-drivers" title="Link to this heading">#</a></h2>
<section id="id48">
<h3>Problem<a class="headerlink" href="#id48" title="Link to this heading">#</a></h3>
<p>You have a RGB LED matrix
(<a class="reference internal" href="../01case/case.html#case-rgb-matrix"><span class="std std-ref">RGB LED Matrix – No Integrated Drivers (Falcon Christmas)</span></a>) and want to know
at a low level how the PRU works.</p>
</section>
<section id="id49">
<h3>Solution<a class="headerlink" href="#id49" title="Link to this heading">#</a></h3>
<p>Here is the
<a class="reference external" href="https://cdn-shop.adafruit.com/product-files/2277/MI-T35P5RGBE-AE.pdf">datasheet</a>,
but the best description I’ve found for the RGB Matrix is from
<a class="reference external" href="https://www.adafruit.com/">Adafruit</a>.  I’ve reproduced it here, with
adjustments for the 64x32 matrix we are using.</p>
<div class="admonition-information admonition">
<p class="admonition-title">information</p>
<p>There’s zero documentation out there on how these matrices work, and no public
datasheets or spec sheets so we are going to try to document how they work.</p>
<p>First thing to notice is that there are 2048 RGB LEDs in a 64x32 matrix.
Like pretty much every matrix out there, you can’t drive all 2048 at once.
One reason is that would require a lot of current, another reason is that
it would be really expensive to have so many pins. Instead, the matrix is
divided into 16 interleaved sections/strips. The first section is the
1^st^ ‘line’ and the 17^th^ ‘line’ (64 x 2 RGB LEDs = 128 RGB LEDs),
the second is the 2^nd^ and 18^th^ line, etc until the last section
which is the 16^th^ and 32^nd^ line. You might be asking, why are the
lines paired this way? wouldn’t it be nicer to have the first section
be the 1^st^ and 2^nd^ line, then 3^rd^ and 4^th^, until the 15^th^ and
16^th^? The reason they do it this way is so that the lines are interleaved
and look better when refreshed, otherwise we’d see the stripes more clearly.</p>
<p>So, on the PCB is 24 LED driver chips. These are like 74HC595s but they
have 16 outputs and they are constant current. 16 outputs * 24 chips =
384 LEDs that can be controlled at once, and 128 * 3 (R G and B) = 384.
So now the design comes together: You have 384 outputs that can control
one line at a time, with each of 384 R, G and B LEDs either on or off.
The controller (say an FPGA or microcontroller) selects which section
to currently draw (using LA, LB, LC and LD address pins - 4 bits can
have 16 values). Once the address is set, the controller clocks out
384 bits of data (48 bytes) and latches it. Then it increments the
address and clocks out another 384 bits, etc until it gets to address
#15, then it sets the address back to #0</p>
<p><a class="reference external" href="https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf">https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf</a></p>
</div>
<p>That gives a good overview, but there are a few details missing.
<a class="reference internal" href="#blocks-rgb-python"><span class="std std-ref">rgb_python.py - Python code for driving RGB LED matrix</span></a> is a functioning python program that gives a nice
high-level view of how to drive the display.</p>
<div class="admonition-todo admonition" id="id50">
<p class="admonition-title">Todo</p>
<p>Test this</p>
</div>
<div class="literal-block-wrapper docutils container" id="id115">
<span id="blocks-rgb-python"></span><div class="code-block-caption"><span class="caption-number">Listing 126 </span><span class="caption-text">rgb_python.py - Python code for driving RGB LED matrix</span><a class="headerlink" href="#id115" title="Link to this code">#</a></div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/usr/bin/env python3</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">Adafruit_BBIO.GPIO</span> <span class="k">as</span> <span class="nn">GPIO</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1"># Define which functions are connect to which pins</span>
<span class="linenos"> 5</span><span class="n">OE</span><span class="o">=</span><span class="s2">&quot;P1_29&quot;</span>      <span class="c1"># Output Enable, active low</span>
<span class="linenos"> 6</span><span class="n">LAT</span><span class="o">=</span><span class="s2">&quot;P1_36&quot;</span>     <span class="c1"># Latch, toggle after clocking in a row of pixels</span>
<span class="linenos"> 7</span><span class="n">CLK</span><span class="o">=</span><span class="s2">&quot;P1_33&quot;</span>     <span class="c1"># Clock, toggle after each pixel</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="c1"># Input data pins </span>
<span class="linenos">10</span><span class="n">R1</span><span class="o">=</span><span class="s2">&quot;P2_10&quot;</span>  <span class="c1"># R1, G1, B1 are for the top rows (1-16) of pixels</span>
<span class="linenos">11</span><span class="n">G1</span><span class="o">=</span><span class="s2">&quot;P2_8&quot;</span>
<span class="linenos">12</span><span class="n">B1</span><span class="o">=</span><span class="s2">&quot;P2_6&quot;</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="n">R2</span><span class="o">=</span><span class="s2">&quot;P2_4&quot;</span>   <span class="c1"># R2, G2, B2 are for the bottom rows (17-32) of pixels</span>
<span class="linenos">15</span><span class="n">G2</span><span class="o">=</span><span class="s2">&quot;P2_2&quot;</span>
<span class="linenos">16</span><span class="n">B2</span><span class="o">=</span><span class="s2">&quot;P2_1&quot;</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="n">LA</span><span class="o">=</span><span class="s2">&quot;P2_32&quot;</span>  <span class="c1"># Address lines for which row (1-16 or 17-32) to update</span>
<span class="linenos">19</span><span class="n">LB</span><span class="o">=</span><span class="s2">&quot;P2_30&quot;</span>
<span class="linenos">20</span><span class="n">LC</span><span class="o">=</span><span class="s2">&quot;P1_31&quot;</span>
<span class="linenos">21</span><span class="n">LD</span><span class="o">=</span><span class="s2">&quot;P2_34&quot;</span>
<span class="linenos">22</span>
<span class="linenos">23</span><span class="c1"># Set everything as output ports</span>
<span class="linenos">24</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">OE</span><span class="p">,</span>  <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">25</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">LAT</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">26</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">27</span>
<span class="linenos">28</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">29</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">G1</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">30</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">B1</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">31</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">32</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">G2</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">33</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">B2</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">LA</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">36</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">LB</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">37</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">LC</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">38</span><span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">LD</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">OE</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Enable the display</span>
<span class="linenos">41</span><span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Set latch to low</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">44</span>    <span class="k">for</span> <span class="n">bank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">):</span>
<span class="linenos">45</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LA</span><span class="p">,</span> <span class="n">bank</span><span class="o">&gt;&gt;</span><span class="mi">0</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">)</span>    <span class="c1"># Select rows</span>
<span class="linenos">46</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LB</span><span class="p">,</span> <span class="n">bank</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">)</span>
<span class="linenos">47</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LC</span><span class="p">,</span> <span class="n">bank</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">)</span>
<span class="linenos">48</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LD</span><span class="p">,</span> <span class="n">bank</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="o">&amp;</span><span class="mh">0x1</span><span class="p">)</span>
<span class="linenos">49</span>        
<span class="linenos">50</span>        <span class="c1"># Shift the colors out.  Here we only have four different </span>
<span class="linenos">51</span>        <span class="c1"># colors to keep things simple.</span>
<span class="linenos">52</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
<span class="linenos">53</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>     <span class="c1"># Top row, white</span>
<span class="linenos">54</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">G1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>
<span class="linenos">55</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">B1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>
<span class="linenos">56</span>            
<span class="linenos">57</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>     <span class="c1"># Bottom row, red</span>
<span class="linenos">58</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">G2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
<span class="linenos">59</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">B2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
<span class="linenos">60</span>
<span class="linenos">61</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Toggle clock</span>
<span class="linenos">62</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">63</span>    
<span class="linenos">64</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Top row, black</span>
<span class="linenos">65</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">G1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
<span class="linenos">66</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">B1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
<span class="linenos">67</span>
<span class="linenos">68</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Bottom row, green</span>
<span class="linenos">69</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">G2</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>
<span class="linenos">70</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">B2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
<span class="linenos">71</span>    
<span class="linenos">72</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Toggle clock</span>
<span class="linenos">73</span>            <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">CLK</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos">74</span>    
<span class="linenos">75</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">OE</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>     <span class="c1"># Disable display while updating</span>
<span class="linenos">76</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># Toggle latch</span>
<span class="linenos">77</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">LAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">78</span>        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">OE</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>     <span class="c1"># Enable display</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/9a012385a391dcd17292505cd12d223f/rgb_python.py"><code class="xref download docutils literal notranslate"><span class="pre">rgb_python.py</span></code></a></p>
<p>Be sure to run the <a class="reference internal" href="#blocks-rgb-setup"><span class="std std-ref">rgb_python_setup.sh</span></a> script before running the python code.</p>
<div class="literal-block-wrapper docutils container" id="id116">
<span id="blocks-rgb-setup"></span><div class="code-block-caption"><span class="caption-number">Listing 127 </span><span class="caption-text">rgb_python_setup.sh</span><a class="headerlink" href="#id116" title="Link to this code">#</a></div>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="ch">#!/bin/bash</span>
<span class="linenos"> 2</span><span class="c1"># Setup for 64x32 RGB Matrix</span>
<span class="linenos"> 3</span><span class="nb">export</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span>rgb1.pru0
<span class="linenos"> 4</span><span class="nb">echo</span><span class="w"> </span><span class="nv">TARGET</span><span class="o">=</span><span class="nv">$TARGET</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="c1"># Configure the PRU pins based on which Beagle is running</span>
<span class="linenos"> 7</span><span class="nv">machine</span><span class="o">=</span><span class="k">$(</span>awk<span class="w"> </span><span class="s1">&#39;{print $NF}&#39;</span><span class="w"> </span>/proc/device-tree/model<span class="k">)</span>
<span class="linenos"> 8</span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">$machine</span>
<span class="linenos"> 9</span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Black&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">10</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">11</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">12</span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Blue&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">13</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">14</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">15</span><span class="k">elif</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$machine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PocketBeagle&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">16</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Found&quot;</span>
<span class="linenos">17</span><span class="w">    </span><span class="nv">prupins</span><span class="o">=</span><span class="s2">&quot;P2_32 P1_31 P1_33 P1_29 P2_30 P2_34 P1_36&quot;</span>
<span class="linenos">18</span><span class="w">    </span><span class="nv">gpiopins</span><span class="o">=</span><span class="s2">&quot;P2_10 P2_06 P2_04 P2_01 P2_08 P2_02&quot;</span>
<span class="linenos">19</span><span class="w">    </span><span class="c1"># Uncomment for J2</span>
<span class="linenos">20</span><span class="w">    </span><span class="c1"># gpiopins=&quot;$gpiopins P2_27 P2_25 P2_05 P2_24 P2_22 P2_18&quot;</span>
<span class="linenos">21</span><span class="k">else</span>
<span class="linenos">22</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot; Not Found&quot;</span>
<span class="linenos">23</span><span class="w">    </span><span class="nv">pins</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="linenos">24</span><span class="k">fi</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="k">for</span><span class="w"> </span>pin<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$prupins</span>
<span class="linenos">27</span><span class="k">do</span>
<span class="linenos">28</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$pin</span>
<span class="linenos">29</span><span class="w">    </span><span class="c1"># config-pin $pin pruout</span>
<span class="linenos">30</span><span class="w">    </span>config-pin<span class="w"> </span><span class="nv">$pin</span><span class="w"> </span>gpio
<span class="linenos">31</span><span class="w">    </span>config-pin<span class="w"> </span><span class="nv">$pin</span><span class="w"> </span>out
<span class="linenos">32</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span><span class="nv">$pin</span>
<span class="linenos">33</span><span class="k">done</span>
<span class="linenos">34</span>
<span class="linenos">35</span><span class="k">for</span><span class="w"> </span>pin<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$gpiopins</span>
<span class="linenos">36</span><span class="k">do</span>
<span class="linenos">37</span><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$pin</span>
<span class="linenos">38</span><span class="w">    </span>config-pin<span class="w"> </span><span class="nv">$pin</span><span class="w"> </span>gpio
<span class="linenos">39</span><span class="w">    </span>config-pin<span class="w"> </span><span class="nv">$pin</span><span class="w"> </span>out
<span class="linenos">40</span><span class="w">    </span>config-pin<span class="w"> </span>-q<span class="w"> </span><span class="nv">$pin</span>
<span class="linenos">41</span><span class="k">done</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/01424eb80515742f8a4d567d6fda83f5/rgb_python_setup.sh"><code class="xref download docutils literal notranslate"><span class="pre">rgb_python_setup.sh</span></code></a></p>
<p>Make sure line 29 is commented out and line 30 is uncommented.
Later we’ll configure for _pruout_, but for now the python code doesn’t use
the PRU outs.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># config-pin $pin pruout</span>
config-pin<span class="w"> </span><span class="nv">$pin</span><span class="w"> </span>out
</pre></div>
</div>
<p>Your display should look like <a class="reference internal" href="#blocks-rgb-python-jpg"><span class="std std-ref">Display running rgb_python.py</span></a>.</p>
<figure class="align-center" id="id117">
<span id="blocks-rgb-python-jpg"></span><img alt="Display running rgb_python.py" src="../../../_images/rgb_python.webp" />
<figcaption>
<p><span class="caption-number">Fig. 817 </span><span class="caption-text">Display running rgb_python.py</span><a class="headerlink" href="#id117" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>So why do only two lines appear at a time?  That’s how the display works.
Currently lines 6 and 22 are showing, then a moment later 7 and 23 show, etc.
The display can only display two lines at a time, so it cycles through all the
lines.  Unfortunately, python is too slow to make the display appear
all at once.  Here’s where the PRU comes in.</p>
<p>:ref:<code class="docutils literal notranslate"><span class="pre">blocks_rgb1</span></code> is the PRU code to drive the RGB LED matrix.
Be sure to run <code class="docutils literal notranslate"><span class="pre">bone$</span> <span class="pre">source</span> <span class="pre">rgb_setup.sh</span></code> first.</p>
<div class="literal-block-wrapper docutils container" id="id118">
<span id="blocks-rgb1"></span><div class="code-block-caption"><span class="caption-number">Listing 128 </span><span class="caption-text">PRU code for driving the RGB LED matrix</span><a class="headerlink" href="#id118" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">// This code drives the RGB LED Matrix on the 1st Connector</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pru_cfg.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;resource_table_empty.h&quot;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;prugpio.h&quot;</span>
<span class="linenos"> 6</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rgb_pocket.h&quot;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="cp">#define DELAY 10	</span><span class="c1">// Number of cycles (5ns each) to wait after a write</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R30</span><span class="p">;</span>
<span class="linenos">11</span><span class="k">volatile</span><span class="w"> </span><span class="k">register</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">__R31</span><span class="p">;</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="linenos">14</span><span class="p">{</span>
<span class="linenos">15</span><span class="w">	</span><span class="c1">// Set up the pointers to each of the GPIO ports </span>
<span class="linenos">16</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">gpio</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">17</span><span class="w">			</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">GPIO0</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">18</span><span class="w">			</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">GPIO1</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">19</span><span class="w">			</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">GPIO2</span><span class="p">,</span><span class="w"> </span>
<span class="linenos">20</span><span class="w">			</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">GPIO3</span>
<span class="linenos">21</span><span class="w">		</span><span class="p">};</span>
<span class="linenos">22</span><span class="w">	</span>
<span class="linenos">23</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">;</span>
<span class="linenos">24</span>
<span class="linenos">25</span><span class="w">	</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">26</span><span class="w">	    </span><span class="k">for</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span><span class="w"> </span><span class="n">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">	    	</span><span class="c1">// Set the row address</span>
<span class="linenos">28</span><span class="w">			</span><span class="c1">// Here we take advantage of the select bits (LA,LB,LC,LD)</span>
<span class="linenos">29</span><span class="w">			</span><span class="c1">// being sequential in the R30 register (bits 2,3,4,5)</span>
<span class="linenos">30</span><span class="w">			</span><span class="c1">// We shift row over so it lines up with the select bits</span>
<span class="linenos">31</span><span class="w">			</span><span class="c1">// Oring (|=) with R30 sets bits to 1 and</span>
<span class="linenos">32</span><span class="w">			</span><span class="c1">// Anding (&amp;=) clears bits to 0, the 0xffc mask makes sure the</span>
<span class="linenos">33</span><span class="w">			</span><span class="c1">// other bits aren&#39;t changed.</span>
<span class="linenos">34</span><span class="w">	        </span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w">  </span><span class="n">row</span><span class="o">&lt;&lt;</span><span class="n">pru_sel0</span><span class="p">;</span>
<span class="linenos">35</span><span class="w">	        </span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="p">(</span><span class="n">row</span><span class="o">&lt;&lt;</span><span class="n">pru_sel0</span><span class="p">)</span><span class="o">|</span><span class="mh">0xffc3</span><span class="p">;</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="w">    	    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">38</span><span class="w">    	    	</span><span class="c1">// Top row white</span>
<span class="linenos">39</span><span class="w">    	    	</span><span class="c1">// Combining these to one write works because they are all in </span>
<span class="linenos">40</span><span class="w">    	    	</span><span class="c1">// the same gpio port</span>
<span class="linenos">41</span><span class="w">    	      	</span><span class="n">gpio</span><span class="p">[</span><span class="n">r11_gpio</span><span class="p">][</span><span class="n">GPIO_SETDATAOUT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r11_pin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">g11_pin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b11_pin</span><span class="p">;</span>
<span class="linenos">42</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);;</span>
<span class="linenos">43</span><span class="w">    	      	</span>
<span class="linenos">44</span><span class="w">    	      	</span><span class="c1">// Bottom row red</span>
<span class="linenos">45</span><span class="w">    	      	</span><span class="n">gpio</span><span class="p">[</span><span class="n">r12_gpio</span><span class="p">][</span><span class="n">GPIO_SETDATAOUT</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">r12_pin</span><span class="p">;</span>
<span class="linenos">46</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">47</span><span class="w">    	      	</span><span class="n">gpio</span><span class="p">[</span><span class="n">r12_gpio</span><span class="p">][</span><span class="n">GPIO_CLEARDATAOUT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g12_pin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b12_pin</span><span class="p">;</span>
<span class="linenos">48</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">49</span><span class="w">    	      	</span>
<span class="linenos">50</span><span class="w">                </span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w">  </span><span class="n">pru_clock</span><span class="p">;</span><span class="w">	</span><span class="c1">// Toggle clock</span>
<span class="linenos">51</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">52</span><span class="w">        		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">pru_clock</span><span class="p">;</span>
<span class="linenos">53</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">54</span><span class="w">    	    	</span>
<span class="linenos">55</span><span class="w">    	    	</span><span class="c1">// Top row black</span>
<span class="linenos">56</span><span class="w">    	    	</span><span class="n">gpio</span><span class="p">[</span><span class="n">r11_gpio</span><span class="p">][</span><span class="n">GPIO_CLEARDATAOUT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r11_pin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">g11_pin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b11_pin</span><span class="p">;</span>
<span class="linenos">57</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">58</span><span class="w">    	      	</span>
<span class="linenos">59</span><span class="w">    	      	</span><span class="c1">// Bottom row green</span>
<span class="linenos">60</span><span class="w">    	    	</span><span class="n">gpio</span><span class="p">[</span><span class="n">r12_gpio</span><span class="p">][</span><span class="n">GPIO_CLEARDATAOUT</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r12_pin</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b12_pin</span><span class="p">;</span>
<span class="linenos">61</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">62</span><span class="w">    	      	</span><span class="n">gpio</span><span class="p">[</span><span class="n">r12_gpio</span><span class="p">][</span><span class="n">GPIO_SETDATAOUT</span><span class="p">]</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">g12_pin</span><span class="p">;</span>
<span class="linenos">63</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">64</span><span class="w">    	      	</span>
<span class="linenos">65</span><span class="w">                </span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w">  </span><span class="n">pru_clock</span><span class="p">;</span><span class="w">	</span><span class="c1">// Toggle clock</span>
<span class="linenos">66</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">67</span><span class="w">        		</span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">pru_clock</span><span class="p">;</span>
<span class="linenos">68</span><span class="w">    	    	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">69</span><span class="w">    	    </span><span class="p">}</span>
<span class="linenos">70</span><span class="w">    	    </span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w">  </span><span class="n">pru_oe</span><span class="p">;</span><span class="w">        </span><span class="c1">// Disable display</span>
<span class="linenos">71</span><span class="w">    	   	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">72</span><span class="w">    	    </span><span class="n">__R30</span><span class="w"> </span><span class="o">|=</span><span class="w">  </span><span class="n">pru_latch</span><span class="p">;</span><span class="w">     </span><span class="c1">// Toggle latch</span>
<span class="linenos">73</span><span class="w">    	   	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">74</span><span class="w">    	    </span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">pru_latch</span><span class="p">;</span>
<span class="linenos">75</span><span class="w">    	   	</span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">76</span><span class="w">    	    </span><span class="n">__R30</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">pru_oe</span><span class="p">;</span><span class="w">        </span><span class="c1">// Enable display</span>
<span class="linenos">77</span><span class="w">    	    </span><span class="n">__delay_cycles</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
<span class="linenos">78</span><span class="w">	    </span><span class="p">}</span>
<span class="linenos">79</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">80</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/74224364443a282244adfe6c6b4eb6a7/rgb1.pru0.c"><code class="xref download docutils literal notranslate"><span class="pre">rgb1.pru0.c</span></code></a></p>
<p>The results are shown in <a class="reference internal" href="#blocks-rgb-pru"><span class="std std-ref">Display running rgb1.c on PRU 0</span></a>.</p>
<figure class="align-center" id="id119">
<span id="blocks-rgb-pru"></span><img alt="Display running rgb1.pru0.c on PRU 0" src="../../../_images/rgb_pru.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 818 </span><span class="caption-text">Display running rgb1.c on PRU 0</span><a class="headerlink" href="#id119" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The PRU is fast enough to quickly write to the display so that it appears
as if all the LEDs are on at once.</p>
</section>
<section id="id51">
<h3>Discussion<a class="headerlink" href="#id51" title="Link to this heading">#</a></h3>
<p>There are a lot of details needed to make this simple display work.
Let’s go over some of them.</p>
<p>First, the connector looks like <a class="reference internal" href="#blocks-matrix-j1"><span class="std std-ref">RGB Matrix J1 connector</span></a>.</p>
<figure class="align-center" id="id120">
<span id="blocks-matrix-j1"></span><img alt="RGB Matrix J1 connector, 200" src="../../../_images/matrix_j1.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 819 </span><span class="caption-text">RGB Matrix J1 connector</span><a class="headerlink" href="#id120" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Notice the labels on the connect match the labels in the code.
<a class="reference internal" href="#blocks-pocket-scroller-pins"><span class="std std-ref">PocketScroller pin table</span></a> shows how the pins on the display are
mapped to the pins on the PocketBeagle.</p>
<div class="admonition-todo admonition" id="id52">
<p class="admonition-title">Todo</p>
<p>Make a mapping table for the Black</p>
<p><a class="github reference external" href="https://github.com/FalconChristmas/fpp/blob/master/src/pru/OctoscrollerV2.hp">FalconChristmas/fpp</a></p>
</div>
<div class="pst-scrollable-table-container"><span id="blocks-pocket-scroller-pins"></span><table class="table" id="id121">
<caption><span class="caption-number">Table 167 </span><span class="caption-text">PocketScroller pin table</span><a class="headerlink" href="#id121" title="Link to this table">#</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>J1 Connector Pin</p></th>
<th class="head"><p>Pocket Headers</p></th>
<th class="head"><p>gpio port and bit number</p></th>
<th class="head"><p>Linux gpio number</p></th>
<th class="head"><p>PRU R30 bit number</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>R1</p></td>
<td><p>P2_10</p></td>
<td><p>1-20</p></td>
<td><p>52</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>B1</p></td>
<td><p>P2_06</p></td>
<td><p>1-25</p></td>
<td><p>57</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>R2</p></td>
<td><p>P2_04</p></td>
<td><p>1-26</p></td>
<td><p>58</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>B2</p></td>
<td><p>P2_01</p></td>
<td><p>1-18</p></td>
<td><p>50</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>LA</p></td>
<td><p>P2_32</p></td>
<td><p>3-16</p></td>
<td><p>112</p></td>
<td><p>PRU0.2</p></td>
</tr>
<tr class="row-odd"><td><p>LC</p></td>
<td><p>P1_31</p></td>
<td><p>3-18</p></td>
<td><p>114</p></td>
<td><p>PRU0.4</p></td>
</tr>
<tr class="row-even"><td><p>CLK</p></td>
<td><p>P1_33</p></td>
<td><p>3-15</p></td>
<td><p>111</p></td>
<td><p>PRU0.1</p></td>
</tr>
<tr class="row-odd"><td><p>OE</p></td>
<td><p>P1_29</p></td>
<td><p>3-21</p></td>
<td><p>117</p></td>
<td><p>PRU0.7</p></td>
</tr>
<tr class="row-even"><td><p>G1</p></td>
<td><p>P2_08</p></td>
<td><p>1-28</p></td>
<td><p>60</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>G2</p></td>
<td><p>P2_02</p></td>
<td><p>1-27</p></td>
<td><p>59</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>LB</p></td>
<td><p>P2_30</p></td>
<td><p>3-17</p></td>
<td><p>113</p></td>
<td><p>PRU0.3</p></td>
</tr>
<tr class="row-odd"><td><p>LD</p></td>
<td><p>P2_34</p></td>
<td><p>3-19</p></td>
<td><p>115</p></td>
<td><p>PRU0.5</p></td>
</tr>
<tr class="row-even"><td><p>LAT</p></td>
<td><p>P1_36</p></td>
<td><p>3-14</p></td>
<td><p>110</p></td>
<td><p>PRU0.0</p></td>
</tr>
</tbody>
</table>
</div>
<p>The J1 mapping to gpio port and bit number comes from
<a class="github reference external" href="https://github.com/FalconChristmas/fpp/blob/master/capes/pb/panels/PocketScroller.json">FalconChristmas/fpp</a>.
The gpio port and bit number mapping to Pocket Headers comes from
<a class="reference external" href="https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit#gid=0">https://docs.google.com/spreadsheets/d/1FRGvYOyW1RiNSEVprvstfJAVeapnASgDXHtxeDOjgqw/edit#gid=0</a>.</p>
<p><a class="reference internal" href="#blocks-rgb-waveforms"><span class="std std-ref">Oscilloscope display of CLK, OE, LAT and R1</span></a> shows four of the signal waveforms driving the RGB LED matrix.</p>
<figure class="align-center" id="id122">
<span id="blocks-rgb-waveforms"></span><img alt="Oscilloscope display of CLK, OE, LAT and R1" src="../../../_images/rgb_waveforms.png" />
<figcaption>
<p><span class="caption-number">Fig. 820 </span><span class="caption-text">Oscilloscope display of CLK, OE, LAT and R1</span><a class="headerlink" href="#id122" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The top waveform is the CLK, the next is OE, followed by LAT and finally R1.
The OE (output enable) is active low, so most of the time the display is visible.
The sequence is:</p>
<ul class="simple">
<li><p>Put data on the R1, G1, B1, R2, G2 and B2 lines</p></li>
<li><p>Toggle the clock.</p></li>
<li><p>Repeat the first two steps as one row of data is transferred.  There are 384 LEDs (2 rows of 32 RGB LEDs times 3 LED per RGB), but we are clocking in six bits (R1, G1, etc.) at a time, so 384/6=64 values need to be clocked in.</p></li>
<li><p>Once all the values are in, disable the display (OE goes high)</p></li>
<li><p>Then toggle the latch (LAT) to latch the new data.</p></li>
<li><p>Turn the display back on.</p></li>
<li><p>Increment the address lines (LA, LB, LC and LD) to point to the next rows.</p></li>
<li><p>Keep repeating the above to keep the display lit.</p></li>
</ul>
<p>Using the PRU we are able to run the clock a about 2.9 MKHz.
<a class="reference internal" href="#blocks-rgb-fpp"><span class="std std-ref">FPP waveforms</span></a> shows the optimized assembler code used by FPP clocks in
at some 6.3 MHz.  So the compiler is doing a pretty good job, but you can run
some two times faster if you want to use assembly code.  In fairness to FPP,
it’s having to pull it’s data out of RAM to display it, so isn’t not a good
comparison.</p>
<figure class="align-center" id="id123">
<span id="blocks-rgb-fpp"></span><img alt="FPP waveforms" src="../../../_images/rgb_fpp.png" />
<figcaption>
<p><span class="caption-number">Fig. 821 </span><span class="caption-text">FPP waveforms</span><a class="headerlink" href="#id123" title="Link to this image">#</a></p>
</figcaption>
</figure>
<section id="getting-more-colors">
<h4>Getting More Colors<a class="headerlink" href="#getting-more-colors" title="Link to this heading">#</a></h4>
<p>The Adafruit description goes on to say:</p>
<div class="admonition-information admonition">
<p class="admonition-title">information</p>
<p>The only downside of this technique is that despite being very simple and fast,
it has no PWM control built-in! The controller can only set the LEDs on or off.
So what do you do when you want full color? You actually need to draw the entire
matrix over and over again at very high speeds to PWM the matrix manually. For
that reason, you need to have a very fast controller (50 MHz is a minimum) if
you want to do a lot of colors and motion video and have it look good.</p>
<p><a class="reference external" href="https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf">https://cdn-learn.adafruit.com/downloads/pdf/32x16-32x32-rgb-led-matrix.pdf</a></p>
</div>
<p>This is what FPP does, but it’s beyond the scope of this project.</p>
</section>
</section>
</section>
<section id="compiling-and-inserting-rpmsg-pru">
<h2>Compiling and Inserting rpmsg_pru<a class="headerlink" href="#compiling-and-inserting-rpmsg-pru" title="Link to this heading">#</a></h2>
<section id="id53">
<h3>Problem<a class="headerlink" href="#id53" title="Link to this heading">#</a></h3>
<p>Your Beagle doesn’t have rpmsg_pru.</p>
</section>
<section id="id54">
<h3>Solution<a class="headerlink" href="#id54" title="Link to this heading">#</a></h3>
<p>Do the following.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bone$<span class="w"> </span>*cd<span class="w"> </span>code/05blocks/module*
bone$<span class="w"> </span>*sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>linux-headers-<span class="se">\`</span>uname<span class="w"> </span>-r<span class="sb">`</span>*
bone$<span class="w"> </span>*wget<span class="w"> </span>https://github.com/beagleboard/linux/raw/4.9/drivers/rpmsg/rpmsg_pru.c*
bone$<span class="w"> </span>*make*
make<span class="w"> </span>-C<span class="w"> </span>/lib/modules/4.9.88-ti-r111/build<span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span>
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Entering<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/usr/src/linux-headers-4.9.88-ti-r111&#39;</span>
<span class="w">  </span>LD<span class="w">      </span>/home/debian/PRUCookbook/docs/code/05blocks/module/built-in.o
<span class="w">  </span>CC<span class="w"> </span><span class="o">[</span>M<span class="o">]</span><span class="w">  </span>/home/debian/PRUCookbook/docs/code/05blocks/module/rpmsg_client_sample.o
<span class="w">  </span>CC<span class="w"> </span><span class="o">[</span>M<span class="o">]</span><span class="w">  </span>/home/debian/PRUCookbook/docs/code/05blocks/module/rpmsg_pru.o
<span class="w">  </span>Building<span class="w"> </span>modules,<span class="w"> </span>stage<span class="w"> </span><span class="m">2</span>.
<span class="w">  </span>MODPOST<span class="w"> </span><span class="m">2</span><span class="w"> </span>modules
<span class="w">  </span>CC<span class="w">      </span>/home/debian/PRUCookbook/docs/code/05blocks/module/rpmsg_client_sample.mod.o
<span class="w">  </span>LD<span class="w"> </span><span class="o">[</span>M<span class="o">]</span><span class="w">  </span>/home/debian/PRUCookbook/docs/code/05blocks/module/rpmsg_client_sample.ko
<span class="w">  </span>CC<span class="w">      </span>/home/debian/PRUCookbook/docs/code/05blocks/module/rpmsg_pru.mod.o
<span class="w">  </span>LD<span class="w"> </span><span class="o">[</span>M<span class="o">]</span><span class="w">  </span>/home/debian/PRUCookbook/docs/code/05blocks/module/rpmsg_pru.ko
make<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span>Leaving<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/usr/src/linux-headers-4.9.88-ti-r111&#39;</span>
bone$<span class="w"> </span>*sudo<span class="w"> </span>insmod<span class="w"> </span>rpmsg_pru.ko*
bone$<span class="w"> </span>*lsmod<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>rpm*
rpmsg_pru<span class="w">               </span><span class="m">5799</span><span class="w">  </span><span class="m">2</span>
virtio_rpmsg_bus<span class="w">       </span><span class="m">13620</span><span class="w">  </span><span class="m">0</span>
rpmsg_core<span class="w">              </span><span class="m">8537</span><span class="w">  </span><span class="m">2</span><span class="w"> </span>rpmsg_pru,virtio_rpmsg_bus
</pre></div>
</div>
<p>It’s now installed and ready to go.</p>
</section>
</section>
<section id="copyright">
<h2>Copyright<a class="headerlink" href="#copyright" title="Link to this heading">#</a></h2>
<div class="literal-block-wrapper docutils container" id="id124">
<div class="code-block-caption"><span class="caption-number">Listing 129 </span><span class="caption-text">copyright.c</span><a class="headerlink" href="#id124" title="Link to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * Copyright (C) 2015 Texas Instruments Incorporated - http://www.ti.com/</span>
<span class="linenos"> 3</span><span class="cm"> *</span>
<span class="linenos"> 4</span><span class="cm"> *</span>
<span class="linenos"> 5</span><span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="linenos"> 6</span><span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="linenos"> 7</span><span class="cm"> * are met:</span>
<span class="linenos"> 8</span><span class="cm"> *</span>
<span class="linenos"> 9</span><span class="cm"> *	* Redistributions of source code must retain the above copyright</span>
<span class="linenos">10</span><span class="cm"> *	  notice, this list of conditions and the following disclaimer.</span>
<span class="linenos">11</span><span class="cm"> *</span>
<span class="linenos">12</span><span class="cm"> *	* Redistributions in binary form must reproduce the above copyright</span>
<span class="linenos">13</span><span class="cm"> *	  notice, this list of conditions and the following disclaimer in the</span>
<span class="linenos">14</span><span class="cm"> *	  documentation and/or other materials provided with the</span>
<span class="linenos">15</span><span class="cm"> *	  distribution.</span>
<span class="linenos">16</span><span class="cm"> *</span>
<span class="linenos">17</span><span class="cm"> *	* Neither the name of Texas Instruments Incorporated nor the names of</span>
<span class="linenos">18</span><span class="cm"> *	  its contributors may be used to endorse or promote products derived</span>
<span class="linenos">19</span><span class="cm"> *	  from this software without specific prior written permission.</span>
<span class="linenos">20</span><span class="cm"> *</span>
<span class="linenos">21</span><span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="linenos">22</span><span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="linenos">23</span><span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="linenos">24</span><span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="linenos">25</span><span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="linenos">26</span><span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="linenos">27</span><span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="linenos">28</span><span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="linenos">29</span><span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="linenos">30</span><span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="linenos">31</span><span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="linenos">32</span><span class="cm"> */</span>
</pre></div>
</div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/275e9564f11d58959e0e505c8f28bad0/copyright.c"><code class="xref download docutils literal notranslate"><span class="pre">copyright.c</span></code></a></p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../04debug/debug.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Debugging and Benchmarking</p>
      </div>
    </a>
    <a class="right-next"
       href="../06io/io.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Accessing More I/O</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item"><a role="button" data-bs-toggle="modal" data-bs-target="#todoModal" href="#" id="modalfortodoitems">
    <button type="button" class="btn btn-danger">Outstanding todo items</button>
</a>

<div class="modal fade" id="todoModal" aria-labelledby="todoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title m-0 text-dark" id="todoModalLabel">Outstanding todo items</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div> 
        <div class="modal-body">
            <ul class="list-group list-group-flush" id="todolist">
                <!-- Auto generated for page -->
            </ul>
        </div>
        </div>
    </div>
</div>

<script>

    document.body.appendChild(document.getElementById('todoModal'));
    var modalfortodoitems = document.getElementById('modalfortodoitems');
    var modalfortodoitemsparent = modalfortodoitems.parentNode;
    var todoItems = document.getElementsByClassName('admonition-todo');
    var todolist = document.getElementById('todolist')

    if(todoItems.length == 0 || !todoItems[0].hasAttribute('id')) {
        modalfortodoitemsparent.remove();
    } else  {
        for (var i = 0; i < todoItems.length; ++i) {
            var todoItem = document.createElement('li');
            var link = document.createElement('a');
            link.textContent = todoItems[i].getElementsByTagName('p')[1].innerHTML;
            link.href = '#' + todoItems[i].id;
            link.addEventListener('click', function() {
                // Use Bootstrap's modal method to hide the modal
                const todoModal = document.getElementById('todoModal');
                const modal = bootstrap.Modal.getInstance(todoModal);
                modal.hide();
            });
            todoItem.appendChild(link);
            todoItem.classList.add('list-group-item');
            todolist.appendChild(todoItem);
        }
    }
    
</script></div>

  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#memory-allocation">Memory Allocation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problem">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discussion">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#auto-initialization-of-built-in-led-triggers">Auto Initialization of built-in LED Triggers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pwm-generator">PWM Generator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-the-pwm-frequency">Controlling the PWM Frequency</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Solution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-unrolling-for-better-performance">Loop Unrolling for Better Performance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-all-the-pulses-start-at-the-same-time">Making All the Pulses Start at the Same Time</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-more-channels-via-pru-1">Adding More Channels via PRU 1</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synchronizing-two-prus">Synchronizing Two PRUs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading-an-input-at-regular-intervals">Reading an Input at Regular Intervals</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analog-wave-generator">Analog Wave Generator</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ws2812-neopixel-driver">WS2812 (NeoPixel) driver</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-neopixels-to-different-colors">Setting NeoPixels to Different Colors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-arbitrary-leds">Controlling Arbitrary LEDs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#neo3-video">Neo3 Video</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id43">Discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controlling-neopixels-through-a-kernel-driver">Controlling NeoPixels Through a Kernel Driver</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id44">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id45">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id47">Discussion</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#switching-from-pru0-to-pru1-with-rpmsg-pru">Switching from pru0 to pru1 with rpmsg_pru</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rgb-led-matrix-no-integrated-drivers">RGB LED Matrix - No Integrated Drivers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id48">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id49">Solution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id51">Discussion</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-more-colors">Getting More Colors</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compiling-and-inserting-rpmsg-pru">Compiling and Inserting rpmsg_pru</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id53">Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id54">Solution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copyright">Copyright</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://openbeagle.org/docs/docs.beagleboard.io/-/edit/main/books/pru-cookbook/05blocks/blocks.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on OpenBeagle
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../../_sources/books/pru-cookbook/05blocks/blocks.rst">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item"><a role="button" data-bs-toggle="modal" data-bs-target="#feedbackModal" href="#" onclick="getFeedbackButtonhref(this)">
    <i class="fa-regular fa-message"></i> Provide Feedback
</a>

<div class="modal fade" id="feedbackModal" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title m-0 text-dark" id="feedbackModalLabel">Feedback</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="btn-group mb-3" role="group" aria-label="Basic radio toggle button group" id="feedbackType"
                    onChange="feedbackHandler()">
                    <input type="radio" class="btn-check" name="feedbackType" id="btnradio1" autocomplete="off"
                        value="Issue">
                    <label class="btn btn-outline-dark shadow-none" for="btnradio1"><i
                            class="fa-solid fa-triangle-exclamation"></i> Issue</label>

                    <input type="radio" class="btn-check" name="feedbackType" id="btnradio2" autocomplete="off"
                        value="Feedback" checked>
                    <label class="btn btn-outline-dark shadow-none" for="btnradio2"><i
                            class="fa-regular fa-message"></i> Feedback</label>

                    <input type="radio" class="btn-check" name="feedbackType" id="btnradio3" autocomplete="off"
                        value="Idea">
                    <label class="btn btn-outline-dark shadow-none" for="btnradio3"><i
                            class="fa-solid fa-lightbulb"></i> Idea</label>
                </div>
                <div class="mb-3">
                    <input type="title" class="form-control bg-light text-dark" id="feedbackModalTitle"
                        placeholder="Title" onChange="feedbackHandler()">
                </div>
                <div class="mb-3">
                    <textarea class="form-control bg-light text-dark" id="feedbackModalDescription" minlength="13"
                        rows="3" placeholder="Description" onChange="feedbackHandler()"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="feedbackClear()">Clear
                    & Close</button>
                <span id="generateLinkButtonTooltip" data-bs-placement="bottom" data-bs-toggle="tooltip">
                    <a href="javascript:void(0);" id="feedbacklink" type="button"
                        class="btn btn-primary disabled text-light">
                        <i class="fa-solid fa-up-right-from-square"></i> Generate OpenBeagle Issue
                    </a>
                </span>
            </div>
        </div>
    </div>
</div>

<script>

    var titleMinLength = 4
    var descriptionMinLength = 12

    document.body.appendChild(document.getElementById('feedbackModal'));

    var generateLinkButtonTooltip = document.getElementById("generateLinkButtonTooltip")
    var link = document.getElementById("feedbacklink")
    var gitlab_project = ""
    var title = document.getElementById("feedbackModalTitle")
    var description = document.getElementById("feedbackModalDescription")
    var generatedFromLink = ""


    title.placeholder = "Title (minimum " + titleMinLength + " characters)"
    description.placeholder = "Description (minimum " + descriptionMinLength + " characters)"

    function feedbackHandler() {
        var type = document.querySelector('input[name="feedbackType"]:checked').value

        if (!gitlab_project.match(/^[a-zA-Z]+:\/\//)) {
            gitlab_project = 'https://' + gitlab_project;
        }

        if (title.value.length >= titleMinLength && description.value.length >= descriptionMinLength) {
            link.target = "_blank"
            link.classList.remove("disabled");
            generateLinkButtonTooltip.title = "You must be logged in to OpenBeagle.org to generate an Issue!"
            link.href = gitlab_project + "/-/issues/new?issue[title]=" + type + ": " + title.value + "&issue[description]=" + description.value + "%0A%0AGenerated from: " + generatedFromLink.replace('#', '%23')
        } else {
            link.classList.add("disabled");
            generateLinkButtonTooltip.title = "Add proper title and description to activate the link!"
        }
    }

    function feedbackClear() {
        title.value = ""
        description.value = ""
        link.href = ""
        link.classList.add("disabled");
    }

    document.addEventListener('DOMContentLoaded', function () {
        const headerlinks = document.getElementsByClassName("headerlink");

        for (let i = 0; i < headerlinks.length; i++) {
            if (headerlinks[i].classList.contains('headerlink-feedback')) {
                continue;
            }

            headerlinks[i].innerHTML = `<i class="fa-solid fa-link"></i>`;
            headerlinks[i].addEventListener('click', function (event) {
                event.preventDefault();
                const link = this.href;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(link).then(() => {
                        console.log("Link copied to clipboard:", link);
                        this.innerHTML = `<i class="fa-regular fa-square-check"></i>`;
                        setTimeout(() => {
                            this.innerHTML = `<i class="fa-solid fa-link"></i>`;
                        }, 1000);
                    }).catch(err => {
                        console.error("Failed to copy:", err);
                    });
                } else {
                    fallbackCopyText(link, this);
                }
            });

            const feedbackLink = headerlinks[i].cloneNode(true);

            feedbackLink.classList.add('headerlink-feedback');
            feedbackLink.innerHTML = '<i class="fa-regular fa-message"></i>';
            feedbackLink.title = "Provide Feedback";
            feedbackLink.setAttribute("data-bs-toggle", "modal");
            feedbackLink.setAttribute("data-bs-target", "#feedbackModal");
            feedbackLink.setAttribute("onclick", "getFeedbackButtonhref(this)");

            if (headerlinks[i].parentNode) {
                headerlinks[i].parentNode.insertBefore(feedbackLink, headerlinks[i].nextSibling || null);
            }
        }
    });

    function fallbackCopyText(text, element) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand("copy");
            element.innerHTML = `<i class="fa-regular fa-square-check"></i>`;
            setTimeout(() => {
                element.innerHTML = `<i class="fa-solid fa-link"></i>`;
            }, 1000);
        } catch (err) {
            console.error("Fallback: Failed to copy:", err);
        }
        document.body.removeChild(textarea);
    }

    function getFeedbackButtonhref(clickedFeedbackLink) {
        generatedFromLink = clickedFeedbackLink.href
        feedbackHandler()
    }

</script></div>

  <div class="sidebar-secondary-item"><a role="button" href="https://forum.beagleboard.org" target="_blank">
    <i class="fa-brands fa-discourse"></i> Discuss on Forum
</a></div>

  <div class="sidebar-secondary-item"><div class="card bg-light mt-4 text-center">
    <div class="card-body">
        <p class="card-text text-dark">
        <a href="https://www.beagleboard.org/" target="_blank">BeagleBoard.org</a> 
        is all about being open, please discuss in public on our 
        <a href="https://forum.beagleboard.org" target="_blank">forum</a>!</p>
    </div>
</div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        


      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, BeagleBoard.org Foundation.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__center">
      
        <div class="footer-item"><a href="https://creativecommons.org/licenses/by-sa/4.0/" style="text-decoration:none">
    <img src="https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by-sa.svg"/>
</a></div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="last-updated">
  Last updated on Jun 29, 2025.
  <br/>
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>